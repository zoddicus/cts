{"version":3,"file":"vertex_state.spec.js","names":["description","makeTestGroup","range","CompatibilityTest","g","test","desc","params","u","combine","fn","t","useVertexIndex","useInstanceIndex","numAttribsToReserve","isAsync","numAttribs","device","limits","maxVertexAttributes","numBuiltinsUsed","isValid","inputs","i","outputs","push","module","createShaderModule","code","join","pipelineDescriptor","layout","vertex","entryPoint","buffers","arrayStride","attributes","shaderLocation","format","offset","fragment","targets","doCreateRenderPipelineTest"],"sources":["../../../../../../src/webgpu/compat/api/validation/render_pipeline/vertex_state.spec.ts"],"sourcesContent":["export const description = `\nTests limitations of createRenderPipeline related to vertex state in compat mode.\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { range } from '../../../../../common/util/util.js';\nimport { CompatibilityTest } from '../../../compatibility_test.js';\n\nexport const g = makeTestGroup(CompatibilityTest);\n\ng.test('maxVertexAttributesVertexIndexInstanceIndex')\n  .desc(\n    `\nTests @builtin(vertex_index) and @builtin(instance_index) each count as an attribute.\n\n- Test that you can use maxVertexAttributes\n- Test that you can not use maxVertexAttributes and @builtin(vertex_index)\n- Test that you can not use maxVertexAttributes and @builtin(instance_index)\n- Test that you can use maxVertexAttributes - 1 and @builtin(vertex_index)\n- Test that you can use maxVertexAttributes - 1 and @builtin(instance_index)\n- Test that you can not use maxVertexAttributes - 1 and both @builtin(vertex_index) and @builtin(instance_index)\n- Test that you can use maxVertexAttributes - 2 and both @builtin(vertex_index) and @builtin(instance_index)\n    `\n  )\n  .params(u =>\n    u\n      .combine('useVertexIndex', [false, true] as const)\n      .combine('useInstanceIndex', [false, true] as const)\n      .combine('numAttribsToReserve', [0, 1, 2] as const)\n      .combine('isAsync', [false, true] as const)\n  )\n  .fn(t => {\n    const { useVertexIndex, useInstanceIndex, numAttribsToReserve, isAsync } = t.params;\n    const numAttribs = t.device.limits.maxVertexAttributes - numAttribsToReserve;\n\n    const numBuiltinsUsed = (useVertexIndex ? 1 : 0) + (useInstanceIndex ? 1 : 0);\n    const isValid = numAttribs + numBuiltinsUsed <= t.device.limits.maxVertexAttributes;\n\n    const inputs = range(numAttribs, i => `@location(${i}) v${i}: vec4f`);\n    const outputs = range(numAttribs, i => `v${i}`);\n\n    if (useVertexIndex) {\n      inputs.push('@builtin(vertex_index) vNdx: u32');\n      outputs.push('vec4f(f32(vNdx))');\n    }\n\n    if (useInstanceIndex) {\n      inputs.push('@builtin(instance_index) iNdx: u32');\n      outputs.push('vec4f(f32(iNdx))');\n    }\n\n    const module = t.device.createShaderModule({\n      code: `\n        @fragment fn fs() -> @location(0) vec4f {\n            return vec4f(1);\n        }\n        @vertex fn vs(${inputs.join(', ')}) -> @builtin(position) vec4f {\n            return ${outputs.join(' + ')};\n        }\n      `,\n    });\n\n    const pipelineDescriptor: GPURenderPipelineDescriptor = {\n      layout: 'auto',\n      vertex: {\n        module,\n        entryPoint: 'vs',\n        buffers: [\n          {\n            arrayStride: 16,\n            attributes: range(numAttribs, i => ({\n              shaderLocation: i,\n              format: 'float32x4',\n              offset: 0,\n            })),\n          },\n        ],\n      },\n      fragment: {\n        module,\n        entryPoint: 'fs',\n        targets: [\n          {\n            format: 'rgba8unorm',\n          },\n        ],\n      },\n    };\n\n    t.doCreateRenderPipelineTest(isAsync, isValid, pipelineDescriptor);\n  });\n"],"mappings":"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"}