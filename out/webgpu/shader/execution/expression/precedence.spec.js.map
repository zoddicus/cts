{"version":3,"file":"precedence.spec.js","names":["description","makeTestGroup","keysOf","GPUTest","g","kExpressions","add_mul","expr","result","mul_add","sub_neg","neg_shl","neg_shr","neg_add","neg_mul","neg_and","neg_or","neg_xor","comp_add","mul_deref","not_and","not_or","eq_and","and_eq","eq_or","or_eq","add_swizzle","test","desc","params","u","combine","fn","t","decl","expr_wgsl","replace","strip_spaces","wgsl","pipeline","device","createComputePipeline","layout","compute","module","createShaderModule","code","outputBuffer","makeBufferWithContents","Uint32Array","GPUBufferUsage","STORAGE","COPY_SRC","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","buffer","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","expectGPUBufferValuesEqual","Int32Array"],"sources":["../../../../../src/webgpu/shader/execution/expression/precedence.spec.ts"],"sourcesContent":["export const description = `\nExecution tests for operator precedence.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nexport const g = makeTestGroup(GPUTest);\n\n// The list of test cases and their expected results.\ninterface Expression {\n  expr: string;\n  result: number;\n}\nconst kExpressions: Record<string, Expression> = {\n  add_mul: { expr: 'kThree + kSeven * kEleven', result: 80 },\n  mul_add: { expr: 'kThree * kSeven + kEleven', result: 32 },\n  sub_neg: { expr: 'kThree - - kSeven', result: 10 },\n  neg_shl: { expr: '- kThree << u32(kSeven)', result: -384 },\n  neg_shr: { expr: '- kThree >> u32(kSeven)', result: -1 },\n  neg_add: { expr: '- kThree + kSeven', result: 4 },\n  neg_mul: { expr: '- kThree * kSeven', result: -21 },\n  neg_and: { expr: '- kThree & kSeven', result: 5 },\n  neg_or: { expr: '- kThree | kSeven', result: -1 },\n  neg_xor: { expr: '- kThree ^ kSeven', result: -6 },\n  comp_add: { expr: '~ kThree + kSeven', result: 3 },\n  mul_deref: { expr: 'kThree * * ptr_five', result: 15 },\n  not_and: { expr: 'i32(! kFalse && kFalse)', result: 0 },\n  not_or: { expr: 'i32(! kTrue || kTrue)', result: 1 },\n  eq_and: { expr: 'i32(kFalse == kTrue && kFalse)', result: 0 },\n  and_eq: { expr: 'i32(kFalse && kTrue == kFalse)', result: 0 },\n  eq_or: { expr: 'i32(kFalse == kFalse || kTrue)', result: 1 },\n  or_eq: { expr: 'i32(kTrue || kFalse == kFalse)', result: 1 },\n  add_swizzle: { expr: '(vec + vec . y) . z', result: 8 },\n};\n\ng.test('precedence')\n  .desc(\n    `\n    Test that operator precedence rules are correctly implemented.\n    `\n  )\n  .params(u =>\n    u\n      .combine('expr', keysOf(kExpressions))\n      .combine('decl', ['literal', 'const', 'override', 'var<private>'])\n      .combine('strip_spaces', [false, true])\n  )\n  .fn(t => {\n    const expr = kExpressions[t.params.expr];\n\n    let decl = t.params.decl;\n    let expr_wgsl = expr.expr;\n    if (t.params.decl === 'literal') {\n      decl = 'const';\n      expr_wgsl = expr_wgsl.replace(/kThree/g, '3');\n      expr_wgsl = expr_wgsl.replace(/kSeven/g, '7');\n      expr_wgsl = expr_wgsl.replace(/kEleven/g, '11');\n      expr_wgsl = expr_wgsl.replace(/kFalse/g, 'false');\n      expr_wgsl = expr_wgsl.replace(/kTrue/g, 'true');\n    }\n    if (t.params.strip_spaces) {\n      expr_wgsl = expr_wgsl.replace(/ /g, '');\n    }\n    const wgsl = `\n      @group(0) @binding(0) var<storage, read_write> buffer : i32;\n\n      ${decl} kFalse = false;\n      ${decl} kTrue = true;\n\n      ${decl} kThree = 3;\n      ${decl} kSeven = 7;\n      ${decl} kEleven = 11;\n\n      @compute @workgroup_size(1)\n      fn main() {\n        var five = 5;\n        var vec = vec4(1, kThree, 5, kSeven);\n        let ptr_five = &five;\n\n        buffer = ${expr_wgsl};\n      }\n    `;\n    const pipeline = t.device.createComputePipeline({\n      layout: 'auto',\n      compute: {\n        module: t.device.createShaderModule({ code: wgsl }),\n      },\n    });\n\n    // Allocate a buffer and fill it with 0xdeadbeef.\n    const outputBuffer = t.makeBufferWithContents(\n      new Uint32Array([0xdeadbeef]),\n      GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC\n    );\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [{ binding: 0, resource: { buffer: outputBuffer } }],\n    });\n\n    // Run the shader.\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginComputePass();\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bindGroup);\n    pass.dispatchWorkgroups(1);\n    pass.end();\n    t.queue.submit([encoder.finish()]);\n\n    // Check that the result is as expected.\n    t.expectGPUBufferValuesEqual(outputBuffer, new Int32Array([expr.result]));\n  });\n"],"mappings":"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"}