{"version":3,"file":"subgroupAdd.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","iterRange","GPUTest","kConcreteNumericScalarsAndVectors","Type","VectorType","numberToFloatBits","floatBitsToNumber","kFloat32Format","kFloat16Format","scalarTypeOf","FP","kNumCases","kStride","kWGSizes","kPredicateCases","runAccuracyTest","runComputeTest","g","kIdentity","kDataTypes","kOperations","test","desc","params","u","combine","x","beforeAllSubcases","t","features","type","push","selectDeviceOrSkipTestCase","fn","case","wgSize","f16","additionInterval","f32","checkAddition","metadata","output","operation","expectedfillValue","numEles","width","scalarTy","expectedOffset","length","i","expected","j","idx","isOdd","Math","floor","val","Error","undefined","filter","beginSubcases","requiresF16","scalarType","enables","wgThreads","wgsl","toString","expectedFillValue","fillValue","numUints","ceil","Uint32Array","unimplemented","checkPredicatedAddition","size","id","bound","testcase","outputUintsPerElement","inputData","cond"],"sources":["../../../../../../../src/webgpu/shader/execution/expression/call/builtin/subgroupAdd.spec.ts"],"sourcesContent":["export const description = `\nExecution tests for subgroupAdd, subgroupExclusiveAdd, and subgroupInclusiveAdd\n\nNote: There is a lack of portability for non-uniform execution so these tests\nrestrict themselves to uniform control flow.\nNote: There is no guaranteed mapping between subgroup_invocation_id and\nlocal_invocation_index. Tests should avoid assuming there is.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport { iterRange } from '../../../../../../common/util/util.js';\nimport { GPUTest } from '../../../../../gpu_test.js';\nimport {\n  kConcreteNumericScalarsAndVectors,\n  Type,\n  VectorType,\n  numberToFloatBits,\n  floatBitsToNumber,\n  kFloat32Format,\n  kFloat16Format,\n  scalarTypeOf,\n} from '../../../../../util/conversion.js';\nimport { FP } from '../../../../../util/floating_point.js';\n\nimport {\n  kNumCases,\n  kStride,\n  kWGSizes,\n  kPredicateCases,\n  runAccuracyTest,\n  runComputeTest,\n} from './subgroup_util.js';\n\nexport const g = makeTestGroup(GPUTest);\n\nconst kIdentity = 0;\n\nconst kDataTypes = objectsToRecord(kConcreteNumericScalarsAndVectors);\n\nconst kOperations = ['subgroupAdd', 'subgroupExclusiveAdd', 'subgroupInclusiveAdd'] as const;\n\ng.test('fp_accuracy')\n  .desc(\n    `Tests the accuracy of floating-point addition.\n\nThe order of operations is implementation defined, most threads are filled with\nthe identity value and two receive random values.\nSubgroup sizes are not known ahead of time so some cases may not perform any\ninteresting operations. The test biases towards checking subgroup sizes under 64.\nThese tests only check two values in order to reuse more of the existing infrastructure\nand limit the number of permutations needed to calculate the final result.`\n  )\n  .params(u =>\n    u\n      .combine('case', [...iterRange(kNumCases, x => x)])\n      .combine('type', ['f32', 'f16'] as const)\n      .combine('wgSize', [\n        [kStride, 1, 1],\n        [kStride / 2, 2, 1],\n      ] as const)\n  )\n  .beforeAllSubcases(t => {\n    const features: GPUFeatureName[] = ['subgroups' as GPUFeatureName];\n    if (t.params.type === 'f16') {\n      features.push('shader-f16');\n      features.push('subgroups-f16' as GPUFeatureName);\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(async t => {\n    await runAccuracyTest(\n      t,\n      t.params.case,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      'subgroupAdd',\n      t.params.type,\n      kIdentity,\n      t.params.type === 'f16' ? FP.f16.additionInterval : FP.f32.additionInterval\n    );\n  });\n\n/**\n * Checks subgroup additions\n *\n * Expected results:\n * - subgroupAdd: each invocation should have result equal to real subgroup size\n * - subgroupExclusiveAdd: each invocation should have result equal to its subgroup invocation id\n * - subgroupInclusiveAdd: each invocation should be equal to the result of subgroupExclusiveAdd plus the fill value\n * @param metadata An array containing actual subgroup size per invocation followed by\n *                 subgroup invocation id per invocation\n * @param output An array of additions\n * @param type The data type\n * @param operation Type of addition\n * @param expectedfillValue The original value used to fill the test array\n */\nfunction checkAddition(\n  metadata: Uint32Array,\n  output: Uint32Array,\n  type: Type,\n  operation: 'subgroupAdd' | 'subgroupExclusiveAdd' | 'subgroupInclusiveAdd',\n  expectedfillValue: number\n): undefined | Error {\n  let numEles = 1;\n  if (type instanceof VectorType) {\n    numEles = type.width;\n  }\n  const scalarTy = scalarTypeOf(type);\n  const expectedOffset = operation === 'subgroupAdd' ? 0 : metadata.length / 2;\n  for (let i = 0; i < metadata.length / 2; i++) {\n    let expected = metadata[i + expectedOffset];\n    if (operation === 'subgroupInclusiveAdd') {\n      expected += expectedfillValue;\n    }\n\n    for (let j = 0; j < numEles; j++) {\n      let idx = i * numEles + j;\n      const isOdd = idx & 0x1;\n      if (scalarTy === Type.f16) {\n        idx = Math.floor(idx / 2);\n      }\n      let val = output[idx];\n      if (scalarTy === Type.f32) {\n        val = floatBitsToNumber(val, kFloat32Format);\n      } else if (scalarTy === Type.f16) {\n        if (isOdd) {\n          val = val >> 16;\n        }\n        val = floatBitsToNumber(val & 0xffff, kFloat16Format);\n      }\n      if (expected !== val) {\n        return new Error(`Invocation ${i}, component ${j}: incorrect result\n- expected: ${expected}\n-      got: ${val}`);\n      }\n    }\n  }\n\n  return undefined;\n}\n\ng.test('data_types')\n  .desc(\n    `Tests subgroup addition for valid data types\n\nTests a simple addition of all 1 values.\nReductions expect result to be equal to actual subgroup size.\nExclusice scans expect result to be equal subgroup invocation id.\n\nTODO: support vec3 types.\n  `\n  )\n  .params(u =>\n    u\n      .combine('type', keysOf(kDataTypes))\n      .filter(t => {\n        const type = kDataTypes[t.type];\n        if (type instanceof VectorType) {\n          return type.width !== 3;\n        }\n        return true;\n      })\n      .beginSubcases()\n      .combine('wgSize', kWGSizes)\n      .combine('operation', kOperations)\n  )\n  .beforeAllSubcases(t => {\n    const features: GPUFeatureName[] = ['subgroups' as GPUFeatureName];\n    const type = kDataTypes[t.params.type];\n    if (type.requiresF16()) {\n      features.push('shader-f16');\n      features.push('subgroups-f16' as GPUFeatureName);\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(async t => {\n    const type = kDataTypes[t.params.type];\n    let numEles = 1;\n    if (type instanceof VectorType) {\n      numEles = type.width;\n    }\n    const scalarType = scalarTypeOf(type);\n    let enables = 'enable subgroups;\\n';\n    if (type.requiresF16()) {\n      enables += 'enable f16;\\nenable subgroups_f16;\\n';\n    }\n\n    const wgThreads = t.params.wgSize[0] * t.params.wgSize[1] * t.params.wgSize[2];\n\n    const wgsl = `\n${enables}\n\n@group(0) @binding(0)\nvar<storage> inputs : array<${type.toString()}>;\n\n@group(0) @binding(1)\nvar<storage, read_write> outputs : array<${type.toString()}>;\n\nstruct Metadata {\n  subgroup_size : array<u32, ${wgThreads}>,\n  subgroup_invocation_id : array<u32, ${wgThreads}>,\n}\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : Metadata;\n\n@compute @workgroup_size(${t.params.wgSize[0]}, ${t.params.wgSize[1]}, ${t.params.wgSize[2]})\nfn main(\n  @builtin(local_invocation_index) lid : u32,\n  @builtin(subgroup_invocation_id) id : u32,\n) {\n  // Record the actual subgroup size for this invocation.\n  // Note: subgroup_size builtin is always a power-of-2 and might be larger\n  // if the subgroup is not full.\n  let ballot = subgroupBallot(true);\n  var size = countOneBits(ballot.x);\n  size += countOneBits(ballot.y);\n  size += countOneBits(ballot.z);\n  size += countOneBits(ballot.w);\n  metadata.subgroup_size[lid] = size;\n\n  // Record subgroup invocation id for this invocation.\n  metadata.subgroup_invocation_id[lid] = id;\n\n  outputs[lid] = ${t.params.operation}(inputs[lid]);\n}`;\n    const expectedFillValue = 1;\n    let fillValue = expectedFillValue;\n    let numUints = wgThreads * numEles;\n    if (scalarType === Type.f32) {\n      fillValue = numberToFloatBits(1, kFloat32Format);\n    } else if (scalarType === Type.f16) {\n      const f16 = numberToFloatBits(1, kFloat16Format);\n      fillValue = f16 | (f16 << 16);\n      numUints = Math.ceil(numUints / 2);\n    }\n    await runComputeTest(\n      t,\n      wgsl,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      numUints,\n      new Uint32Array([...iterRange(numUints, x => fillValue)]),\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkAddition(metadata, output, type, t.params.operation, expectedFillValue);\n      }\n    );\n  });\n\ng.test('fragment').unimplemented();\n\n/**\n * Performs correctness checking for predicated additions\n *\n * Assumes the shader performs a predicated subgroup addition with the\n * subgroup_invocation_id as the data.\n *\n * @param metadata An array containing subgroup sizes and subgroup invocation ids\n * @param output An array containing the output results\n * @param operation The type of addition\n * @param filter A functor that mirrors the predication in the shader\n */\nfunction checkPredicatedAddition(\n  metadata: Uint32Array,\n  output: Uint32Array,\n  operation: 'subgroupAdd' | 'subgroupExclusiveAdd' | 'subgroupInclusiveAdd',\n  filter: (id: number, size: number) => boolean\n): Error | undefined {\n  for (let i = 0; i < output.length; i++) {\n    const size = metadata[i];\n    const id = metadata[output.length + i];\n    let expected = 0;\n    if (filter(id, size)) {\n      const bound =\n        operation === 'subgroupInclusiveAdd' ? id + 1 : operation === 'subgroupAdd' ? size : id;\n      for (let j = 0; j < bound; j++) {\n        if (filter(j, size)) {\n          expected += j;\n        }\n      }\n    } else {\n      expected = 999;\n    }\n    if (expected !== output[i]) {\n      return new Error(`Invocation ${i}: incorrect result\n- expected: ${expected}\n-      got: ${output[i]}`);\n    }\n  }\n  return undefined;\n}\n\ng.test('compute,split')\n  .desc('Tests that only active invocations contribute to the operation')\n  .params(u =>\n    u\n      .combine('case', keysOf(kPredicateCases))\n      .beginSubcases()\n      .combine('operation', kOperations)\n      .combine('wgSize', kWGSizes)\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(async t => {\n    const testcase = kPredicateCases[t.params.case];\n    const outputUintsPerElement = 1;\n    const inputData = new Uint32Array([0]); // no input data\n    const wgThreads = t.params.wgSize[0] * t.params.wgSize[1] * t.params.wgSize[2];\n\n    const wgsl = `\nenable subgroups;\n\n@group(0) @binding(0)\nvar<storage> input : array<u32>;\n\n@group(0) @binding(1)\nvar<storage, read_write> outputs : array<u32>;\n\nstruct Metadata {\n  subgroup_size : array<u32, ${wgThreads}>,\n  subgroup_invocation_id : array<u32, ${wgThreads}>,\n}\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : Metadata;\n\n@compute @workgroup_size(${t.params.wgSize[0]}, ${t.params.wgSize[1]}, ${t.params.wgSize[2]})\nfn main(\n  @builtin(local_invocation_index) lid : u32,\n  @builtin(subgroup_invocation_id) id : u32,\n) {\n  _ = input[0];\n\n  // Record the actual subgroup size for this invocation.\n  // Note: subgroup_size builtin is always a power-of-2 and might be larger\n  // if the subgroup is not full.\n  let ballot = subgroupBallot(true);\n  var subgroupSize = countOneBits(ballot.x);\n  subgroupSize += countOneBits(ballot.y);\n  subgroupSize += countOneBits(ballot.z);\n  subgroupSize += countOneBits(ballot.w);\n  metadata.subgroup_size[lid] = subgroupSize;\n\n  // Record subgroup invocation id for this invocation.\n  metadata.subgroup_invocation_id[lid] = id;\n\n  if ${testcase.cond} {\n    outputs[lid] = ${t.params.operation}(id);\n  } else {\n    return;\n  }\n}`;\n\n    await runComputeTest(\n      t,\n      wgsl,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      outputUintsPerElement,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkPredicatedAddition(metadata, output, t.params.operation, testcase.filter);\n      }\n    );\n  });\n"],"mappings":"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"}