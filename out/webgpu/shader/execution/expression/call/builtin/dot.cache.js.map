{"version":3,"file":"dot.cache.js","names":["assert","kValue","FP","calculatePermutations","sparseVectorI64Range","vectorI64Range","generateVectorVectorToI64Cases","makeCaseCache","ai_dot","x","y","length","multiplications","map","_","idx","some","i64","isOOB","undefined","result","reduce","prev","curr","wentOOB","permutations","forEach","p","next","float_cases","flatMap","trait","N","nonConst","generateVectorPairToIntervalCases","vectorRange","sparseVectorRange","dotInterval","a","b","cases","abstract_int_vec2","abstract_int_vec3","abstract_int_vec4","d"],"sources":["../../../../../../../src/webgpu/shader/execution/expression/call/builtin/dot.cache.ts"],"sourcesContent":["import { ROArrayArray } from '../../../../../../common/util/types.js';\nimport { assert } from '../../../../../../common/util/util.js';\nimport { kValue } from '../../../../../util/constants.js';\nimport { FP } from '../../../../../util/floating_point.js';\nimport {\n  calculatePermutations,\n  sparseVectorI64Range,\n  vectorI64Range,\n} from '../../../../../util/math.js';\nimport { generateVectorVectorToI64Cases } from '../../case.js';\nimport { makeCaseCache } from '../../case_cache.js';\n\nfunction ai_dot(x: bigint[], y: bigint[]): bigint | undefined {\n  assert(x.length === y.length, 'Cannot calculate dot for vectors of different lengths');\n  const multiplications = x.map((_, idx) => x[idx] * y[idx]);\n  if (multiplications.some(kValue.i64.isOOB)) return undefined;\n\n  const result = multiplications.reduce((prev, curr) => prev + curr);\n  if (kValue.i64.isOOB(result)) return undefined;\n\n  // The spec does not state the ordering of summation, so all the\n  // permutations are calculated and the intermediate results checked for\n  // going OOB. vec2 does not need permutations, since a + b === b + a.\n  // All the end results should be the same regardless of the order if the\n  // intermediate additions stay inbounds.\n  if (x.length !== 2) {\n    let wentOOB: boolean = false;\n    const permutations: ROArrayArray<bigint> = calculatePermutations(multiplications);\n    permutations.forEach(p => {\n      if (!wentOOB) {\n        p.reduce((prev, curr) => {\n          const next = prev + curr;\n          if (kValue.i64.isOOB(next)) {\n            wentOOB = true;\n          }\n          return next;\n        });\n      }\n    });\n\n    if (wentOOB) return undefined;\n  }\n\n  return !kValue.i64.isOOB(result) ? result : undefined;\n}\n\n// Cases: [f32|f16]_vecN_[non_]const\nconst float_cases = (['f32', 'f16'] as const)\n  .flatMap(trait =>\n    ([2, 3, 4] as const).flatMap(N =>\n      ([true, false] as const).map(nonConst => ({\n        [`${trait}_vec${N}_${nonConst ? 'non_const' : 'const'}`]: () => {\n          // vec3 and vec4 require calculating all possible permutations, so their runtime is much\n          // longer per test, so only using sparse vectors for them.\n          return FP[trait].generateVectorPairToIntervalCases(\n            N === 2 ? FP[trait].vectorRange(2) : FP[trait].sparseVectorRange(N),\n            N === 2 ? FP[trait].vectorRange(2) : FP[trait].sparseVectorRange(N),\n            nonConst ? 'unfiltered' : 'finite',\n            FP[trait].dotInterval\n          );\n        },\n      }))\n    )\n  )\n  .reduce((a, b) => ({ ...a, ...b }), {});\n\nconst cases = {\n  ...float_cases,\n  abstract_int_vec2: () => {\n    return generateVectorVectorToI64Cases(vectorI64Range(2), vectorI64Range(2), ai_dot);\n  },\n  abstract_int_vec3: () => {\n    return generateVectorVectorToI64Cases(sparseVectorI64Range(3), sparseVectorI64Range(3), ai_dot);\n  },\n  abstract_int_vec4: () => {\n    return generateVectorVectorToI64Cases(sparseVectorI64Range(4), sparseVectorI64Range(4), ai_dot);\n  },\n};\n\nexport const d = makeCaseCache('dot', cases);\n"],"mappings":"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"}