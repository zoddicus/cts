{"version":3,"file":"shader_validation_test.js","names":["ErrorWithExtra","GPUTest","ShaderValidationTest","expectCompileResult","expectedResult","code","shaderModule","expectGPUError","device","createShaderModule","error","eventualAsyncExpectation","compilationInfo","getCompilationInfo","messagesLog","messages","map","m","lineNum","linePos","type","message","join","extra","some","rec","validationFailed","debug","wrapInEntryPoint","enabledExtensions","enableDirectives","x"],"sources":["../../../../src/webgpu/shader/validation/shader_validation_test.ts"],"sourcesContent":["import { ErrorWithExtra } from '../../../common/util/util.js';\nimport { GPUTest } from '../../gpu_test.js';\n\n/**\n * Base fixture for WGSL shader validation tests.\n */\nexport class ShaderValidationTest extends GPUTest {\n  /**\n   * Add a test expectation for whether a createShaderModule call succeeds or not.\n   *\n   * @example\n   * ```ts\n   * t.expectCompileResult(true, `wgsl code`); // Expect success\n   * t.expectCompileResult(false, `wgsl code`); // Expect validation error with any error string\n   * ```\n   */\n  expectCompileResult(expectedResult: boolean, code: string) {\n    let shaderModule: GPUShaderModule;\n    this.expectGPUError(\n      'validation',\n      () => {\n        shaderModule = this.device.createShaderModule({ code });\n      },\n      expectedResult !== true\n    );\n\n    const error = new ErrorWithExtra('', () => ({ shaderModule }));\n    this.eventualAsyncExpectation(async () => {\n      const compilationInfo = await shaderModule!.getCompilationInfo();\n\n      // MAINTENANCE_TODO: Pretty-print error messages with source context.\n      const messagesLog = compilationInfo.messages\n        .map(m => `${m.lineNum}:${m.linePos}: ${m.type}: ${m.message}`)\n        .join('\\n');\n      error.extra.compilationInfo = compilationInfo;\n\n      if (compilationInfo.messages.some(m => m.type === 'error')) {\n        if (expectedResult) {\n          error.message = `Unexpected compilationInfo 'error' message.\\n` + messagesLog;\n          this.rec.validationFailed(error);\n        } else {\n          error.message = `Found expected compilationInfo 'error' message.\\n` + messagesLog;\n          this.rec.debug(error);\n        }\n      } else {\n        if (!expectedResult) {\n          error.message = `Missing expected compilationInfo 'error' message.\\n` + messagesLog;\n          this.rec.validationFailed(error);\n        } else {\n          error.message = `No compilationInfo 'error' messages, as expected.\\n` + messagesLog;\n          this.rec.debug(error);\n        }\n      }\n    });\n  }\n\n  /**\n   * Wraps the code fragment into an entry point.\n   *\n   * @example\n   * ```ts\n   * t.wrapInEntryPoint(`var i = 0;`);\n   * ```\n   */\n  wrapInEntryPoint(code: string, enabledExtensions: string[] = []) {\n    const enableDirectives = enabledExtensions.map(x => `enable ${x};`).join('\\n      ');\n\n    return `\n      ${enableDirectives}\n\n      @compute @workgroup_size(1)\n      fn main() {\n        ${code}\n      }`;\n  }\n}\n"],"mappings":";AAAA;AAAA,GAAA,SAASA,cAAc,QAAQ,8BAA8B,CAC7D,SAASC,OAAO,QAAQ,mBAAmB;AAE3C;AACA;AACA;AACA,OAAO,MAAMC,oBAAoB,SAASD,OAAO,CAAC;EAChD;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEE,mBAAmB,CAACC,cAAuB,EAAEC,IAAY,EAAE;IACzD,IAAIC,YAA6B;IACjC,IAAI,CAACC,cAAc;IACjB,YAAY;IACZ,MAAM;MACJD,YAAY,GAAG,IAAI,CAACE,MAAM,CAACC,kBAAkB,CAAC,EAAEJ,IAAI,CAAC,CAAC,CAAC;IACzD,CAAC;IACDD,cAAc,KAAK,IAAI,CACxB;;;IAED,MAAMM,KAAK,GAAG,IAAIV,cAAc,CAAC,EAAE,EAAE,OAAO,EAAEM,YAAY,CAAC,CAAC,CAAC,CAAC;IAC9D,IAAI,CAACK,wBAAwB,CAAC,YAAY;MACxC,MAAMC,eAAe,GAAG,MAAMN,YAAY,CAAEO,kBAAkB,EAAE;;MAEhE;MACA,MAAMC,WAAW,GAAGF,eAAe,CAACG,QAAQ;MACzCC,GAAG,CAAC,CAAAC,CAAC,KAAK,GAAEA,CAAC,CAACC,OAAQ,IAAGD,CAAC,CAACE,OAAQ,KAAIF,CAAC,CAACG,IAAK,KAAIH,CAAC,CAACI,OAAQ,EAAC,CAAC;MAC9DC,IAAI,CAAC,IAAI,CAAC;MACbZ,KAAK,CAACa,KAAK,CAACX,eAAe,GAAGA,eAAe;;MAE7C,IAAIA,eAAe,CAACG,QAAQ,CAACS,IAAI,CAAC,CAAAP,CAAC,KAAIA,CAAC,CAACG,IAAI,KAAK,OAAO,CAAC,EAAE;QAC1D,IAAIhB,cAAc,EAAE;UAClBM,KAAK,CAACW,OAAO,GAAI,+CAA8C,GAAGP,WAAW;UAC7E,IAAI,CAACW,GAAG,CAACC,gBAAgB,CAAChB,KAAK,CAAC;QAClC,CAAC,MAAM;UACLA,KAAK,CAACW,OAAO,GAAI,mDAAkD,GAAGP,WAAW;UACjF,IAAI,CAACW,GAAG,CAACE,KAAK,CAACjB,KAAK,CAAC;QACvB;MACF,CAAC,MAAM;QACL,IAAI,CAACN,cAAc,EAAE;UACnBM,KAAK,CAACW,OAAO,GAAI,qDAAoD,GAAGP,WAAW;UACnF,IAAI,CAACW,GAAG,CAACC,gBAAgB,CAAChB,KAAK,CAAC;QAClC,CAAC,MAAM;UACLA,KAAK,CAACW,OAAO,GAAI,qDAAoD,GAAGP,WAAW;UACnF,IAAI,CAACW,GAAG,CAACE,KAAK,CAACjB,KAAK,CAAC;QACvB;MACF;IACF,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;EACEkB,gBAAgB,CAACvB,IAAY,EAAEwB,iBAA2B,GAAG,EAAE,EAAE;IAC/D,MAAMC,gBAAgB,GAAGD,iBAAiB,CAACb,GAAG,CAAC,CAAAe,CAAC,KAAK,UAASA,CAAE,GAAE,CAAC,CAACT,IAAI,CAAC,UAAU,CAAC;;IAEpF,OAAQ;AACZ,QAAQQ,gBAAiB;AACzB;AACA;AACA;AACA,UAAUzB,IAAK;AACf,QAAQ;EACN;AACF"}