{"version":3,"file":"builtin.spec.js","names":["description","makeTestGroup","keysOf","ShaderValidationTest","g","kTests","pos","src","pass","trailing_comma","newline_in_attr","whitespace_in_attr","invalid_name","no_params","missing_param","missing_parens","missing_lparen","missing_rparen","multiple_params","ident_param","number_param","test","desc","params","u","combine","fn","t","builtin","code","expectCompileResult","undefined","beginSubcases","scope","attr","attribute"],"sources":["../../../../../src/webgpu/shader/validation/parse/builtin.spec.ts"],"sourcesContent":["export const description = `Validation tests for @builtin`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kTests = {\n  pos: {\n    src: `@builtin(position)`,\n    pass: true,\n  },\n  trailing_comma: {\n    src: `@builtin(position,)`,\n    pass: true,\n  },\n  newline_in_attr: {\n    src: `@ \\n builtin(position)`,\n    pass: true,\n  },\n  whitespace_in_attr: {\n    src: `@/* comment */builtin/* comment */\\n\\n(\\t/*comment*/position/*comment*/)`,\n    pass: true,\n  },\n  invalid_name: {\n    src: `@abuiltin(position)`,\n    pass: false,\n  },\n  no_params: {\n    src: `@builtin`,\n    pass: false,\n  },\n  missing_param: {\n    src: `@builtin()`,\n    pass: false,\n  },\n  missing_parens: {\n    src: `@builtin position`,\n    pass: false,\n  },\n  missing_lparen: {\n    src: `@builtin position)`,\n    pass: false,\n  },\n  missing_rparen: {\n    src: `@builtin(position`,\n    pass: false,\n  },\n  multiple_params: {\n    src: `@builtin(position, frag_depth)`,\n    pass: false,\n  },\n  ident_param: {\n    src: `@builtin(identifier)`,\n    pass: false,\n  },\n  number_param: {\n    src: `@builtin(2)`,\n    pass: false,\n  },\n};\n\ng.test('parse')\n  .desc(`Test that @builtin is parsed correctly.`)\n  .params(u => u.combine('builtin', keysOf(kTests)))\n  .fn(t => {\n    const src = kTests[t.params.builtin].src;\n    const code = `\n@vertex\nfn main() -> ${src} vec4<f32> {\n  return vec4<f32>(.4, .2, .3, .1);\n}`;\n    t.expectCompileResult(kTests[t.params.builtin].pass, code);\n  });\n\ng.test('placement')\n  .desc('Tests the locations @builtin is allowed to appear')\n  .params(u =>\n    u\n      .combine('scope', [\n        // The fn-param and fn-ret are part of the shader_io/builtins tests\n        'private-var',\n        'storage-var',\n        'struct-member',\n        'non-ep-param',\n        'non-ep-ret',\n        'fn-decl',\n        'fn-var',\n        'while-stmt',\n        undefined,\n      ] as const)\n      .combine('attribute', [\n        {\n          'private-var': false,\n          'storage-var': false,\n          'struct-member': true,\n          'non-ep-param': false,\n          'non-ep-ret': false,\n          'fn-decl': false,\n          'fn-var': false,\n          'fn-return': false,\n          'while-stmt': false,\n        },\n      ])\n      .beginSubcases()\n  )\n  .fn(t => {\n    const scope = t.params.scope;\n\n    const attr = '@builtin(vertex_index)';\n    const code = `\n      ${scope === 'private-var' ? attr : ''}\n      var<private> priv_var : u32;\n\n      ${scope === 'storage-var' ? attr : ''}\n      @group(0) @binding(0)\n      var<storage> stor_var : u32;\n\n      struct A {\n        ${scope === 'struct-member' ? attr : ''}\n        a : u32,\n      }\n\n      fn v(${scope === 'non-ep-param' ? attr : ''} i : u32) ->\n            ${scope === 'non-ep-ret' ? attr : ''} u32 { return 1; }\n\n      @vertex\n      ${scope === 'fn-decl' ? attr : ''}\n      fn f(\n        @location(0) b : u32,\n      ) -> @builtin(position) vec4f {\n        ${scope === 'fn-var' ? attr : ''}\n        var<function> func_v : u32;\n\n        ${scope === 'while-stmt' ? attr : ''}\n        while false {}\n\n        return vec4(1, 1, 1, 1);\n      }\n    `;\n\n    t.expectCompileResult(scope === undefined || t.params.attribute[scope], code);\n  });\n"],"mappings":"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"}