{"version":3,"file":"must_use.spec.js","names":["description","makeTestGroup","keysOf","ShaderValidationTest","g","kMustUseDeclarations","var","code","valid","function_no_return","function_scalar_return","function_struct_return","function_var","function_call","function_parameter","empty_parameter","parameter","duplicate","test","desc","params","u","combine","fn","t","expectCompileResult","kMustUseCalls","no_call","phony","let","local_var","private_var","storage_var","pointer","vector_elem","matrix_elem","condition","param","return","statement","call","use","should_pass","wgsl"],"sources":["../../../../../src/webgpu/shader/validation/parse/must_use.spec.ts"],"sourcesContent":["export const description = `Validation tests for @must_use`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kMustUseDeclarations = {\n  var: {\n    code: `@must_use @group(0) @binding(0)\n    var<storage> x : array<u32>;`,\n    valid: false,\n  },\n  function_no_return: {\n    code: `@must_use fn foo() { }`,\n    valid: false,\n  },\n  function_scalar_return: {\n    code: `@must_use fn foo() -> u32 { return 0; }`,\n    valid: true,\n  },\n  function_struct_return: {\n    code: `struct S { x : u32 }\n    @must_use fn foo() -> S { return S(); }`,\n    valid: true,\n  },\n  function_var: {\n    code: `fn foo() { @must_use var x = 0; }`,\n    valid: false,\n  },\n  function_call: {\n    code: `fn bar() -> u32 { return 0; }\n    fn foo() { @must_use bar(); }`,\n    valid: false,\n  },\n  function_parameter: {\n    code: `fn foo(@must_use param : u32) -> u32 { return param; }`,\n    valid: false,\n  },\n  empty_parameter: {\n    code: `@must_use() fn foo() -> u32 { return 0; }`,\n    valid: false,\n  },\n  parameter: {\n    code: `@must_use(0) fn foo() -> u32 { return 0; }`,\n    valid: false,\n  },\n  duplicate: {\n    code: `@must_use @must_use fn foo() -> u32 { return 0; }`,\n    valid: false,\n  },\n};\n\ng.test('declaration')\n  .desc(`Validate attribute can only be applied to a function declaration with a return type`)\n  .params(u => u.combine('test', keysOf(kMustUseDeclarations)))\n  .fn(t => {\n    const test = kMustUseDeclarations[t.params.test];\n    t.expectCompileResult(test.valid, test.code);\n  });\n\nconst kMustUseCalls = {\n  no_call: ``, // Never calling a @must_use function should pass\n  phony: `_ = bar();`,\n  let: `let tmp = bar();`,\n  local_var: `var tmp = bar();`,\n  private_var: `private_var = bar();`,\n  storage_var: `storage_var = bar();`,\n  pointer: `\n    var a : f32;\n    let p = &a;\n    (*p) = bar();`,\n  vector_elem: `\n    var a : vec3<f32>;\n    a.x = bar();`,\n  matrix_elem: `\n    var a : mat3x2<f32>;\n    a[0][0] = bar();`,\n  condition: `if bar() == 0 { }`,\n  param: `baz(bar());`,\n  return: `return bar();`,\n  statement: `bar();`, // should fail if bar is @must_use\n};\n\ng.test('call')\n  .desc(`Validate that a call to must_use function cannot be the whole function call statement`)\n  .params(u =>\n    u //\n      .combine('use', ['@must_use', ''] as const)\n      .combine('call', keysOf(kMustUseCalls))\n  )\n  .fn(t => {\n    const test = kMustUseCalls[t.params.call];\n    const code = `\n    @group(0) @binding(0) var<storage, read_write> storage_var : f32;\n    var<private> private_var : f32;\n\n    fn baz(param : f32) { }\n\n    ${t.params.use} fn bar() -> f32 { return 0; }\n\n    fn foo() ${t.params.call === 'return' ? '-> f32' : ''} {\n      ${test}\n    }`;\n\n    const should_pass = t.params.call !== 'statement' || t.params.use === '';\n    t.expectCompileResult(should_pass, code);\n  });\n\ng.test('ignore_result_of_non_must_use_that_returns_call_of_must_use')\n  .desc(\n    `Test that ignoring the result of a non-@must_use function that returns the result of a @must_use function succeeds`\n  )\n  .fn(t => {\n    const wgsl = `\n    @must_use\n    fn f() -> f32 {\n      return 0;\n    }\n\n    fn g() -> f32 {\n      return f();\n    }\n\n    fn main() {\n      g(); // Ignore result\n    }\n    `;\n\n    t.expectCompileResult(true, wgsl);\n  });\n"],"mappings":"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"}