{"version":3,"file":"bindings.spec.js","names":["description","makeTestGroup","ShaderValidationTest","declareEntrypoint","kResourceEmitters","kResourceKindsA","kResourceKindsB","g","test","desc","params","u","combine","beginSubcases","fn","t","resourceA","get","a_kind","resourceB","b_kind","resources","a_group","a_binding","b_group","b_binding","expect","usage","code","stage","expectCompileResult","a_stage","b_stage","emitter","has_group","undefined","has_binding"],"sources":["../../../../../src/webgpu/shader/validation/resource_interface/bindings.spec.ts"],"sourcesContent":["export const description = `Validation tests for resource interface bindings`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nimport {\n  declareEntrypoint,\n  kResourceEmitters,\n  kResourceKindsA,\n  kResourceKindsB,\n  ResourceDeclarationEmitter,\n} from './util.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\ng.test('single_entry_point')\n  .desc(\n    `Test that two different resource variables in a shader must not have the same group and binding values, when considered as a pair.`\n  )\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('a_kind', kResourceKindsA)\n      .combine('b_kind', kResourceKindsB)\n      .combine('a_group', [0, 3] as const)\n      .combine('b_group', [0, 3] as const)\n      .combine('a_binding', [0, 3] as const)\n      .combine('b_binding', [0, 3] as const)\n      .combine('usage', ['direct', 'transitive'] as const)\n      .beginSubcases()\n  )\n  .fn(t => {\n    const resourceA = kResourceEmitters.get(t.params.a_kind) as ResourceDeclarationEmitter;\n    const resourceB = kResourceEmitters.get(t.params.b_kind) as ResourceDeclarationEmitter;\n    const resources = `\n${resourceA('resource_a', t.params.a_group, t.params.a_binding)}\n${resourceB('resource_b', t.params.b_group, t.params.b_binding)}\n`;\n    const expect =\n      t.params.a_group !== t.params.b_group || t.params.a_binding !== t.params.b_binding;\n\n    if (t.params.usage === 'direct') {\n      const code = `\n${resources}\n${declareEntrypoint('main', t.params.stage, '_ = resource_a; _ = resource_b;')}\n`;\n      t.expectCompileResult(expect, code);\n    } else {\n      const code = `\n${resources}\nfn use_a() { _ = resource_a; }\nfn use_b() { _ = resource_b; }\n${declareEntrypoint('main', t.params.stage, 'use_a(); use_b();')}\n`;\n      t.expectCompileResult(expect, code);\n    }\n  });\n\ng.test('different_entry_points')\n  .desc(\n    `Test that resources may use the same binding points if exclusively accessed by different entry points.`\n  )\n  .params(u =>\n    u\n      .combine('a_stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('b_stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('a_kind', kResourceKindsA)\n      .combine('b_kind', kResourceKindsB)\n      .combine('usage', ['direct', 'transitive'] as const)\n      .beginSubcases()\n  )\n  .fn(t => {\n    const resourceA = kResourceEmitters.get(t.params.a_kind) as ResourceDeclarationEmitter;\n    const resourceB = kResourceEmitters.get(t.params.b_kind) as ResourceDeclarationEmitter;\n    const resources = `\n${resourceA('resource_a', /* group */ 0, /* binding */ 0)}\n${resourceB('resource_b', /* group */ 0, /* binding */ 0)}\n`;\n    const expect = true; // Binding reuse between different entry points is fine.\n\n    if (t.params.usage === 'direct') {\n      const code = `\n${resources}\n${declareEntrypoint('main_a', t.params.a_stage, '_ = resource_a;')}\n${declareEntrypoint('main_b', t.params.b_stage, '_ = resource_b;')}\n`;\n      t.expectCompileResult(expect, code);\n    } else {\n      const code = `\n${resources}\nfn use_a() { _ = resource_a; }\nfn use_b() { _ = resource_b; }\n${declareEntrypoint('main_a', t.params.a_stage, 'use_a();')}\n${declareEntrypoint('main_b', t.params.b_stage, 'use_b();')}\n`;\n      t.expectCompileResult(expect, code);\n    }\n  });\n\ng.test('binding_attributes')\n  .desc(`Test that both @group and @binding attributes must both be declared.`)\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('has_group', [true, false] as const)\n      .combine('has_binding', [true, false] as const)\n      .beginSubcases()\n  )\n  .fn(t => {\n    const emitter = kResourceEmitters.get('uniform') as ResourceDeclarationEmitter;\n    const code = emitter(\n      'R',\n      t.params.has_group ? 0 : undefined,\n      t.params.has_binding ? 0 : undefined\n    );\n    const expect = t.params.has_group && t.params.has_binding;\n    t.expectCompileResult(expect, code);\n  });\n"],"mappings":"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"}