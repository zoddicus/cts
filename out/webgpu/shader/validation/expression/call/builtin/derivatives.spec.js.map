{"version":3,"file":"derivatives.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","TypeF16","TypeF32","TypeMat","elementType","kAllConcreteIntegerScalarsAndVectors","kAllF16ScalarsAndVectors","ShaderValidationTest","g","kDerivativeBuiltins","kEntryPoints","none","supportsDerivative","code","fragment","vertex","compute","fragment_and_compute","compute_without_call","test","specURL","desc","params","u","combine","fn","t","config","entry_point","call","expectCompileResult","kArgumentTypes","beforeAllSubcases","type","selectDeviceOrSkipTestCase","toString","create","wgsl"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/derivatives.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for derivative builtins.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport {\n  TypeF16,\n  TypeF32,\n  TypeMat,\n  elementType,\n  kAllConcreteIntegerScalarsAndVectors,\n  kAllF16ScalarsAndVectors,\n} from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kDerivativeBuiltins = [\n  'dpdx',\n  'dpdxCoarse',\n  'dpdxFine',\n  'dpdy',\n  'dpdyCoarse',\n  'dpdyFine',\n  'fwidth',\n  'fwidthCoarse',\n  'fwidthFine',\n];\n\nconst kEntryPoints = {\n  none: { supportsDerivative: true, code: `` },\n  fragment: {\n    supportsDerivative: true,\n    code: `@fragment\nfn main() {\n  foo();\n}`,\n  },\n  vertex: {\n    supportsDerivative: false,\n    code: `@vertex\nfn main() -> @builtin(position) vec4f {\n  foo();\n  return vec4f();\n}`,\n  },\n  compute: {\n    supportsDerivative: false,\n    code: `@compute @workgroup_size(1)\nfn main() {\n  foo();\n}`,\n  },\n  fragment_and_compute: {\n    supportsDerivative: false,\n    code: `@fragment\nfn main1() {\n  foo();\n}\n\n@compute @workgroup_size(1)\nfn main2() {\n  foo();\n}\n`,\n  },\n  compute_without_call: {\n    supportsDerivative: true,\n    code: `@compute @workgroup_size(1)\nfn main() {\n}\n`,\n  },\n};\n\ng.test('only_in_fragment')\n  .specURL('https://www.w3.org/TR/WGSL/#derivative-builtin-functions')\n  .desc(\n    `\nDerivative functions must only be used in the fragment shader stage.\n`\n  )\n  .params(u =>\n    u.combine('entry_point', keysOf(kEntryPoints)).combine('call', ['bar', ...kDerivativeBuiltins])\n  )\n  .fn(t => {\n    const config = kEntryPoints[t.params.entry_point];\n    const code = `\n${config.code}\nfn bar(f : f32) -> f32 { return f; }\n\nfn foo() {\n  _ = ${t.params.call}(1.0);\n}`;\n    t.expectCompileResult(t.params.call === 'bar' || config.supportsDerivative, code);\n  });\n\n// The list of invalid argument types to test, with an f32 control case.\nconst kArgumentTypes = objectsToRecord([\n  TypeF32,\n  ...kAllConcreteIntegerScalarsAndVectors,\n  ...kAllF16ScalarsAndVectors,\n  TypeMat(2, 2, TypeF32),\n]);\n\ng.test('invalid_argument_types')\n  .specURL('https://www.w3.org/TR/WGSL/#derivative-builtin-functions')\n  .desc(\n    `\nDerivative builtins only accept f32 scalar and vector types.\n`\n  )\n  .params(u =>\n    u.combine('type', keysOf(kArgumentTypes)).combine('call', ['', ...kDerivativeBuiltins])\n  )\n  .beforeAllSubcases(t => {\n    if (elementType(kArgumentTypes[t.params.type]) === TypeF16) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    const code = `\n${elementType(kArgumentTypes[t.params.type]) === TypeF16 ? 'enable f16;' : ''}\n\nfn foo() {\n  let x: ${type.toString()} = ${t.params.call}(${type.create(1).wgsl()});\n}`;\n    t.expectCompileResult(kArgumentTypes[t.params.type] === TypeF32 || t.params.call === '', code);\n  });\n"],"mappings":"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"}