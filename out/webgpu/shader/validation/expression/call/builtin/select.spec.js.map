{"version":3,"file":"select.spec.js","names":["builtin","description","makeTestGroup","keysOf","objectsToRecord","Type","concreteTypeOf","isConvertible","kAllScalarsAndVectors","scalarTypeOf","ShaderValidationTest","validateConstOrOverrideBuiltinEval","g","kArgumentTypes","test","desc","params","u","combine","beforeAllSubcases","t","type1","f16","type2","selectDeviceOrSkipTestCase","fn","returnType","undefined","create","bool","type","i32","kTests","valid","src","pass","alias","u32","f32","mixed_aint_afloat","mixed_i32_u32","vec_bool","vec2_bool_implicit","vec3_bool_implicit","vec_i32","vec_u32","vec_f32","vec_f16","matrix","atomic","array","array_runtime","struct","enumerant","ptr","ptr_deref","sampler","texture","no_args","too_few_args","too_many_args","use_it","use","expectCompileResult","includes","enables","code"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/select.spec.ts"],"sourcesContent":["const builtin = 'select';\nexport const description = `\nValidation tests for the ${builtin}() builtin.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport {\n  Type,\n  concreteTypeOf,\n  isConvertible,\n  kAllScalarsAndVectors,\n  scalarTypeOf,\n} from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nimport { validateConstOrOverrideBuiltinEval } from './const_override_validation.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kArgumentTypes = objectsToRecord(kAllScalarsAndVectors);\n\ng.test('argument_types_1_and_2')\n  .desc(\n    `\nValidates that scalar and vector arguments are not rejected by ${builtin}() for args 1 and 2\n`\n  )\n  .params(u => u.combine('type1', keysOf(kArgumentTypes)).combine('type2', keysOf(kArgumentTypes)))\n  .beforeAllSubcases(t => {\n    if (\n      scalarTypeOf(kArgumentTypes[t.params.type1]) === Type.f16 ||\n      scalarTypeOf(kArgumentTypes[t.params.type2]) === Type.f16\n    ) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const type1 = kArgumentTypes[t.params.type1];\n    const type2 = kArgumentTypes[t.params.type2];\n    // First and second arg must be the same or one convertible to the other.\n    // Note that we specify a concrete return type even if both args are abstract.\n    const returnType = isConvertible(type1, type2)\n      ? concreteTypeOf(type2)\n      : isConvertible(type2, type1)\n      ? concreteTypeOf(type1)\n      : undefined;\n    validateConstOrOverrideBuiltinEval(\n      t,\n      builtin,\n      /* expectedResult */ returnType !== undefined,\n      [type1.create(0), type2.create(0), Type.bool.create(0)],\n      'constant',\n      returnType\n    );\n  });\n\ng.test('argument_types_3')\n  .desc(\n    `\nValidates that third argument must be bool for ${builtin}()\n`\n  )\n  .params(u => u.combine('type', keysOf(kArgumentTypes)))\n  .beforeAllSubcases(t => {\n    if (scalarTypeOf(kArgumentTypes[t.params.type]) === Type.f16) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    validateConstOrOverrideBuiltinEval(\n      t,\n      builtin,\n      /* expectedResult */ type === Type.bool,\n      [Type.i32.create(0), Type.i32.create(0), type.create(0)],\n      'constant',\n      /*return_type*/ Type.i32\n    );\n  });\n\nconst kTests = {\n  valid: {\n    src: `_ = ${builtin}(1, 2, true);`,\n    pass: true,\n  },\n  alias: {\n    src: `_ = ${builtin}(i32_alias(1), i32_alias(2), bool_alias(true));`,\n    pass: true,\n  },\n  bool: {\n    src: `_ = ${builtin}(false, false, true);`,\n    pass: true,\n  },\n  i32: {\n    src: `_ = ${builtin}(1i, 1i, true);`,\n    pass: true,\n  },\n  u32: {\n    src: `_ = ${builtin}(1u, 1u, true);`,\n    pass: true,\n  },\n  f32: {\n    src: `_ = ${builtin}(1.0f, 1.0f, true);`,\n    pass: true,\n  },\n  f16: {\n    src: `_ = ${builtin}(1.0h, 1.0h, true);`,\n    pass: true,\n  },\n  mixed_aint_afloat: {\n    src: `_ = ${builtin}(1, 1.0, true);`,\n    pass: true,\n  },\n  mixed_i32_u32: {\n    src: `_ = ${builtin}(1i, 1u, true);`,\n    pass: false,\n  },\n  vec_bool: {\n    src: `_ = ${builtin}(vec2<bool>(false, true), vec2<bool>(false, true), true);`,\n    pass: true,\n  },\n  vec2_bool_implicit: {\n    src: `_ = ${builtin}(vec2(false, true), vec2(false, true), true);`,\n    pass: true,\n  },\n  vec3_bool_implicit: {\n    src: `_ = ${builtin}(vec3(false), vec3(true), true);`,\n    pass: true,\n  },\n  vec_i32: {\n    src: `_ = ${builtin}(vec2<i32>(1, 1), vec2<i32>(1, 1), true);`,\n    pass: true,\n  },\n  vec_u32: {\n    src: `_ = ${builtin}(vec2<u32>(1, 1), vec2<u32>(1, 1), true);`,\n    pass: true,\n  },\n  vec_f32: {\n    src: `_ = ${builtin}(vec2<f32>(1, 1), vec2<f32>(1, 1), true);`,\n    pass: true,\n  },\n  vec_f16: {\n    src: `_ = ${builtin}(vec2<f16>(1, 1), vec2<f16>(1, 1), true);`,\n    pass: true,\n  },\n  matrix: {\n    src: `_ = ${builtin}(mat2x2(1, 1, 1, 1), mat2x2(1, 1, 1, 1), true);`,\n    pass: false,\n  },\n  atomic: {\n    src: ` _ = ${builtin}(a, a, true);`,\n    pass: false,\n  },\n  array: {\n    src: `var a: array<bool, 5>;\n            _ = ${builtin}(a, a, true);`,\n    pass: false,\n  },\n  array_runtime: {\n    src: `_ = ${builtin}(k.arry, k.arry, true);`,\n    pass: false,\n  },\n  struct: {\n    src: `var a: A;\n            _ = ${builtin}(a, a, true);`,\n    pass: false,\n  },\n  enumerant: {\n    src: `_ = ${builtin}(read_write, read_write, true);`,\n    pass: false,\n  },\n  ptr: {\n    src: `var<function> a = true;\n            let p: ptr<function, bool> = &a;\n            _ = ${builtin}(p, p, true);`,\n    pass: false,\n  },\n  ptr_deref: {\n    src: `var<function> a = true;\n            let p: ptr<function, bool> = &a;\n            _ = ${builtin}(*p, *p, true);`,\n    pass: true,\n  },\n  sampler: {\n    src: `_ = ${builtin}(s, s, true);`,\n    pass: false,\n  },\n  texture: {\n    src: `_ = ${builtin}(t, t, true);`,\n    pass: false,\n  },\n  no_args: {\n    src: `_ = ${builtin}();`,\n    pass: false,\n  },\n  too_few_args: {\n    src: `_ = ${builtin}(1, true);`,\n    pass: false,\n  },\n  too_many_args: {\n    src: `_ = ${builtin}(1, 1, 1, true);`,\n    pass: false,\n  },\n};\n\ng.test('must_use')\n  .desc(`Result of ${builtin} must be used`)\n  .params(u => u.combine('use', [true, false]))\n  .fn(t => {\n    const use_it = t.params.use ? '_ = ' : '';\n    t.expectCompileResult(t.params.use, `fn f() { ${use_it}${builtin}(1, 2, true); }`);\n  });\n\ng.test('arguments')\n  .desc(`Test that ${builtin} is validated correctly.`)\n  .params(u => u.combine('test', keysOf(kTests)))\n  .beforeAllSubcases(t => {\n    if (t.params.test.includes('f16')) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const src = kTests[t.params.test].src;\n    const enables = t.params.test.includes('f16') ? 'enable f16;' : '';\n    const code = `\n  ${enables}\n  alias bool_alias = bool;\n  alias i32_alias = i32;\n\n  @group(0) @binding(0) var s: sampler;\n  @group(0) @binding(1) var t: texture_2d<f32>;\n\n  var<workgroup> a: atomic<u32>;\n\n  struct A {\n    i: bool,\n  }\n  struct B {\n    arry: array<u32>,\n  }\n  @group(0) @binding(3) var<storage> k: B;\n\n  @vertex\n  fn main() -> @builtin(position) vec4<f32> {\n    ${src}\n    return vec4<f32>(.4, .2, .3, .1);\n  }`;\n    t.expectCompileResult(kTests[t.params.test].pass, code);\n  });\n"],"mappings":"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"}