{"version":3,"file":"subgroupBallot.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","Type","elementTypeOf","kAllScalarsAndVectors","ShaderValidationTest","g","kStages","constant","override","runtime","test","desc","params","u","combine","beforeAllSubcases","t","selectDeviceOrSkipTestCase","fn","code","stage","expectCompileResult","kArgumentTypes","features","type","requiresF16","push","enables","wgsl","create","bool","filter","eleType","abstractInt","abstractFloat","toString","vec4u","compute","fragment","vertex","entry"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/subgroupBallot.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for subgroupBallot\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport { Type, elementTypeOf, kAllScalarsAndVectors } from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kStages: Record<string, string> = {\n  constant: `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  const x = subgroupBallot(true);\n}`,\n  override: `\nenable subgroups;\noverride o = subgroupBallot(true);`,\n  runtime: `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  let x = subgroupBallot(true);\n}`,\n};\n\ng.test('early_eval')\n  .desc('Ensures the builtin is not able to be compile time evaluated')\n  .params(u => u.combine('stage', keysOf(kStages)))\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(t => {\n    const code = kStages[t.params.stage];\n    t.expectCompileResult(t.params.stage === 'runtime', code);\n  });\n\nconst kArgumentTypes = objectsToRecord(kAllScalarsAndVectors);\n\ng.test('data_type')\n  .desc('Validates data parameter type')\n  .params(u => u.combine('type', keysOf(kArgumentTypes)))\n  .beforeAllSubcases(t => {\n    const features = ['subgroups' as GPUFeatureName];\n    const type = kArgumentTypes[t.params.type];\n    if (type.requiresF16()) {\n      features.push('subgroups-f16' as GPUFeatureName);\n      features.push('shader-f16');\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    let enables = `enable subgroups;\\n`;\n    if (type.requiresF16()) {\n      enables += `enable subgroups_f16;\\nenable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  _ = subgroupBallot(${type.create(0).wgsl()});\n}`;\n\n    t.expectCompileResult(type === Type.bool, wgsl);\n  });\n\ng.test('return_type')\n  .desc('Validates data parameter type')\n  .params(u =>\n    u.combine('type', keysOf(kArgumentTypes)).filter(t => {\n      const type = kArgumentTypes[t.type];\n      const eleType = elementTypeOf(type);\n      return eleType !== Type.abstractInt && eleType !== Type.abstractFloat;\n    })\n  )\n  .beforeAllSubcases(t => {\n    const features = ['subgroups' as GPUFeatureName];\n    const type = kArgumentTypes[t.params.type];\n    if (type.requiresF16()) {\n      features.push('subgroups-f16' as GPUFeatureName);\n      features.push('shader-f16');\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    let enables = `enable subgroups;\\n`;\n    if (type.requiresF16()) {\n      enables += `enable subgroups_f16;\\nenable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  let res : ${type.toString()} = subgroupBallot(true);\n}`;\n\n    t.expectCompileResult(type === Type.vec4u, wgsl);\n  });\n\ng.test('stage')\n  .desc('Validates it is only usable in correct stage')\n  .params(u => u.combine('stage', ['compute', 'fragment', 'vertex'] as const))\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(t => {\n    const compute = `\n@compute @workgroup_size(1)\nfn main() {\n  foo();\n}`;\n\n    const fragment = `\n@fragment\nfn main() {\n  foo();\n}`;\n\n    const vertex = `\n@vertex\nfn main() -> @builtin(position) vec4f {\n  foo();\n  return vec4f();\n}`;\n\n    const entry = { compute, fragment, vertex }[t.params.stage];\n    const wgsl = `\nenable subgroups;\nfn foo() {\n  _ = subgroupBallot(true);\n}\n\n${entry}\n`;\n\n    t.expectCompileResult(t.params.stage !== 'vertex', wgsl);\n  });\n"],"mappings":"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"}