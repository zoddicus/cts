{"version":3,"file":"barriers.spec.js","names":["description","makeTestGroup","keysOf","ShaderValidationTest","g","kEntryPoints","none","supportsBarrier","code","compute","vertex","fragment","compute_and_fragment","fragment_without_call","test","specURL","desc","params","u","combine","fn","t","call","startsWith","skipIfLanguageFeatureNotSupported","config","entry_point","expectCompileResult","rhs","assign"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/barriers.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for {storage,texture,workgroup}Barrier() builtins.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../../../common/util/data_tables.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kEntryPoints = {\n  none: { supportsBarrier: true, code: `` },\n  compute: {\n    supportsBarrier: true,\n    code: `@compute @workgroup_size(1)\nfn main() {\n  foo();\n}`,\n  },\n  vertex: {\n    supportsBarrier: false,\n    code: `@vertex\nfn main() -> @builtin(position) vec4f {\n  foo();\n  return vec4f();\n}`,\n  },\n  fragment: {\n    supportsBarrier: false,\n    code: `@fragment\nfn main() {\n  foo();\n}`,\n  },\n  compute_and_fragment: {\n    supportsBarrier: false,\n    code: `@compute @workgroup_size(1)\nfn main1() {\n  foo();\n}\n\n@fragment\nfn main2() {\n  foo();\n}\n`,\n  },\n  fragment_without_call: {\n    supportsBarrier: true,\n    code: `@fragment\nfn main() {\n}\n`,\n  },\n};\n\ng.test('only_in_compute')\n  .specURL('https://www.w3.org/TR/WGSL/#sync-builtin-functions')\n  .desc(\n    `\nSynchronization functions must only be used in the compute shader stage.\n`\n  )\n  .params(u =>\n    u\n      .combine('entry_point', keysOf(kEntryPoints))\n      .combine('call', ['bar', 'storageBarrier', 'textureBarrier', 'workgroupBarrier'])\n  )\n  .fn(t => {\n    if (t.params.call.startsWith('textureBarrier')) {\n      t.skipIfLanguageFeatureNotSupported('readonly_and_readwrite_storage_textures');\n    }\n\n    const config = kEntryPoints[t.params.entry_point];\n    const code = `\n${config.code}\nfn bar() {}\n\nfn foo() {\n  ${t.params.call}();\n}`;\n    t.expectCompileResult(t.params.call === 'bar' || config.supportsBarrier, code);\n  });\n\ng.test('no_return_value')\n  .specURL('https://www.w3.org/TR/WGSL/#sync-builtin-functions')\n  .desc(\n    `\nBarrier functions do not return a value.\n`\n  )\n  .params(u =>\n    u\n      .combine('assign', [false, true])\n      .combine('rhs', ['bar', 'storageBarrier', 'textureBarrier', 'workgroupBarrier'])\n  )\n  .fn(t => {\n    if (t.params.rhs.startsWith('textureBarrier')) {\n      t.skipIfLanguageFeatureNotSupported('readonly_and_readwrite_storage_textures');\n    }\n\n    const code = `\nfn bar() {}\n\nfn foo() {\n  ${t.params.assign ? '_ = ' : ''} ${t.params.rhs}();\n}`;\n    t.expectCompileResult(!t.params.assign || t.params.rhs === 'bar()', code);\n  });\n"],"mappings":"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"}