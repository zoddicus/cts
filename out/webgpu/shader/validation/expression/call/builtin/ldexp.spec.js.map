{"version":3,"file":"ldexp.spec.js","names":["builtin","description","makeTestGroup","keysOf","objectsToRecord","Type","scalarTypeOf","kConvertableToFloatScalarsAndVectors","kConcreteSignedIntegerScalarsAndVectors","ShaderValidationTest","ConstantOrOverrideValueChecker","fullRangeForType","kConstantAndOverrideStages","stageSupportsType","validateConstOrOverrideBuiltinEval","g","kValidArgumentTypesA","kValidArgumentTypesB","abstractInt","vec","supportedSecondArgTypes","typeAKey","typeA","width","i32","biasForType","type","f16","f32","abstractFloat","Error","biasRange","bias","Math","floor","test","desc","params","u","combine","expand","filter","stage","typeB","beginSubcases","beforeAllSubcases","t","selectDeviceOrSkipTestCase","fn","scalarTypeA","vCheck","validExponent","Number","b","a","checkedResult","pow","allChecksPassed","create","kArgCases","good","bad_no_parens","bad_0args","bad_1arg","bad_3arg","bad_vec_scalar","bad_scalar_vec","bad_vec_sizes","bad_0bool","bad_0array","bad_0struct","bad_0int","bad_0uint","bad_0vec2i","bad_0vec3i","bad_0vec4i","bad_0vec2u","bad_0vec3u","bad_0vec4u","bad_1bool","bad_1array","bad_1struct","bad_1f32","bad_1f16","bad_1uint","bad_1vec2f","bad_1vec3f","bad_1vec4f","bad_1vec2h","bad_1vec3h","bad_1vec4h","bad_1vec2u","bad_1vec3u","bad_1vec4u","expectCompileResult","arg","use_it","use"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/ldexp.spec.ts"],"sourcesContent":["const builtin = 'ldexp';\nexport const description = `\nValidation tests for the ${builtin}() builtin.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport {\n  Type,\n  scalarTypeOf,\n  ScalarType,\n  kConvertableToFloatScalarsAndVectors,\n  kConcreteSignedIntegerScalarsAndVectors,\n  VectorType,\n} from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nimport {\n  ConstantOrOverrideValueChecker,\n  fullRangeForType,\n  kConstantAndOverrideStages,\n  stageSupportsType,\n  validateConstOrOverrideBuiltinEval,\n} from './const_override_validation.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kValidArgumentTypesA = objectsToRecord(kConvertableToFloatScalarsAndVectors);\nconst kValidArgumentTypesB = objectsToRecord([\n  Type.abstractInt,\n  Type.vec(2, Type.abstractInt),\n  Type.vec(3, Type.abstractInt),\n  Type.vec(4, Type.abstractInt),\n  ...kConcreteSignedIntegerScalarsAndVectors,\n]);\n\nfunction supportedSecondArgTypes(typeAKey: string) {\n  const typeA = kValidArgumentTypesA[typeAKey];\n\n  switch (typeA.width) {\n    case 1:\n      return objectsToRecord([Type.abstractInt, Type.i32]);\n    default:\n      return objectsToRecord([\n        Type.vec(typeA.width, Type.abstractInt),\n        Type.vec(typeA.width, Type.i32),\n      ]);\n  }\n}\n\nfunction biasForType(type: VectorType | ScalarType) {\n  switch (type) {\n    case Type.f16:\n      return 15;\n    case Type.f32:\n      return 127;\n    case Type.abstractFloat:\n    case Type.abstractInt:\n      return 1023;\n    default:\n      throw new Error(`Invalid bias type ${type}`);\n  }\n}\n\nfunction biasRange(type: VectorType | ScalarType) {\n  const bias = biasForType(scalarTypeOf(type));\n  return [-bias - 2, -bias, Math.floor(-bias * 0.5), 0, Math.floor(bias * 0.5), bias, bias + 2];\n}\n\ng.test('values')\n  .desc(\n    `\nValidates that constant evaluation and override evaluation of ${builtin}() never errors\n`\n  )\n  .params(u =>\n    u\n      .combine('stage', kConstantAndOverrideStages)\n      .combine('typeA', keysOf(kValidArgumentTypesA))\n      .expand('typeB', u => keysOf(supportedSecondArgTypes(u.typeA)))\n      .filter(u => stageSupportsType(u.stage, kValidArgumentTypesA[u.typeA]))\n      .filter(u => stageSupportsType(u.stage, kValidArgumentTypesB[u.typeB]))\n      .beginSubcases()\n      .expand('a', u => fullRangeForType(kValidArgumentTypesA[u.typeA], 5))\n      .expand('b', u => biasRange(kValidArgumentTypesA[u.typeA]))\n  )\n  .beforeAllSubcases(t => {\n    if (scalarTypeOf(kValidArgumentTypesA[t.params.typeA]) === Type.f16) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const typeA = kValidArgumentTypesA[t.params.typeA];\n    const bias = biasForType(scalarTypeOf(typeA));\n    const scalarTypeA = scalarTypeOf(typeA);\n    const vCheck = new ConstantOrOverrideValueChecker(t, scalarTypeA);\n\n    const typeB = kValidArgumentTypesB[t.params.typeB];\n\n    const validExponent = Number(t.params.b) <= bias + 1;\n\n    // Should be invalid if the calculations result in values that exceed the\n    // maximum representable float value for the given type.\n    const a = Number(t.params.a);\n    const b = Number(t.params.b);\n    vCheck.checkedResult(a * Math.pow(2, b));\n\n    // Validates ldexp(a, b) or ldexp(vecN(a), vecN(b));\n    validateConstOrOverrideBuiltinEval(\n      t,\n      builtin,\n      validExponent && vCheck.allChecksPassed(),\n      [typeA.create(t.params.a), typeB.create(t.params.b)],\n      t.params.stage\n    );\n  });\n\nconst kArgCases = {\n  good: '(vec3(0), vec3(1))',\n  bad_no_parens: '',\n  // Bad number of args\n  bad_0args: '()',\n  bad_1arg: '(vec3(0))',\n  bad_3arg: '(vec3(0), vec3(1), vec3(2))',\n  // Bad value combinations\n  bad_vec_scalar: '(vec3(0), 1)',\n  bad_scalar_vec: '(0, vec3(1))',\n  bad_vec_sizes: '(vec3(0), vec2(1))',\n  // Bad value for arg 0\n  bad_0bool: '(false, vec3(1))',\n  bad_0array: '(array(1.1,2.2), vec3(1))',\n  bad_0struct: '(modf(2.2), vec3(1))',\n  bad_0int: '(0i, 1i)',\n  bad_0uint: '(0u, 1i)',\n  bad_0vec2i: '(vec2i(0), vec2i(1))',\n  bad_0vec3i: '(vec3i(0), vec3i(1))',\n  bad_0vec4i: '(vec4i(0), vec4i(1))',\n  bad_0vec2u: '(vec2u(0), vec2i(1))',\n  bad_0vec3u: '(vec3u(0), vec3i(1))',\n  bad_0vec4u: '(vec4u(0), vec4i(1))',\n  // Bad value type for arg 1\n  bad_1bool: '(vec3(0), true)',\n  bad_1array: '(vec3(0), array(1.1,2.2))',\n  bad_1struct: '(vec3(0), modf(2.2))',\n  bad_1f32: '(0f, 1f)',\n  bad_1f16: '(0f, 1h)',\n  bad_1uint: '(0f, 1u)',\n  bad_1vec2f: '(vec2f(0), vec2f(1))',\n  bad_1vec3f: '(vec3f(0), vec3f(1))',\n  bad_1vec4f: '(vec4f(0), vec4f(1))',\n  bad_1vec2h: '(vec2f(0), vec2h(1))',\n  bad_1vec3h: '(vec3f(0), vec3h(1))',\n  bad_1vec4h: '(vec4f(0), vec4h(1))',\n  bad_1vec2u: '(vec2f(0), vec2u(1))',\n  bad_1vec3u: '(vec3f(0), vec3u(1))',\n  bad_1vec4u: '(vec4f(0), vec4u(1))',\n};\n\ng.test('args')\n  .desc(`Test compilation failure of ${builtin} with variously shaped and typed arguments`)\n  .params(u => u.combine('arg', keysOf(kArgCases)))\n  .fn(t => {\n    t.expectCompileResult(\n      t.params.arg === 'good',\n      `const c = ${builtin}${kArgCases[t.params.arg]};`\n    );\n  });\n\ng.test('must_use')\n  .desc(`Result of ${builtin} must be used`)\n  .params(u => u.combine('use', [true, false]))\n  .fn(t => {\n    const use_it = t.params.use ? '_ = ' : '';\n    t.expectCompileResult(t.params.use, `fn f() { ${use_it}${builtin}${kArgCases['good']}; }`);\n  });\n"],"mappings":"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"}