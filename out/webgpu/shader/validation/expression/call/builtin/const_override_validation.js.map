{"version":3,"file":"const_override_validation.js","names":["assert","unreachable","kValue","Type","elementTypeOf","isAbstractType","scalarElementsOf","scalarTypeOf","scalarF16Range","scalarF32Range","scalarF64Range","linearRange","linearRangeBigInt","rangeForType","number_range","bigint_range","type","kind","minusTwoToTwoRangeForType","minusThreePiToThreePiRangeForType","Math","PI","sparseMinusThreePiToThreePiRangeForType","kConstantAndOverrideStages","stageSupportsType","stage","validateConstOrOverrideBuiltinEval","t","builtin","expectedResult","args","elTys","map","arg","enables","some","ty","f16","expectCompileResult","wgsl","join","constants","overrideDecls","callArgs","numOverrides","argOverrides","el","name","push","Number","value","expectPipelineResult","code","reference","fullRangeForType","count","undefined","pos_sub","ceil","pos_norm","i32","negative","min","positive","max","f","floor","u32","i64","unique","arrays","set","Set","arr","item","add"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/const_override_validation.ts"],"sourcesContent":["import { assert, unreachable } from '../../../../../../common/util/util.js';\nimport { kValue } from '../../../../../util/constants.js';\nimport {\n  Type,\n  Value,\n  elementTypeOf,\n  isAbstractType,\n  scalarElementsOf,\n  scalarTypeOf,\n} from '../../../../../util/conversion.js';\nimport {\n  scalarF16Range,\n  scalarF32Range,\n  scalarF64Range,\n  linearRange,\n  linearRangeBigInt,\n} from '../../../../../util/math.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\n/** @returns a function that can select between ranges depending on type */\nexport function rangeForType(\n  number_range: readonly number[],\n  bigint_range: readonly bigint[]\n): (type: Type) => readonly (number | bigint)[] {\n  return (type: Type): readonly (number | bigint)[] => {\n    switch (scalarTypeOf(type).kind) {\n      case 'abstract-float':\n      case 'f32':\n      case 'f16':\n        return number_range;\n      case 'abstract-int':\n        return bigint_range;\n    }\n    unreachable(`Received unexpected type '${type}'`);\n  };\n}\n\n/* @returns a linear sweep between -2 to 2 for type */\n// prettier-ignore\nexport const minusTwoToTwoRangeForType = rangeForType(\n  linearRange(-2, 2, 10),\n  [ -2n, -1n, 0n, 1n, 2n ]\n);\n\n/* @returns array of values ranging from -3π to 3π, with a focus on multiples of π */\nexport const minusThreePiToThreePiRangeForType = rangeForType(\n  [\n    -3 * Math.PI,\n    -2.999 * Math.PI,\n\n    -2.501 * Math.PI,\n    -2.5 * Math.PI,\n    -2.499 * Math.PI,\n\n    -2.001 * Math.PI,\n    -2.0 * Math.PI,\n    -1.999 * Math.PI,\n\n    -1.501 * Math.PI,\n    -1.5 * Math.PI,\n    -1.499 * Math.PI,\n\n    -1.001 * Math.PI,\n    -1.0 * Math.PI,\n    -0.999 * Math.PI,\n\n    -0.501 * Math.PI,\n    -0.5 * Math.PI,\n    -0.499 * Math.PI,\n\n    -0.001,\n    0,\n    0.001,\n\n    0.499 * Math.PI,\n    0.5 * Math.PI,\n    0.501 * Math.PI,\n\n    0.999 * Math.PI,\n    1.0 * Math.PI,\n    1.001 * Math.PI,\n\n    1.499 * Math.PI,\n    1.5 * Math.PI,\n    1.501 * Math.PI,\n\n    1.999 * Math.PI,\n    2.0 * Math.PI,\n    2.001 * Math.PI,\n\n    2.499 * Math.PI,\n    2.5 * Math.PI,\n    2.501 * Math.PI,\n\n    2.999 * Math.PI,\n    3 * Math.PI,\n  ],\n  [-2n, -1n, 0n, 1n, 2n]\n);\n\n/**\n * @returns a minimal array of values ranging from -3π to 3π, with a focus on\n * multiples of π.\n *\n * Used when multiple parameters are being passed in, so the number of cases\n * becomes the square or more of this list. */\nexport const sparseMinusThreePiToThreePiRangeForType = rangeForType(\n  [\n    -3 * Math.PI,\n    -2.5 * Math.PI,\n    -2.0 * Math.PI,\n    -1.5 * Math.PI,\n    -1.0 * Math.PI,\n    -0.5 * Math.PI,\n    0,\n    0.5 * Math.PI,\n    Math.PI,\n    1.5 * Math.PI,\n    2.0 * Math.PI,\n    2.5 * Math.PI,\n    3 * Math.PI,\n  ],\n  [-2n, -1n, 0n, 1n, 2n]\n);\n\n/// The evaluation stages to test\nexport const kConstantAndOverrideStages = ['constant', 'override'] as const;\n\nexport type ConstantOrOverrideStage = 'constant' | 'override';\n\n/**\n * @returns true if evaluation stage `stage` supports expressions of type @p.\n */\nexport function stageSupportsType(stage: ConstantOrOverrideStage, type: Type) {\n  if (stage === 'override' && isAbstractType(elementTypeOf(type)!)) {\n    // Abstract numerics are concretized before being used in an override expression.\n    return false;\n  }\n  return true;\n}\n\n/**\n * Runs a validation test to check that evaluation of `builtin` either evaluates with or without\n * error at shader creation time or pipeline creation time.\n * @param t the ShaderValidationTest\n * @param builtin the name of the builtin\n * @param expectedResult false if an error is expected, true if no error is expected\n * @param args the arguments to pass to the builtin\n * @param stage the evaluation stage\n */\nexport function validateConstOrOverrideBuiltinEval(\n  t: ShaderValidationTest,\n  builtin: string,\n  expectedResult: boolean,\n  args: Value[],\n  stage: ConstantOrOverrideStage\n) {\n  const elTys = args.map(arg => elementTypeOf(arg.type)!);\n  const enables = elTys.some(ty => ty === Type.f16) ? 'enable f16;' : '';\n\n  switch (stage) {\n    case 'constant': {\n      t.expectCompileResult(\n        expectedResult,\n        `${enables}\nconst v = ${builtin}(${args.map(arg => arg.wgsl()).join(', ')});`\n      );\n      break;\n    }\n    case 'override': {\n      assert(!elTys.some(ty => isAbstractType(ty)));\n      const constants: Record<string, number> = {};\n      const overrideDecls: string[] = [];\n      const callArgs: string[] = [];\n      let numOverrides = 0;\n      for (const arg of args) {\n        const argOverrides: string[] = [];\n        for (const el of scalarElementsOf(arg)) {\n          const name = `o${numOverrides++}`;\n          overrideDecls.push(`override ${name} : ${el.type};`);\n          argOverrides.push(name);\n          constants[name] = Number(el.value);\n        }\n        callArgs.push(`${arg.type}(${argOverrides.join(', ')})`);\n      }\n      t.expectPipelineResult({\n        expectedResult,\n        code: `${enables}\n${overrideDecls.join('\\n')}\nvar<private> v = ${builtin}(${callArgs.join(', ')});`,\n        constants,\n        reference: ['v'],\n      });\n      break;\n    }\n  }\n}\n\n/** @returns a sweep of the representable values for element type of `type` */\nexport function fullRangeForType(type: Type, count?: number): readonly (number | bigint)[] {\n  if (count === undefined) {\n    count = 25;\n  }\n  switch (scalarTypeOf(type)?.kind) {\n    case 'abstract-float':\n      return scalarF64Range({\n        pos_sub: Math.ceil((count * 1) / 5),\n        pos_norm: Math.ceil((count * 4) / 5),\n      });\n    case 'f32':\n      return scalarF32Range({\n        pos_sub: Math.ceil((count * 1) / 5),\n        pos_norm: Math.ceil((count * 4) / 5),\n      });\n    case 'f16':\n      return scalarF16Range({\n        pos_sub: Math.ceil((count * 1) / 5),\n        pos_norm: Math.ceil((count * 4) / 5),\n      });\n    case 'i32':\n      return linearRange(kValue.i32.negative.min, kValue.i32.positive.max, count).map(f =>\n        Math.floor(f)\n      );\n    case 'u32':\n      return linearRange(0, kValue.u32.max, count).map(f => Math.floor(f));\n    case 'abstract-int':\n      // Returned values are already ints, so don't need to be floored.\n      return linearRangeBigInt(kValue.i64.negative.min, kValue.i64.positive.max, count);\n  }\n  unreachable();\n}\n\n/** @returns all the values in the provided arrays with duplicates removed */\nexport function unique<T>(...arrays: Array<readonly T[]>): T[] {\n  const set = new Set<T>();\n  for (const arr of arrays) {\n    for (const item of arr) {\n      set.add(item);\n    }\n  }\n  return [...set];\n}\n"],"mappings":"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"}