{"version":3,"file":"subgroupBroadcastFirst.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","Type","elementTypeOf","kAllScalarsAndVectors","ShaderValidationTest","g","test","desc","params","u","combine","beforeAllSubcases","t","selectDeviceOrSkipTestCase","fn","wgsl","enable","expectCompileResult","features","push","kArgumentTypes","kStages","constant","override","runtime","code","stage","must_use","type","requiresF16","enables","create","bool","filter","retType","retEleTy","dataType","dataEleTy","abstractInt","abstractFloat","toString","expect","compute","fragment","vertex","entry"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/subgroupBroadcastFirst.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for subgroupBroadcastFirst\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport { Type, elementTypeOf, kAllScalarsAndVectors } from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\ng.test('requires_subgroups')\n  .desc('Validates that the subgroups feature is required')\n  .params(u => u.combine('enable', [false, true] as const))\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(t => {\n    const wgsl = `\n${t.params.enable ? 'enable subgroups;' : ''}\nfn foo() {\n  _ = subgroupBroadcastFirst(0);\n}`;\n\n    t.expectCompileResult(t.params.enable, wgsl);\n  });\n\ng.test('requires_subgroups_f16')\n  .desc('Validates that the subgroups feature is required')\n  .params(u => u.combine('enable', [false, true] as const))\n  .beforeAllSubcases(t => {\n    const features: GPUFeatureName[] = ['shader-f16', 'subgroups' as GPUFeatureName];\n    if (t.params.enable) {\n      features.push('subgroups-f16' as GPUFeatureName);\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(t => {\n    const wgsl = `\nenable f16;\nenable subgroups;\n${t.params.enable ? 'enable subgroups_f16;' : ''}\nfn foo() {\n  _ = subgroupBroadcastFirst(0h);\n}`;\n\n    t.expectCompileResult(t.params.enable, wgsl);\n  });\n\nconst kArgumentTypes = objectsToRecord(kAllScalarsAndVectors);\n\nconst kStages: Record<string, string> = {\n  constant: `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  const x = subgroupBroadcastFirst(0);\n}`,\n  override: `\nenable subgroups;\noverride o = subgroupBroadcastFirst(0);`,\n  runtime: `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  let x = subgroupBroadcastFirst(0);\n}`,\n};\n\ng.test('early_eval')\n  .desc('Ensures the builtin is not able to be compile time evaluated')\n  .params(u => u.combine('stage', keysOf(kStages)))\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(t => {\n    const code = kStages[t.params.stage];\n    t.expectCompileResult(t.params.stage === 'runtime', code);\n  });\n\ng.test('must_use')\n  .desc('Tests that the builtin has the @must_use attribute')\n  .params(u => u.combine('must_use', [true, false] as const))\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(t => {\n    const wgsl = `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  ${t.params.must_use ? '_ = ' : ''}subgroupBroadcastFirst(0);\n}`;\n\n    t.expectCompileResult(t.params.must_use, wgsl);\n  });\n\ng.test('data_type')\n  .desc('Validates data parameter type')\n  .params(u => u.combine('type', keysOf(kArgumentTypes)))\n  .beforeAllSubcases(t => {\n    const features = ['subgroups' as GPUFeatureName];\n    const type = kArgumentTypes[t.params.type];\n    if (type.requiresF16()) {\n      features.push('subgroups-f16' as GPUFeatureName);\n      features.push('shader-f16');\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    let enables = `enable subgroups;\\n`;\n    if (type.requiresF16()) {\n      enables += `enable subgroups_f16;\\nenable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  _ = subgroupBroadcastFirst(${type.create(0).wgsl()});\n}`;\n\n    t.expectCompileResult(elementTypeOf(type) !== Type.bool, wgsl);\n  });\n\ng.test('return_type')\n  .desc('Validates data parameter type')\n  .params(u =>\n    u\n      .combine('dataType', keysOf(kArgumentTypes))\n      .combine('retType', keysOf(kArgumentTypes))\n      .filter(t => {\n        const retType = kArgumentTypes[t.retType];\n        const retEleTy = elementTypeOf(retType);\n        const dataType = kArgumentTypes[t.dataType];\n        const dataEleTy = elementTypeOf(dataType);\n        return (\n          retEleTy !== Type.abstractInt &&\n          retEleTy !== Type.abstractFloat &&\n          dataEleTy !== Type.abstractInt &&\n          dataEleTy !== Type.abstractFloat\n        );\n      })\n  )\n  .beforeAllSubcases(t => {\n    const features = ['subgroups' as GPUFeatureName];\n    const dataType = kArgumentTypes[t.params.dataType];\n    const retType = kArgumentTypes[t.params.retType];\n    if (dataType.requiresF16() || retType.requiresF16()) {\n      features.push('subgroups-f16' as GPUFeatureName);\n      features.push('shader-f16');\n    }\n    t.selectDeviceOrSkipTestCase(features);\n  })\n  .fn(t => {\n    const dataType = kArgumentTypes[t.params.dataType];\n    const retType = kArgumentTypes[t.params.retType];\n    let enables = `enable subgroups;\\n`;\n    if (dataType.requiresF16() || retType.requiresF16()) {\n      enables += `enable subgroups_f16;\\nenable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  let res : ${retType.toString()} = subgroupBroadcastFirst(${dataType.create(0).wgsl()});\n}`;\n\n    const expect = elementTypeOf(dataType) !== Type.bool && dataType === retType;\n    t.expectCompileResult(expect, wgsl);\n  });\n\ng.test('stage')\n  .desc('Validates it is only usable in correct stage')\n  .params(u => u.combine('stage', ['compute', 'fragment', 'vertex'] as const))\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(t => {\n    const compute = `\n@compute @workgroup_size(1)\nfn main() {\n  foo();\n}`;\n\n    const fragment = `\n@fragment\nfn main() {\n  foo();\n}`;\n\n    const vertex = `\n@vertex\nfn main() -> @builtin(position) vec4f {\n  foo();\n  return vec4f();\n}`;\n\n    const entry = { compute, fragment, vertex }[t.params.stage];\n    const wgsl = `\nenable subgroups;\nfn foo() {\n  _ = subgroupBroadcastFirst(0);\n}\n\n${entry}\n`;\n\n    t.expectCompileResult(t.params.stage !== 'vertex', wgsl);\n  });\n"],"mappings":"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"}