{"version":3,"file":"and_or_xor.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","kAllScalarsAndVectors","ScalarType","scalarTypeOf","Type","VectorType","ShaderValidationTest","g","kOperators","and","op","supportsBool","or","xor","kScalarAndVectorTypes","test","desc","params","u","combine","filter","value","startsWith","beginSubcases","beforeAllSubcases","t","lhs","f16","rhs","selectDeviceOrSkipTestCase","fn","lhsElement","rhsElement","hasF16","code","create","wgsl","kIntegerTypes","abstractInt","i32","u32","elementIsCompatible","includes","bool","valid","width","expectCompileResult","kInvalidTypes","mat2x2f","expr","control","e","array","ptr","atomic","texture","sampler","struct","type"],"sources":["../../../../../../src/webgpu/shader/validation/expression/binary/and_or_xor.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for logical and bitwise and/or/xor expressions.\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../common/util/data_tables.js';\nimport {\n  kAllScalarsAndVectors,\n  ScalarType,\n  scalarTypeOf,\n  Type,\n  VectorType,\n} from '../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\n// A list of operators and a flag for whether they support boolean values or not.\nconst kOperators = {\n  and: { op: '&', supportsBool: true },\n  or: { op: '|', supportsBool: true },\n  xor: { op: '^', supportsBool: false },\n};\n\n// A list of scalar and vector types.\nconst kScalarAndVectorTypes = objectsToRecord(kAllScalarsAndVectors);\n\ng.test('scalar_vector')\n  .desc(\n    `\n  Validates that scalar and vector expressions are only accepted for bool or compatible integer types.\n  `\n  )\n  .params(u =>\n    u\n      .combine('lhs', keysOf(kScalarAndVectorTypes))\n      .combine(\n        'rhs',\n        // Skip vec3 and vec4 on the RHS to keep the number of subcases down.\n        // vec3 + vec3 and vec4 + vec4 is tested in execution tests.\n        keysOf(kScalarAndVectorTypes).filter(\n          value => !(value.startsWith('vec3') || value.startsWith('vec4'))\n        )\n      )\n      .beginSubcases()\n      .combine('op', keysOf(kOperators))\n  )\n  .beforeAllSubcases(t => {\n    if (\n      scalarTypeOf(kScalarAndVectorTypes[t.params.lhs]) === Type.f16 ||\n      scalarTypeOf(kScalarAndVectorTypes[t.params.rhs]) === Type.f16\n    ) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const op = kOperators[t.params.op];\n    const lhs = kScalarAndVectorTypes[t.params.lhs];\n    const rhs = kScalarAndVectorTypes[t.params.rhs];\n    const lhsElement = scalarTypeOf(lhs);\n    const rhsElement = scalarTypeOf(rhs);\n    const hasF16 = lhsElement === Type.f16 || rhsElement === Type.f16;\n    const code = `\n${hasF16 ? 'enable f16;' : ''}\nconst lhs = ${lhs.create(0).wgsl()};\nconst rhs = ${rhs.create(0).wgsl()};\nconst foo = lhs ${op.op} rhs;\n`;\n\n    // Determine if the element types are compatible.\n    const kIntegerTypes = [Type.abstractInt, Type.i32, Type.u32];\n    let elementIsCompatible = false;\n    if (lhsElement === Type.abstractInt) {\n      // Abstract integers are compatible with any other integer type.\n      elementIsCompatible = kIntegerTypes.includes(rhsElement);\n    } else if (rhsElement === Type.abstractInt) {\n      // Abstract integers are compatible with any other numeric type.\n      elementIsCompatible = kIntegerTypes.includes(lhsElement);\n    } else if (kIntegerTypes.includes(lhsElement)) {\n      // Concrete integers are only compatible with values with the exact same type.\n      elementIsCompatible = lhsElement === rhsElement;\n    } else if (lhsElement === Type.bool) {\n      // Booleans are only compatible with other booleans.\n      elementIsCompatible = rhsElement === Type.bool;\n    }\n\n    // Determine if the full type is compatible.\n    let valid = false;\n    if (lhs instanceof ScalarType && rhs instanceof ScalarType) {\n      valid = elementIsCompatible;\n    } else if (lhs instanceof VectorType && rhs instanceof VectorType) {\n      // Vectors are only compatible with if the vector widths match.\n      valid = lhs.width === rhs.width && elementIsCompatible;\n    }\n\n    if (lhsElement === Type.bool) {\n      valid &&= op.supportsBool;\n    }\n\n    t.expectCompileResult(valid, code);\n  });\n\ninterface InvalidTypeConfig {\n  // An expression that produces a value of the target type.\n  expr: string;\n  // A function that converts an expression of the target type into a valid integer operand.\n  control: (x: string) => string;\n}\nconst kInvalidTypes: Record<string, InvalidTypeConfig> = {\n  mat2x2f: {\n    expr: 'm',\n    control: e => `i32(${e}[0][0])`,\n  },\n\n  array: {\n    expr: 'arr',\n    control: e => `${e}[0]`,\n  },\n\n  ptr: {\n    expr: '(&u)',\n    control: e => `*${e}`,\n  },\n\n  atomic: {\n    expr: 'a',\n    control: e => `atomicLoad(&${e})`,\n  },\n\n  texture: {\n    expr: 't',\n    control: e => `i32(textureLoad(${e}, vec2(), 0).x)`,\n  },\n\n  sampler: {\n    expr: 's',\n    control: e => `i32(textureSampleLevel(t, ${e}, vec2(), 0).x)`,\n  },\n\n  struct: {\n    expr: 'str',\n    control: e => `${e}.u`,\n  },\n};\n\ng.test('invalid_types')\n  .desc(\n    `\n  Validates that expressions are never accepted for non-scalar and non-vector types.\n  `\n  )\n  .params(u =>\n    u\n      .combine('op', keysOf(kOperators))\n      .combine('type', keysOf(kInvalidTypes))\n      .combine('control', [true, false])\n      .beginSubcases()\n  )\n  .fn(t => {\n    const op = kOperators[t.params.op];\n    const type = kInvalidTypes[t.params.type];\n    const expr = t.params.control ? type.control(type.expr) : type.expr;\n    const code = `\n@group(0) @binding(0) var t : texture_2d<f32>;\n@group(0) @binding(1) var s : sampler;\n@group(0) @binding(2) var<storage, read_write> a : atomic<i32>;\n\nstruct S { u : u32 }\n\nvar<private> u : u32;\nvar<private> m : mat2x2f;\nvar<private> arr : array<i32, 4>;\nvar<private> str : S;\n\n@compute @workgroup_size(1)\nfn main() {\n  let foo = ${expr} ${op.op} ${expr};\n}\n`;\n\n    t.expectCompileResult(t.params.control, code);\n  });\n"],"mappings":"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"}