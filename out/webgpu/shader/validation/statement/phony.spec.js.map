{"version":3,"file":"phony.spec.js","names":["description","makeTestGroup","keysOf","scalarTypeOf","Type","ShaderValidationTest","g","kConstructibleTypes","kConstructibleCases","reduce","acc","t","value","create","wgsl","pass","usesF16","kind","array","struct","gdecl","atomic_u32","atomic_i32","test","desc","params","u","combine","beforeAllSubcases","c","type","selectDeviceOrSkipTestCase","fn","code","expectCompileResult","kVarCases","storage","storage_unsized","storage_atomic","uniform","texture","sampler","sampler_comparison","private","workgroup","workgroup_atomic","override","function_var","ldecl","let","const","function_const","ptr","ptr_to_unsized","indexed","user_fn","builtin","builtin_call","user_call","undeclared","kTests","literal","expr","var","in_for_init","in_for_init_semi","in_for_update","in_for_update_semi","in_block","in_continuing","in_paren","underscore","underscore_semi","underscore_equal","underscore_equal_semi","underscore_equal_underscore_semi","paren_underscore_paren","star_ampersand_undsscore","compound","equality","block","return"],"sources":["../../../../../src/webgpu/shader/validation/statement/phony.spec.ts"],"sourcesContent":["export const description = `Validation for phony assignment statements`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { scalarTypeOf, Type } from '../../../util/conversion.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\ninterface Case {\n  value: string;\n  pass: boolean;\n  usesF16?: boolean;\n  gdecl?: string;\n  ldecl?: string;\n}\n\nconst kConstructibleTypes = [\n  'bool',\n  'i32',\n  'u32',\n  'f32',\n  'f16',\n  'vec2f',\n  'vec3h',\n  'vec4u',\n  'vec3b',\n  'mat2x3f',\n  'mat4x2h',\n  'abstractInt',\n  'abstractFloat',\n] as const;\n\nconst kConstructibleCases = {\n  ...kConstructibleTypes.reduce(\n    (acc, t) => ({\n      ...acc,\n      [t]: {\n        value: Type[t].create(1).wgsl(),\n        pass: true,\n        usesF16: scalarTypeOf(Type[t]).kind === 'f16',\n      },\n    }),\n    {}\n  ),\n  array: { value: 'array(1,2,3)', pass: true },\n  struct: { value: 'S(1,2)', pass: true, gdecl: 'struct S{ a:u32, b:u32}' },\n  atomic_u32: { value: 'xu', pass: false, gdecl: 'var<workgroup> xu: atomic<u32>;' },\n  atomic_i32: { value: 'xi', pass: false, gdecl: 'var<workgroup> xi: atomic<i32>;' },\n} as const;\n\ng.test('rhs_constructible')\n  .desc(`Test that the rhs of 'phony assignment' can be a constructible.`)\n  .params(u => u.combine('type', keysOf(kConstructibleCases)))\n  .beforeAllSubcases(t => {\n    const c = kConstructibleCases[t.params.type] as Case;\n    if (c.usesF16) {\n      t.selectDeviceOrSkipTestCase('shader-f16');\n    }\n  })\n  .fn(t => {\n    const { value, pass, usesF16, gdecl } = kConstructibleCases[t.params.type] as Case;\n    const code = `\n${usesF16 ? 'enable f16;' : ''}\n${gdecl ?? ''}\nfn f() {\n  _ = ${value};\n}`;\n    t.expectCompileResult(pass, code);\n  });\n\nconst kVarCases = {\n  storage: { value: 'x', gdecl: '@group(0) @binding(0) var<storage> x: array<u32,1>;', pass: true },\n  storage_unsized: {\n    value: 'x',\n    gdecl: '@group(0) @binding(0) var<storage> x: array<u32>;',\n    pass: false,\n  },\n  storage_atomic: {\n    value: 'x',\n    gdecl: '@group(0) @binding(0) var<storage,read_write> x: atomic<u32>;',\n    pass: false,\n  },\n  uniform: { value: 'x', gdecl: '@group(0) @binding(0) var<uniform> x: u32;', pass: true },\n  texture: { value: 'x', gdecl: '@group(0) @binding(0) var x: texture_2d<f32>;', pass: true },\n  sampler: { value: 'x', gdecl: '@group(0) @binding(0) var x: sampler;', pass: true },\n  sampler_comparison: {\n    value: 'x',\n    gdecl: '@group(0) @binding(0) var x: sampler_comparison;',\n    pass: true,\n  },\n  private: { value: 'x', gdecl: 'var<private> x: u32;', pass: true },\n  workgroup: { value: 'x', gdecl: 'var<workgroup> x: u32;', pass: true },\n  workgroup_atomic: { value: 'x', gdecl: 'var<workgroup> x: atomic<u32>;', pass: false },\n  override: { value: 'o', gdecl: 'override o: u32;', pass: true },\n  function_var: { value: 'x', ldecl: 'var x: u32;', pass: true },\n  let: { value: 'v', ldecl: 'let v = 1;', pass: true },\n  const: { value: 'c', gdecl: 'const c = 1;', pass: true },\n  function_const: { value: 'c', ldecl: 'const c = 1;', pass: true },\n  ptr: { value: '&x', ldecl: 'var x: u32;', pass: true },\n  ptr_to_unsized: {\n    value: '&x',\n    gdecl: '@group(0) @binding(0) var<storage> x: array<u32>;',\n    pass: true,\n  },\n  indexed: {\n    value: 'x[0]',\n    gdecl: '@group(0) @binding(0) var<storage> x: array<u32>;',\n    pass: true,\n  },\n  user_fn: { value: 'f', pass: false },\n  builtin: { value: 'max', pass: false },\n  builtin_call: { value: 'max(1,1)', pass: true },\n  user_call: { value: 'callee()', pass: true, gdecl: 'fn callee() -> i32 { return 0; }' },\n  undeclared: { value: 'does_not_exist', pass: false },\n} as const;\n\ng.test('rhs_with_decl')\n  .desc(`Test rhs of 'phony assignment' involving declared objects.`)\n  .params(u => u.combine('test', keysOf(kVarCases)))\n  .fn(t => {\n    const { value, pass, gdecl, ldecl } = kVarCases[t.params.test] as Case;\n    const code = `\n${gdecl ?? ''}\n@compute @workgroup_size(1)\nfn f() {\n  ${ldecl ?? ''}\n  _ = ${value};\n}`;\n    t.expectCompileResult(pass, code);\n  });\n\nconst kTests = {\n  literal: { wgsl: `_ = 1;`, pass: true },\n  expr: { wgsl: `_ = (1+v);`, pass: true },\n  var: { wgsl: `_ = v;`, pass: true },\n\n  in_for_init: { wgsl: `for (_ = v;false;) {}`, pass: true },\n  in_for_init_semi: { wgsl: `for (_ = v;;false;) {}`, pass: false },\n  in_for_update: { wgsl: `for (;false; _ = v) {}`, pass: true },\n  in_for_update_semi: { wgsl: `for (;false; _ = v;) {}`, pass: false },\n\n  in_block: { wgsl: `{_ = v;}`, pass: true },\n  in_continuing: { wgsl: `loop { continuing { _ = v; break if true;}}`, pass: true },\n\n  in_paren: { wgsl: `(_ = v;)`, pass: false },\n\n  underscore: { wgsl: `_`, pass: false },\n  underscore_semi: { wgsl: `_;`, pass: false },\n  underscore_equal: { wgsl: `_=`, pass: false },\n  underscore_equal_semi: { wgsl: `_=;`, pass: false },\n  underscore_equal_underscore_semi: { wgsl: `_=_;`, pass: false },\n  paren_underscore_paren: { wgsl: `(_) = 1;`, pass: false },\n  // LHS is not a reference type\n  star_ampersand_undsscore: { wgsl: `*&_ = 1;`, pass: false },\n  compound: { wgsl: `_ += 1;`, pass: false },\n  equality: { wgsl: `_ == 1;`, pass: false },\n  block: { wgsl: `_ = {};`, pass: false },\n  return: { wgsl: `_ = return;`, pass: false },\n};\n\ng.test('parse')\n  .desc(`Test that 'phony assignment' statements are parsed correctly.`)\n  .params(u => u.combine('test', keysOf(kTests)))\n  .fn(t => {\n    const code = `\nfn f() {\n  var v: u32;\n  ${kTests[t.params.test].wgsl}\n}`;\n    t.expectCompileResult(kTests[t.params.test].pass, code);\n  });\n"],"mappings":"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"}