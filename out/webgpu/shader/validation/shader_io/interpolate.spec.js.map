{"version":3,"file":"interpolate.spec.js","names":["description","makeTestGroup","keysOf","ShaderValidationTest","generateShader","g","kValidCompatInterpolationAttributes","Set","kValidInterpolationAttributes","test","desc","params","u","combine","filter","t","stage","use_struct","beginSubcases","fn","interpolate","type","sampling","code","attribute","io","validInterpolationAttributes","isCompatibility","expectCompileResult","has","includes","skip","attr","kValidationTests","valid","src","pass","no_space","trailing_comma_one_arg","trailing_comma_two_arg","newline","comment","no_params","missing_left_paren","missing_value_and_left_paren","missing_right_paren","missing_parens","missing_comma","numeric","numeric_second_param"],"sources":["../../../../../src/webgpu/shader/validation/shader_io/interpolate.spec.ts"],"sourcesContent":["export const description = `Validation tests for the interpolate attribute`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nimport { generateShader } from './util.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\n// List of valid interpolation attributes.\nconst kValidCompatInterpolationAttributes = new Set([\n  '',\n  '@interpolate(flat)',\n  '@interpolate(perspective)',\n  '@interpolate(perspective, center)',\n  '@interpolate(perspective, centroid)',\n]);\nconst kValidInterpolationAttributes = new Set([\n  ...kValidCompatInterpolationAttributes,\n  '@interpolate(flat)',\n  '@interpolate(perspective)',\n  '@interpolate(perspective, center)',\n  '@interpolate(perspective, centroid)',\n  '@interpolate(perspective, sample)',\n  '@interpolate(linear)',\n  '@interpolate(linear, center)',\n  '@interpolate(linear, centroid)',\n  '@interpolate(linear, sample)',\n]);\n\ng.test('type_and_sampling')\n  .desc(`Test that all combinations of interpolation type and sampling are validated correctly.`)\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment'] as const)\n      .combine('io', ['in', 'out'] as const)\n      .combine('use_struct', [true, false] as const)\n      .combine('type', [\n        '',\n        'flat',\n        'perspective',\n        'linear',\n        'center', // Invalid as first param\n        'centroid', // Invalid as first param\n        'sample', // Invalid as first param\n      ] as const)\n      // vertex output must include a position builtin, so must use a struct\n      .filter(t => !(t.stage === 'vertex' && t.use_struct === false))\n      .combine('sampling', [\n        '',\n        'center',\n        'centroid',\n        'sample',\n        'flat', // Invalid as second param\n        'perspective', // Invalid as second param\n        'linear', // Invalid as second param\n      ] as const)\n      .beginSubcases()\n  )\n  .fn(t => {\n    let interpolate = '';\n    if (t.params.type !== '' || t.params.sampling !== '') {\n      interpolate = '@interpolate(';\n      if (t.params.type !== '') {\n        interpolate += `${t.params.type}`;\n      }\n      if (t.params.sampling !== '') {\n        interpolate += `, ${t.params.sampling}`;\n      }\n      interpolate += `)`;\n    }\n    const code = generateShader({\n      attribute: '@location(0)' + interpolate,\n      type: 'f32',\n      stage: t.params.stage,\n      io: t.params.io,\n      use_struct: t.params.use_struct,\n    });\n    const validInterpolationAttributes = t.isCompatibility\n      ? kValidCompatInterpolationAttributes\n      : kValidInterpolationAttributes;\n    t.expectCompileResult(validInterpolationAttributes.has(interpolate), code);\n  });\n\ng.test('require_location')\n  .desc(`Test that the interpolate attribute is only accepted with user-defined IO.`)\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment'] as const)\n      .combine('attribute', ['@location(0)', '@builtin(position)'] as const)\n      .combine('use_struct', [true, false] as const)\n      .beginSubcases()\n  )\n  .fn(t => {\n    if (\n      t.params.stage === 'vertex' &&\n      t.params.use_struct === false &&\n      !t.params.attribute.includes('position')\n    ) {\n      t.skip('vertex output must include a position builtin, so must use a struct');\n    }\n\n    const code = generateShader({\n      attribute: t.params.attribute + `@interpolate(flat)`,\n      type: 'vec4<f32>',\n      stage: t.params.stage,\n      io: t.params.stage === 'fragment' ? 'in' : 'out',\n      use_struct: t.params.use_struct,\n    });\n    t.expectCompileResult(t.params.attribute === '@location(0)', code);\n  });\n\ng.test('integral_types')\n  .desc(`Test that the implementation requires @interpolate(flat) for integral user-defined IO.`)\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment'] as const)\n      .combine('type', ['i32', 'u32', 'vec2<i32>', 'vec4<u32>'] as const)\n      .combine('use_struct', [true, false] as const)\n      .combine('attribute', kValidInterpolationAttributes)\n      .beginSubcases()\n  )\n  .fn(t => {\n    if (t.params.stage === 'vertex' && t.params.use_struct === false) {\n      t.skip('vertex output must include a position builtin, so must use a struct');\n    }\n\n    const code = generateShader({\n      attribute: '@location(0)' + t.params.attribute,\n      type: t.params.type,\n      stage: t.params.stage,\n      io: t.params.stage === 'vertex' ? 'out' : 'in',\n      use_struct: t.params.use_struct,\n    });\n\n    t.expectCompileResult(t.params.attribute === '@interpolate(flat)', code);\n  });\n\ng.test('duplicate')\n  .desc(`Test that the interpolate attribute can only be applied once.`)\n  .params(u => u.combine('attr', ['', '@interpolate(flat)'] as const))\n  .fn(t => {\n    const code = generateShader({\n      attribute: `@location(0) @interpolate(flat) ${t.params.attr}`,\n      type: 'vec4<f32>',\n      stage: 'fragment',\n      io: 'in',\n      use_struct: false,\n    });\n    t.expectCompileResult(t.params.attr === '', code);\n  });\n\nconst kValidationTests = {\n  valid: {\n    src: `@interpolate(flat)`,\n    pass: true,\n  },\n  no_space: {\n    src: `@interpolate(perspective,center)`,\n    pass: true,\n  },\n  trailing_comma_one_arg: {\n    src: `@interpolate(flat,)`,\n    pass: true,\n  },\n  trailing_comma_two_arg: {\n    src: `@interpolate(perspective, center,)`,\n    pass: true,\n  },\n  newline: {\n    src: '@\\ninterpolate(flat)',\n    pass: true,\n  },\n  comment: {\n    src: `@/* comment */interpolate(flat)`,\n    pass: true,\n  },\n\n  no_params: {\n    src: `@interpolate()`,\n    pass: false,\n  },\n  missing_left_paren: {\n    src: `@interpolate flat)`,\n    pass: false,\n  },\n  missing_value_and_left_paren: {\n    src: `@interpolate)`,\n    pass: false,\n  },\n  missing_right_paren: {\n    src: `@interpolate(flat`,\n    pass: false,\n  },\n  missing_parens: {\n    src: `@interpolate`,\n    pass: false,\n  },\n  missing_comma: {\n    src: `@interpolate(perspective center)`,\n    pass: false,\n  },\n  numeric: {\n    src: `@interpolate(1)`,\n    pass: false,\n  },\n  numeric_second_param: {\n    src: `@interpolate(perspective, 1)`,\n    pass: false,\n  },\n};\n\ng.test('interpolation_validation')\n  .desc(`Test validation of interpolation`)\n  .params(u => u.combine('attr', keysOf(kValidationTests)))\n  .fn(t => {\n    const code = `\n@vertex fn main(${kValidationTests[t.params.attr].src} @location(0) b: f32) ->\n    @builtin(position) vec4<f32> {\n  return vec4f(0);\n}`;\n    t.expectCompileResult(kValidationTests[t.params.attr].pass, code);\n  });\n"],"mappings":"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"}