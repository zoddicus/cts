{"version":3,"file":"create.spec.js","names":["description","makeTestGroup","assert","kAllBufferUsageBits","kBufferSizeAlignment","kBufferUsages","kLimitInfo","GPUConst","kMaxSafeMultipleOf8","ValidationTest","g","test","desc","params","u","combine","beginSubcases","fn","t","mappedAtCreation","size","isValid","usage","BufferUsage","COPY_SRC","expectGPUError","device","createBuffer","maxBufferSize","default","kInvalidUsage","usage1","usage2","GPUBufferUsage","MAP_READ","COPY_DST","MAP_WRITE","paramsSubcasesOnly","combineWithParams","_valid","UNIFORM","STORAGE"],"sources":["../../../../../src/webgpu/api/validation/buffer/create.spec.ts"],"sourcesContent":["export const description = `\nTests for validation in createBuffer.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/util/util.js';\nimport {\n  kAllBufferUsageBits,\n  kBufferSizeAlignment,\n  kBufferUsages,\n  kLimitInfo,\n} from '../../../capability_info.js';\nimport { GPUConst } from '../../../constants.js';\nimport { kMaxSafeMultipleOf8 } from '../../../util/math.js';\nimport { ValidationTest } from '../validation_test.js';\n\nexport const g = makeTestGroup(ValidationTest);\n\nassert(kBufferSizeAlignment === 4);\ng.test('size')\n  .desc(\n    'Test buffer size alignment is validated to be a multiple of 4 if mappedAtCreation is true.'\n  )\n  .params(u =>\n    u\n      .combine('mappedAtCreation', [false, true])\n      .beginSubcases()\n      .combine('size', [\n        0,\n        kBufferSizeAlignment * 0.5,\n        kBufferSizeAlignment,\n        kBufferSizeAlignment * 1.5,\n        kBufferSizeAlignment * 2,\n      ])\n  )\n  .fn(t => {\n    const { mappedAtCreation, size } = t.params;\n    const isValid = !mappedAtCreation || size % kBufferSizeAlignment === 0;\n    const usage = BufferUsage.COPY_SRC;\n    t.expectGPUError(\n      'validation',\n      () => t.device.createBuffer({ size, usage, mappedAtCreation }),\n      !isValid\n    );\n  });\n\ng.test('limit')\n  .desc('Test buffer size is validated against maxBufferSize.')\n  .params(u =>\n    u\n      .beginSubcases()\n      .combine('size', [\n        kLimitInfo.maxBufferSize.default - 1,\n        kLimitInfo.maxBufferSize.default,\n        kLimitInfo.maxBufferSize.default + 1,\n      ])\n  )\n  .fn(t => {\n    const { size } = t.params;\n    const isValid = size <= kLimitInfo.maxBufferSize.default;\n    const usage = BufferUsage.COPY_SRC;\n    t.expectGPUError('validation', () => t.device.createBuffer({ size, usage }), !isValid);\n  });\n\nconst kInvalidUsage = 0x8000;\nassert((kInvalidUsage & kAllBufferUsageBits) === 0);\ng.test('usage')\n  .desc('Test combinations of zero to two usage flags are validated to be valid.')\n  .params(u =>\n    u\n      .combine('usage1', [0, ...kBufferUsages, kInvalidUsage])\n      .combine('usage2', [0, ...kBufferUsages, kInvalidUsage])\n      .beginSubcases()\n      .combine('mappedAtCreation', [false, true])\n  )\n  .fn(t => {\n    const { mappedAtCreation, usage1, usage2 } = t.params;\n    const usage = usage1 | usage2;\n\n    const isValid =\n      usage !== 0 &&\n      (usage & ~kAllBufferUsageBits) === 0 &&\n      ((usage & GPUBufferUsage.MAP_READ) === 0 ||\n        (usage & ~(GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ)) === 0) &&\n      ((usage & GPUBufferUsage.MAP_WRITE) === 0 ||\n        (usage & ~(GPUBufferUsage.COPY_SRC | GPUBufferUsage.MAP_WRITE)) === 0);\n\n    t.expectGPUError(\n      'validation',\n      () => t.device.createBuffer({ size: kBufferSizeAlignment * 2, usage, mappedAtCreation }),\n      !isValid\n    );\n  });\n\nconst BufferUsage = GPUConst.BufferUsage;\n\ng.test('createBuffer_invalid_and_oom')\n  .desc(\n    `When creating a mappable buffer, it's expected that shmem may be immediately allocated\n(in the content process, before validation occurs in the GPU process). If the buffer is really\nlarge, though, it could fail shmem allocation before validation fails. Ensure that OOM error is\nhidden behind the \"more severe\" validation error.`\n  )\n  .paramsSubcasesOnly(u =>\n    u.combineWithParams([\n      { _valid: true, usage: BufferUsage.UNIFORM, size: 16 },\n      { _valid: true, usage: BufferUsage.STORAGE, size: 16 },\n      // Invalid because UNIFORM is not allowed with map usages.\n      { usage: BufferUsage.MAP_WRITE | BufferUsage.UNIFORM, size: 16 },\n      { usage: BufferUsage.MAP_WRITE | BufferUsage.UNIFORM, size: kMaxSafeMultipleOf8 },\n      { usage: BufferUsage.MAP_WRITE | BufferUsage.UNIFORM, size: 0x20_0000_0000 }, // 128 GiB\n      { usage: BufferUsage.MAP_READ | BufferUsage.UNIFORM, size: 16 },\n      { usage: BufferUsage.MAP_READ | BufferUsage.UNIFORM, size: kMaxSafeMultipleOf8 },\n      { usage: BufferUsage.MAP_READ | BufferUsage.UNIFORM, size: 0x20_0000_0000 }, // 128 GiB\n    ] as const)\n  )\n  .fn(t => {\n    const { _valid, usage, size } = t.params;\n\n    t.expectGPUError('validation', () => t.device.createBuffer({ size, usage }), !_valid);\n  });\n"],"mappings":"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"}