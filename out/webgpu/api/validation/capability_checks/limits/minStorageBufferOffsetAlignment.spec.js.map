{"version":3,"file":"minStorageBufferOffsetAlignment.spec.js","names":["GPUConst","isPowerOfTwo","kMinimumLimitBaseParams","makeLimitTestGroup","getDeviceLimitToRequest","limitValueTest","defaultLimit","minimumLimit","Math","log2","getTestValue","testValueName","requestedLimit","getDeviceLimitToRequestAndValueToTest","maximumLimit","testValue","limit","g","description","test","desc","params","fn","t","limitTest","adapterLimit","testDeviceWithSpecificLimits","device","shouldError","storageBuffer","trackForCleanup","createBuffer","size","usage","GPUBufferUsage","STORAGE","layout","createBindGroupLayout","entries","binding","visibility","GPUShaderStage","COMPUTE","buffer","type","expectValidationError","createBindGroup","resource","offset","ShaderStage","hasDynamicOffset","bindGroup","encoder","createCommandEncoder","pass","beginComputePass","setBindGroup","end","finish","destroy","expect"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/minStorageBufferOffsetAlignment.spec.ts"],"sourcesContent":["import { GPUConst } from '../../../../constants.js';\nimport { isPowerOfTwo } from '../../../../util/math.js';\n\nimport {\n  kMinimumLimitBaseParams,\n  makeLimitTestGroup,\n  MinimumLimitValueTest,\n  MinimumTestValue,\n} from './limit_utils.js';\n\nfunction getDeviceLimitToRequest(\n  limitValueTest: MinimumLimitValueTest,\n  defaultLimit: number,\n  minimumLimit: number\n) {\n  switch (limitValueTest) {\n    case 'atDefault':\n      return defaultLimit;\n    case 'overDefault':\n      return 2 ** (Math.log2(defaultLimit) + 1);\n    case 'betweenDefaultAndMinimum':\n      return 2 ** (((Math.log2(defaultLimit) + Math.log2(minimumLimit)) / 2) | 0);\n    case 'atMinimum':\n      return minimumLimit;\n    case 'underMinimum':\n      return 2 ** (Math.log2(minimumLimit) - 1);\n  }\n}\n\nfunction getTestValue(testValueName: MinimumTestValue, requestedLimit: number) {\n  switch (testValueName) {\n    case 'atLimit':\n      return requestedLimit;\n    case 'underLimit':\n      return 2 ** (Math.log2(requestedLimit) - 1);\n  }\n}\n\nfunction getDeviceLimitToRequestAndValueToTest(\n  limitValueTest: MinimumLimitValueTest,\n  testValueName: MinimumTestValue,\n  defaultLimit: number,\n  maximumLimit: number\n) {\n  const requestedLimit = getDeviceLimitToRequest(limitValueTest, defaultLimit, maximumLimit);\n  return {\n    requestedLimit,\n    testValue: getTestValue(testValueName, requestedLimit),\n  };\n}\n\nconst limit = 'minStorageBufferOffsetAlignment';\nexport const { g, description } = makeLimitTestGroup(limit);\n\ng.test('createBindGroup,at_over')\n  .desc(`Test using createBindGroup at and over ${limit} limit`)\n  .params(kMinimumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    // note: LimitTest.maximum is the adapter.limits[limit] value\n    const { defaultLimit, adapterLimit: minimumLimit } = t;\n    const { requestedLimit, testValue } = getDeviceLimitToRequestAndValueToTest(\n      limitTest,\n      testValueName,\n      defaultLimit,\n      minimumLimit\n    );\n\n    await t.testDeviceWithSpecificLimits(\n      requestedLimit,\n      testValue,\n      async ({ device, testValue, shouldError }) => {\n        const storageBuffer = t.trackForCleanup(\n          device.createBuffer({\n            size: testValue * 2,\n            usage: GPUBufferUsage.STORAGE,\n          })\n        );\n\n        const layout = device.createBindGroupLayout({\n          entries: [\n            {\n              binding: 0,\n              visibility: GPUShaderStage.COMPUTE,\n              buffer: { type: 'storage' },\n            },\n          ],\n        });\n\n        await t.expectValidationError(() => {\n          device.createBindGroup({\n            layout,\n            entries: [\n              {\n                binding: 0,\n                resource: {\n                  buffer: storageBuffer,\n                  offset: testValue,\n                },\n              },\n            ],\n          });\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('setBindGroup,at_over')\n  .desc(`Test using setBindGroup at and over ${limit} limit`)\n  .params(kMinimumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    // note: LimitTest.maximum is the adapter.limits[limit] value\n    const { defaultLimit, adapterLimit: minimumLimit } = t;\n    const { requestedLimit, testValue } = getDeviceLimitToRequestAndValueToTest(\n      limitTest,\n      testValueName,\n      defaultLimit,\n      minimumLimit\n    );\n\n    await t.testDeviceWithSpecificLimits(\n      requestedLimit,\n      testValue,\n      async ({ device, testValue, shouldError }) => {\n        const buffer = device.createBuffer({\n          size: testValue * 2,\n          usage: GPUBufferUsage.STORAGE,\n        });\n\n        const layout = device.createBindGroupLayout({\n          entries: [\n            {\n              binding: 0,\n              visibility: GPUConst.ShaderStage.COMPUTE,\n              buffer: {\n                type: 'storage',\n                hasDynamicOffset: true,\n              },\n            },\n          ],\n        });\n\n        const bindGroup = device.createBindGroup({\n          layout,\n          entries: [\n            {\n              binding: 0,\n              resource: {\n                buffer,\n                size: testValue / 2,\n              },\n            },\n          ],\n        });\n\n        const encoder = device.createCommandEncoder();\n        const pass = encoder.beginComputePass();\n        pass.setBindGroup(0, bindGroup, [testValue]);\n        pass.end();\n\n        await t.expectValidationError(() => {\n          encoder.finish();\n        }, shouldError);\n\n        buffer.destroy();\n      }\n    );\n  });\n\ng.test('validate,powerOf2')\n  .desc('Verify that ${limit} is power of 2')\n  .fn(t => {\n    t.expect(isPowerOfTwo(t.defaultLimit));\n    t.expect(isPowerOfTwo(t.adapterLimit));\n  });\n\ng.test('validate,greaterThanOrEqualTo32')\n  .desc('Verify that ${limit} is >= 32')\n  .fn(t => {\n    t.expect(t.defaultLimit >= 32);\n    t.expect(t.adapterLimit >= 32);\n  });\n"],"mappings":"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"}