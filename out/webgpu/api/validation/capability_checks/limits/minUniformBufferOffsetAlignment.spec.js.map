{"version":3,"file":"minUniformBufferOffsetAlignment.spec.js","names":["GPUConst","isPowerOfTwo","kMinimumLimitBaseParams","makeLimitTestGroup","getDeviceLimitToRequest","limitValueTest","defaultLimit","minimumLimit","Math","log2","min","getTestValue","testValueName","requestedLimit","getDeviceLimitToRequestAndValueToTest","maximumLimit","testValue","limit","g","description","test","desc","params","fn","t","limitTest","adapterLimit","testDeviceWithSpecificLimits","device","shouldError","buffer","createBufferTracked","size","usage","GPUBufferUsage","UNIFORM","layout","createBindGroupLayout","entries","binding","visibility","GPUShaderStage","COMPUTE","expectValidationError","createBindGroup","resource","offset","ShaderStage","type","hasDynamicOffset","bindGroup","encoder","createCommandEncoder","pass","beginComputePass","setBindGroup","end","finish","destroy","expect"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/minUniformBufferOffsetAlignment.spec.ts"],"sourcesContent":["import { GPUConst } from '../../../../constants.js';\nimport { isPowerOfTwo } from '../../../../util/math.js';\n\nimport {\n  kMinimumLimitBaseParams,\n  makeLimitTestGroup,\n  MinimumLimitValueTest,\n  MinimumTestValue,\n} from './limit_utils.js';\n\nfunction getDeviceLimitToRequest(\n  limitValueTest: MinimumLimitValueTest,\n  defaultLimit: number,\n  minimumLimit: number\n) {\n  switch (limitValueTest) {\n    case 'atDefault':\n      return defaultLimit;\n    case 'overDefault':\n      return 2 ** (Math.log2(defaultLimit) + 1);\n    case 'betweenDefaultAndMinimum':\n      return Math.min(\n        minimumLimit,\n        2 ** (((Math.log2(defaultLimit) + Math.log2(minimumLimit)) / 2) | 0)\n      );\n    case 'atMinimum':\n      return minimumLimit;\n    case 'underMinimum':\n      return 2 ** (Math.log2(minimumLimit) - 1);\n  }\n}\n\nfunction getTestValue(testValueName: MinimumTestValue, requestedLimit: number) {\n  switch (testValueName) {\n    case 'atLimit':\n      return requestedLimit;\n    case 'underLimit':\n      return 2 ** (Math.log2(requestedLimit) - 1);\n  }\n}\n\nfunction getDeviceLimitToRequestAndValueToTest(\n  limitValueTest: MinimumLimitValueTest,\n  testValueName: MinimumTestValue,\n  defaultLimit: number,\n  maximumLimit: number\n) {\n  const requestedLimit = getDeviceLimitToRequest(limitValueTest, defaultLimit, maximumLimit);\n  return {\n    requestedLimit,\n    testValue: getTestValue(testValueName, requestedLimit),\n  };\n}\n\nconst limit = 'minUniformBufferOffsetAlignment';\nexport const { g, description } = makeLimitTestGroup(limit);\n\ng.test('createBindGroup,at_over')\n  .desc(`Test using createBindGroup at and over ${limit} limit`)\n  .params(kMinimumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    // note: LimitTest.maximum is the adapter.limits[limit] value\n    const { defaultLimit, adapterLimit: minimumLimit } = t;\n    const { requestedLimit, testValue } = getDeviceLimitToRequestAndValueToTest(\n      limitTest,\n      testValueName,\n      defaultLimit,\n      minimumLimit\n    );\n\n    await t.testDeviceWithSpecificLimits(\n      requestedLimit,\n      testValue,\n      async ({ device, testValue, shouldError }) => {\n        const buffer = t.createBufferTracked({\n          size: testValue * 2,\n          usage: GPUBufferUsage.UNIFORM,\n        });\n\n        const layout = device.createBindGroupLayout({\n          entries: [\n            {\n              binding: 0,\n              visibility: GPUShaderStage.COMPUTE,\n              buffer: {},\n            },\n          ],\n        });\n\n        await t.expectValidationError(() => {\n          device.createBindGroup({\n            layout,\n            entries: [\n              {\n                binding: 0,\n                resource: {\n                  buffer,\n                  offset: testValue,\n                },\n              },\n            ],\n          });\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('setBindGroup,at_over')\n  .desc(`Test using setBindGroup at and over ${limit} limit`)\n  .params(kMinimumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    // note: LimitTest.maximum is the adapter.limits[limit] value\n    const { defaultLimit, adapterLimit: minimumLimit } = t;\n    const { requestedLimit, testValue } = getDeviceLimitToRequestAndValueToTest(\n      limitTest,\n      testValueName,\n      defaultLimit,\n      minimumLimit\n    );\n\n    await t.testDeviceWithSpecificLimits(\n      requestedLimit,\n      testValue,\n      async ({ device, testValue, shouldError }) => {\n        const buffer = t.createBufferTracked({\n          size: testValue * 2,\n          usage: GPUBufferUsage.UNIFORM,\n        });\n\n        const layout = device.createBindGroupLayout({\n          entries: [\n            {\n              binding: 0,\n              visibility: GPUConst.ShaderStage.COMPUTE,\n              buffer: {\n                type: 'uniform',\n                hasDynamicOffset: true,\n              },\n            },\n          ],\n        });\n\n        const bindGroup = device.createBindGroup({\n          layout,\n          entries: [\n            {\n              binding: 0,\n              resource: {\n                buffer,\n                size: testValue / 2,\n              },\n            },\n          ],\n        });\n\n        const encoder = device.createCommandEncoder();\n        const pass = encoder.beginComputePass();\n        pass.setBindGroup(0, bindGroup, [testValue]);\n        pass.end();\n\n        await t.expectValidationError(() => {\n          encoder.finish();\n        }, shouldError);\n\n        buffer.destroy();\n      }\n    );\n  });\n\ng.test('validate,powerOf2')\n  .desc('Verify that ${limit} is power of 2')\n  .fn(t => {\n    t.expect(isPowerOfTwo(t.defaultLimit));\n    t.expect(isPowerOfTwo(t.adapterLimit));\n  });\n\ng.test('validate,greaterThanOrEqualTo32')\n  .desc('Verify that ${limit} is >= 32')\n  .fn(t => {\n    t.expect(t.defaultLimit >= 32);\n    t.expect(t.adapterLimit >= 32);\n  });\n"],"mappings":"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"}