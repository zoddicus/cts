{"version":3,"file":"maxColorAttachments.spec.js","names":["range","kMaximumLimitBaseParams","getDefaultLimit","makeLimitTestGroup","getPipelineDescriptor","device","testValue","code","module","createShaderModule","layout","vertex","entryPoint","fragment","targets","Array","fill","format","writeMask","limit","g","description","test","desc","params","combine","fn","t","limitTest","testValueName","async","testDeviceWithRequestedMaximumLimits","shouldError","pipelineDescriptor","testCreateRenderPipeline","encoder","createCommandEncoder","textures","_","trackForCleanup","createTexture","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","pass","beginRenderPass","colorAttachments","i","view","createView","loadOp","storeOp","end","expectValidationError","finish","createRenderBundleEncoder","colorFormats","adapter","defaultLimit","adapterLimit","maximumLimit","minColorAttachmentBytesPerSample","expect","limits","maxColorAttachmentBytesPerSample"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/maxColorAttachments.spec.ts"],"sourcesContent":["import { range } from '../../../../../common/util/util.js';\n\nimport { kMaximumLimitBaseParams, getDefaultLimit, makeLimitTestGroup } from './limit_utils.js';\n\nfunction getPipelineDescriptor(device: GPUDevice, testValue: number): GPURenderPipelineDescriptor {\n  const code = `\n    @vertex fn vs() -> @builtin(position) vec4f {\n      return vec4f(0);\n    }\n\n    @fragment fn fs() -> @location(0) vec4f {\n      return vec4f(0);\n    }\n  `;\n  const module = device.createShaderModule({ code });\n  return {\n    layout: 'auto',\n    vertex: {\n      module,\n      entryPoint: 'vs',\n    },\n    fragment: {\n      module,\n      entryPoint: 'fs',\n      targets: new Array(testValue).fill({ format: 'r8unorm', writeMask: 0 }),\n    },\n  };\n}\n\nconst limit = 'maxColorAttachments';\nexport const { g, description } = makeLimitTestGroup(limit);\n\ng.test('createRenderPipeline,at_over')\n  .desc(`Test using at and over ${limit} limit in createRenderPipeline(Async)`)\n  .params(kMaximumLimitBaseParams.combine('async', [false, true] as const))\n  .fn(async t => {\n    const { limitTest, testValueName, async } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const pipelineDescriptor = getPipelineDescriptor(device, testValue);\n\n        await t.testCreateRenderPipeline(pipelineDescriptor, async, shouldError);\n      }\n    );\n  });\n\ng.test('beginRenderPass,at_over')\n  .desc(`Test using at and over ${limit} limit in beginRenderPass`)\n  .params(kMaximumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const encoder = device.createCommandEncoder();\n\n        const textures = range(testValue, _ =>\n          t.trackForCleanup(\n            device.createTexture({\n              size: [1, 1],\n              format: 'r8unorm',\n              usage: GPUTextureUsage.RENDER_ATTACHMENT,\n            })\n          )\n        );\n\n        const pass = encoder.beginRenderPass({\n          colorAttachments: range(testValue, i => ({\n            view: textures[i].createView(),\n            loadOp: 'clear',\n            storeOp: 'store',\n          })),\n        });\n        pass.end();\n\n        await t.expectValidationError(() => {\n          encoder.finish();\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('createRenderBundle,at_over')\n  .desc(`Test using at and over ${limit} limit in createRenderBundle`)\n  .params(kMaximumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        await t.expectValidationError(() => {\n          device.createRenderBundleEncoder({\n            colorFormats: new Array(testValue).fill('r8unorm'),\n          });\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('validate,maxColorAttachmentBytesPerSample')\n  .desc(`Test ${limit} against maxColorAttachmentBytesPerSample`)\n  .fn(t => {\n    const { adapter, defaultLimit, adapterLimit: maximumLimit } = t;\n    const minColorAttachmentBytesPerSample = getDefaultLimit('maxColorAttachmentBytesPerSample');\n    // The smallest attachment is 1 byte\n    // so make sure maxColorAttachments < maxColorAttachmentBytesPerSample\n    t.expect(defaultLimit <= minColorAttachmentBytesPerSample);\n    t.expect(maximumLimit <= adapter.limits.maxColorAttachmentBytesPerSample);\n  });\n"],"mappings":"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"}