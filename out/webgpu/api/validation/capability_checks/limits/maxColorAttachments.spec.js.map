{"version":3,"file":"maxColorAttachments.spec.js","names":["range","kMaxColorAttachmentsToTest","kMaximumLimitBaseParams","makeLimitTestGroup","getPipelineDescriptor","device","testValue","code","module","createShaderModule","layout","vertex","entryPoint","fragment","targets","Array","fill","format","writeMask","limit","g","description","test","desc","params","combine","fn","t","limitTest","testValueName","async","testDeviceWithRequestedMaximumLimits","shouldError","pipelineDescriptor","testCreateRenderPipeline","encoder","createCommandEncoder","textures","_","createTextureTracked","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","pass","beginRenderPass","colorAttachments","i","view","createView","loadOp","storeOp","end","expectValidationError","finish","createRenderBundleEncoder","colorFormats","adapter","defaultLimit","adapterLimit","maximumLimit","minColorAttachmentBytesPerSample","getDefaultLimit","expect","limits","maxColorAttachmentBytesPerSample","maxColorAttachments"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/maxColorAttachments.spec.ts"],"sourcesContent":["import { range } from '../../../../../common/util/util.js';\nimport { kMaxColorAttachmentsToTest } from '../../../../capability_info.js';\n\nimport { kMaximumLimitBaseParams, makeLimitTestGroup } from './limit_utils.js';\n\nfunction getPipelineDescriptor(device: GPUDevice, testValue: number): GPURenderPipelineDescriptor {\n  const code = `\n    @vertex fn vs() -> @builtin(position) vec4f {\n      return vec4f(0);\n    }\n\n    @fragment fn fs() -> @location(0) vec4f {\n      return vec4f(0);\n    }\n  `;\n  const module = device.createShaderModule({ code });\n  return {\n    layout: 'auto',\n    vertex: {\n      module,\n      entryPoint: 'vs',\n    },\n    fragment: {\n      module,\n      entryPoint: 'fs',\n      targets: new Array(testValue).fill({ format: 'r8unorm', writeMask: 0 }),\n    },\n  };\n}\n\nconst limit = 'maxColorAttachments';\nexport const { g, description } = makeLimitTestGroup(limit);\n\ng.test('createRenderPipeline,at_over')\n  .desc(`Test using at and over ${limit} limit in createRenderPipeline(Async)`)\n  .params(kMaximumLimitBaseParams.combine('async', [false, true] as const))\n  .fn(async t => {\n    const { limitTest, testValueName, async } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const pipelineDescriptor = getPipelineDescriptor(device, testValue);\n\n        await t.testCreateRenderPipeline(pipelineDescriptor, async, shouldError);\n      }\n    );\n  });\n\ng.test('beginRenderPass,at_over')\n  .desc(`Test using at and over ${limit} limit in beginRenderPass`)\n  .params(kMaximumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const encoder = device.createCommandEncoder();\n\n        const textures = range(testValue, _ =>\n          t.createTextureTracked({\n            size: [1, 1],\n            format: 'r8unorm',\n            usage: GPUTextureUsage.RENDER_ATTACHMENT,\n          })\n        );\n\n        const pass = encoder.beginRenderPass({\n          colorAttachments: range(testValue, i => ({\n            view: textures[i].createView(),\n            loadOp: 'clear',\n            storeOp: 'store',\n          })),\n        });\n        pass.end();\n\n        await t.expectValidationError(() => {\n          encoder.finish();\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('createRenderBundle,at_over')\n  .desc(`Test using at and over ${limit} limit in createRenderBundle`)\n  .params(kMaximumLimitBaseParams)\n  .fn(async t => {\n    const { limitTest, testValueName } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        await t.expectValidationError(() => {\n          device.createRenderBundleEncoder({\n            colorFormats: new Array(testValue).fill('r8unorm'),\n          });\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('validate,maxColorAttachmentBytesPerSample')\n  .desc(`Test ${limit} against maxColorAttachmentBytesPerSample`)\n  .fn(t => {\n    const { adapter, defaultLimit, adapterLimit: maximumLimit } = t;\n    const minColorAttachmentBytesPerSample = t.getDefaultLimit('maxColorAttachmentBytesPerSample');\n    // The smallest attachment is 1 byte\n    // so make sure maxColorAttachments < maxColorAttachmentBytesPerSample\n    t.expect(defaultLimit <= minColorAttachmentBytesPerSample);\n    t.expect(maximumLimit <= adapter.limits.maxColorAttachmentBytesPerSample);\n  });\n\ng.test('validate,kMaxColorAttachmentsToTest')\n  .desc(\n    `\n    Tests that kMaxColorAttachmentsToTest is large enough to test the limits of this device\n  `\n  )\n  .fn(t => {\n    t.expect(t.adapter.limits.maxColorAttachments <= kMaxColorAttachmentsToTest);\n  });\n"],"mappings":"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"}