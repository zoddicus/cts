{"version":3,"file":"encoder_state.spec.js","names":["description","makeTestGroup","objectEquals","ValidationTest","F","beginRenderPass","commandEncoder","view","colorAttachments","clearValue","r","g","b","a","loadOp","storeOp","createAttachmentTextureView","texture","device","createTexture","format","size","width","height","depthOrArrayLayers","usage","GPUTextureUsage","RENDER_ATTACHMENT","trackForCleanup","createView","test","desc","params","u","combine","beginSubcases","unless","p","firstPassEnd","endPasses","includes","fn","t","pass0Type","pass1Type","encoder","createCommandEncoder","firstPass","beginComputePass","end","secondPass","passes","index","valid","expectValidationError","finish","prePassType","IsEncoderFinished","callCmd","pass","insertDebugMarker","paramsSubcasesOnly","passType","endCount","i","filter","endTwice","secondEndInAnotherPass","pass1"],"sources":["../../../../../src/webgpu/api/validation/encoding/encoder_state.spec.ts"],"sourcesContent":["export const description = `\nTODO:\n- createCommandEncoder\n- non-pass command, or beginPass, during {render, compute} pass\n- {before (control case), after} finish()\n    - x= {finish(), ... all non-pass commands}\n- {before (control case), after} end()\n    - x= {render, compute} pass\n    - x= {finish(), ... all relevant pass commands}\n    - x= {\n        - before endPass (control case)\n        - after endPass (no pass open)\n        - after endPass+beginPass (a new pass of the same type is open)\n        - }\n    - should make whole encoder invalid\n- ?\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { objectEquals } from '../../../../common/util/util.js';\nimport { ValidationTest } from '../validation_test.js';\n\nclass F extends ValidationTest {\n  beginRenderPass(commandEncoder: GPUCommandEncoder, view: GPUTextureView): GPURenderPassEncoder {\n    return commandEncoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view,\n          clearValue: { r: 1.0, g: 0.0, b: 0.0, a: 1.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n  }\n\n  createAttachmentTextureView(): GPUTextureView {\n    const texture = this.device.createTexture({\n      format: 'rgba8unorm',\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      usage: GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n    this.trackForCleanup(texture);\n    return texture.createView();\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('pass_end_invalid_order')\n  .desc(\n    `\n  Test that beginning a {compute,render} pass before ending the previous {compute,render} pass\n  causes an error.\n  `\n  )\n  .params(u =>\n    u\n      .combine('pass0Type', ['compute', 'render'])\n      .combine('pass1Type', ['compute', 'render'])\n      .beginSubcases()\n      .combine('firstPassEnd', [true, false])\n      .combine('endPasses', [[], [0], [1], [0, 1], [1, 0]])\n      // Don't end the first pass multiple times (that generates a validation error but doesn't invalidate the encoder)\n      .unless(p => p.firstPassEnd && p.endPasses.includes(0))\n  )\n  .fn(t => {\n    const { pass0Type, pass1Type, firstPassEnd, endPasses } = t.params;\n\n    const view = t.createAttachmentTextureView();\n    const encoder = t.device.createCommandEncoder();\n\n    const firstPass =\n      pass0Type === 'compute' ? encoder.beginComputePass() : t.beginRenderPass(encoder, view);\n\n    if (firstPassEnd) firstPass.end();\n\n    // Begin a second pass before ending the previous pass.\n    const secondPass =\n      pass1Type === 'compute' ? encoder.beginComputePass() : t.beginRenderPass(encoder, view);\n\n    const passes = [firstPass, secondPass];\n    for (const index of endPasses) {\n      passes[index].end();\n    }\n\n    // If {endPasses} is '[1]' and {firstPass} ends, it's a control case.\n    const valid = firstPassEnd && objectEquals(endPasses, [1]);\n\n    t.expectValidationError(() => {\n      encoder.finish();\n    }, !valid);\n  });\n\ng.test('call_after_successful_finish')\n  .desc(`Test that encoding command after a successful finish generates a validation error.`)\n  .params(u =>\n    u\n      .combine('callCmd', ['beginComputePass', 'beginRenderPass', 'insertDebugMarker'])\n      .beginSubcases()\n      .combine('prePassType', ['compute', 'render', 'no-op'])\n      .combine('IsEncoderFinished', [false, true])\n  )\n  .fn(t => {\n    const { prePassType, IsEncoderFinished, callCmd } = t.params;\n\n    const view = t.createAttachmentTextureView();\n    const encoder = t.device.createCommandEncoder();\n\n    if (prePassType !== 'no-op') {\n      const pass =\n        prePassType === 'compute' ? encoder.beginComputePass() : t.beginRenderPass(encoder, view);\n      pass.end();\n    }\n\n    if (IsEncoderFinished) {\n      encoder.finish();\n    }\n\n    switch (callCmd) {\n      case 'beginComputePass':\n        {\n          let pass: GPUComputePassEncoder;\n          t.expectValidationError(() => {\n            pass = encoder.beginComputePass();\n          }, IsEncoderFinished);\n          t.expectValidationError(() => {\n            pass.end();\n          }, IsEncoderFinished);\n        }\n        break;\n      case 'beginRenderPass':\n        {\n          let pass: GPURenderPassEncoder;\n          t.expectValidationError(() => {\n            pass = t.beginRenderPass(encoder, view);\n          }, IsEncoderFinished);\n          t.expectValidationError(() => {\n            pass.end();\n          }, IsEncoderFinished);\n        }\n        break;\n      case 'insertDebugMarker':\n        t.expectValidationError(() => {\n          encoder.insertDebugMarker('');\n        }, IsEncoderFinished);\n        break;\n    }\n\n    if (!IsEncoderFinished) {\n      encoder.finish();\n    }\n  });\n\ng.test('pass_end_none')\n  .desc(\n    `\n  Test that ending a {compute,render} pass without ending the passes generates a validation error.\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('passType', ['compute', 'render']).combine('endCount', [0, 1]))\n  .fn(t => {\n    const { passType, endCount } = t.params;\n\n    const view = t.createAttachmentTextureView();\n    const encoder = t.device.createCommandEncoder();\n\n    const pass =\n      passType === 'compute' ? encoder.beginComputePass() : t.beginRenderPass(encoder, view);\n\n    for (let i = 0; i < endCount; ++i) {\n      pass.end();\n    }\n\n    t.expectValidationError(() => {\n      encoder.finish();\n    }, endCount === 0);\n  });\n\ng.test('pass_end_twice,basic')\n  .desc(\n    'Test that ending a {compute,render} pass twice generates a validation error. The parent encoder (command encoder) can be either locked or open.'\n  )\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('passType', ['compute', 'render'])\n      // Simply end twice, the parent encoder is open at that time. If the second pass end is in the middle of another pass, the parent encoder is locked. It should generate a validation error in either situation.\n      .combine('endTwice', [false, true])\n      .combine('secondEndInAnotherPass', [false, 'compute', 'render'])\n      .filter(p => p.endTwice || !p.secondEndInAnotherPass)\n  )\n  .fn(t => {\n    const { passType, endTwice, secondEndInAnotherPass } = t.params;\n\n    const view = t.createAttachmentTextureView();\n    const encoder = t.device.createCommandEncoder();\n\n    const pass =\n      passType === 'compute' ? encoder.beginComputePass() : t.beginRenderPass(encoder, view);\n\n    pass.end();\n\n    if (secondEndInAnotherPass) {\n      const pass1 =\n        secondEndInAnotherPass === 'compute'\n          ? encoder.beginComputePass()\n          : t.beginRenderPass(encoder, view);\n\n      t.expectValidationError(() => {\n        pass.end();\n      });\n\n      pass1.end();\n    } else {\n      if (endTwice) {\n        t.expectValidationError(() => {\n          pass.end();\n        });\n      }\n    }\n\n    encoder.finish();\n  });\n\ng.test('pass_end_twice,render_pass_invalid')\n  .desc(\n    'Test that ending a render pass twice generates a validation error even if the pass is invalid.'\n  )\n  .paramsSubcasesOnly(u => u.combine('endTwice', [false, true]))\n  .fn(t => {\n    const { endTwice } = t.params;\n\n    const encoder = t.device.createCommandEncoder();\n    // Pass encoder creation will fail because both color and depth/stencil attachments are empty.\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [],\n    });\n\n    pass.end();\n\n    if (endTwice) {\n      t.expectValidationError(() => {\n        pass.end();\n      });\n    }\n\n    t.expectValidationError(() => {\n      encoder.finish();\n    });\n  });\n"],"mappings":"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"}