{"version":3,"file":"resolveQuerySet.spec.js","names":["description","makeTestGroup","GPUConst","kResourceStates","ValidationTest","g","kQueryCount","test","desc","params","u","combine","fn","t","querySetState","destinationState","shouldBeValid","shouldSubmitSuccess","querySet","createQuerySetWithState","destination","createBufferWithState","size","usage","GPUBufferUsage","QUERY_RESOLVE","encoder","createEncoder","resolveQuerySet","validateFinishAndSubmit","paramsSubcasesOnly","firstQuery","queryCount","device","createQuerySet","type","count","createBuffer","validateFinish","BufferUsage","STORAGE","bufferUsage","destinationOffset","combineWithParams","bufferSize","_success","querySetMismatched","bufferMismatched","beforeAllSubcases","selectMismatchedDeviceOrSkipTestCase","undefined","querySetDevice","mismatchedDevice","trackForCleanup","bufferDevice","buffer"],"sources":["../../../../../../src/webgpu/api/validation/encoding/queries/resolveQuerySet.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for resolveQuerySet.\n`;\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { GPUConst } from '../../../../constants.js';\nimport { kResourceStates } from '../../../../gpu_test.js';\nimport { ValidationTest } from '../../validation_test.js';\n\nexport const g = makeTestGroup(ValidationTest);\n\nexport const kQueryCount = 2;\n\ng.test('queryset_and_destination_buffer_state')\n  .desc(\n    `\nTests that resolve query set must be with valid query set and destination buffer.\n- {invalid, destroyed} GPUQuerySet results in validation error.\n- {invalid, destroyed} destination buffer results in validation error.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('querySetState', kResourceStates)\n      .combine('destinationState', kResourceStates)\n  )\n  .fn(t => {\n    const { querySetState, destinationState } = t.params;\n\n    const shouldBeValid = querySetState !== 'invalid' && destinationState !== 'invalid';\n    const shouldSubmitSuccess = querySetState === 'valid' && destinationState === 'valid';\n\n    const querySet = t.createQuerySetWithState(querySetState);\n\n    const destination = t.createBufferWithState(destinationState, {\n      size: kQueryCount * 8,\n      usage: GPUBufferUsage.QUERY_RESOLVE,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.resolveQuerySet(querySet, 0, 1, destination, 0);\n    encoder.validateFinishAndSubmit(shouldBeValid, shouldSubmitSuccess);\n  });\n\ng.test('first_query_and_query_count')\n  .desc(\n    `\nTests that resolve query set with invalid firstQuery and queryCount:\n- firstQuery and/or queryCount out of range\n  `\n  )\n  .paramsSubcasesOnly([\n    { firstQuery: 0, queryCount: kQueryCount }, // control case\n    { firstQuery: 0, queryCount: kQueryCount + 1 },\n    { firstQuery: 1, queryCount: kQueryCount },\n    { firstQuery: kQueryCount, queryCount: 1 },\n  ])\n  .fn(t => {\n    const { firstQuery, queryCount } = t.params;\n\n    const querySet = t.device.createQuerySet({ type: 'occlusion', count: kQueryCount });\n    const destination = t.device.createBuffer({\n      size: kQueryCount * 8,\n      usage: GPUBufferUsage.QUERY_RESOLVE,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.resolveQuerySet(querySet, firstQuery, queryCount, destination, 0);\n    encoder.validateFinish(firstQuery + queryCount <= kQueryCount);\n  });\n\ng.test('destination_buffer_usage')\n  .desc(\n    `\nTests that resolve query set with invalid destinationBuffer:\n- Buffer usage {with, without} QUERY_RESOLVE\n  `\n  )\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('bufferUsage', [\n        GPUConst.BufferUsage.STORAGE,\n        GPUConst.BufferUsage.QUERY_RESOLVE, // control case\n      ] as const)\n  )\n  .fn(t => {\n    const querySet = t.device.createQuerySet({ type: 'occlusion', count: kQueryCount });\n    const destination = t.device.createBuffer({\n      size: kQueryCount * 8,\n      usage: t.params.bufferUsage,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.resolveQuerySet(querySet, 0, kQueryCount, destination, 0);\n    encoder.validateFinish(t.params.bufferUsage === GPUConst.BufferUsage.QUERY_RESOLVE);\n  });\n\ng.test('destination_offset_alignment')\n  .desc(\n    `\nTests that resolve query set with invalid destinationOffset:\n- destinationOffset is not a multiple of 256\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('destinationOffset', [0, 128, 256, 384]))\n  .fn(t => {\n    const { destinationOffset } = t.params;\n    const querySet = t.device.createQuerySet({ type: 'occlusion', count: kQueryCount });\n    const destination = t.device.createBuffer({\n      size: 512,\n      usage: GPUBufferUsage.QUERY_RESOLVE,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.resolveQuerySet(querySet, 0, kQueryCount, destination, destinationOffset);\n    encoder.validateFinish(destinationOffset % 256 === 0);\n  });\n\ng.test('resolve_buffer_oob')\n  .desc(\n    `\nTests that resolve query set with the size oob:\n- The size of destinationBuffer - destinationOffset < queryCount * 8\n  `\n  )\n  .paramsSubcasesOnly(u =>\n    u.combineWithParams([\n      { queryCount: 2, bufferSize: 16, destinationOffset: 0, _success: true },\n      { queryCount: 3, bufferSize: 16, destinationOffset: 0, _success: false },\n      { queryCount: 2, bufferSize: 16, destinationOffset: 256, _success: false },\n      { queryCount: 2, bufferSize: 272, destinationOffset: 256, _success: true },\n      { queryCount: 2, bufferSize: 264, destinationOffset: 256, _success: false },\n    ])\n  )\n  .fn(t => {\n    const { queryCount, bufferSize, destinationOffset, _success } = t.params;\n    const querySet = t.device.createQuerySet({ type: 'occlusion', count: queryCount });\n    const destination = t.device.createBuffer({\n      size: bufferSize,\n      usage: GPUBufferUsage.QUERY_RESOLVE,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.resolveQuerySet(querySet, 0, queryCount, destination, destinationOffset);\n    encoder.validateFinish(_success);\n  });\n\ng.test('query_set_buffer,device_mismatch')\n  .desc(\n    'Tests resolveQuerySet cannot be called with a query set or destination buffer created from another device'\n  )\n  .paramsSubcasesOnly([\n    { querySetMismatched: false, bufferMismatched: false }, // control case\n    { querySetMismatched: true, bufferMismatched: false },\n    { querySetMismatched: false, bufferMismatched: true },\n  ] as const)\n  .beforeAllSubcases(t => {\n    t.selectMismatchedDeviceOrSkipTestCase(undefined);\n  })\n  .fn(t => {\n    const { querySetMismatched, bufferMismatched } = t.params;\n\n    const kQueryCount = 1;\n\n    const querySetDevice = querySetMismatched ? t.mismatchedDevice : t.device;\n    const querySet = querySetDevice.createQuerySet({\n      type: 'occlusion',\n      count: kQueryCount,\n    });\n    t.trackForCleanup(querySet);\n\n    const bufferDevice = bufferMismatched ? t.mismatchedDevice : t.device;\n    const buffer = bufferDevice.createBuffer({\n      size: kQueryCount * 8,\n      usage: GPUBufferUsage.QUERY_RESOLVE,\n    });\n    t.trackForCleanup(buffer);\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.resolveQuerySet(querySet, 0, kQueryCount, buffer, 0);\n    encoder.validateFinish(!(querySetMismatched || bufferMismatched));\n  });\n"],"mappings":"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"}