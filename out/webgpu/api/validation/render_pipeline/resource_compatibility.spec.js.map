{"version":3,"file":"resource_compatibility.spec.js","names":["description","makeTestGroup","keysOf","kAPIResources","getWGSLShaderForResource","getAPIBindGroupLayoutForResource","doResourcesMatch","CreateRenderPipelineValidationTest","g","test","desc","params","u","combine","filter","t","res","apiResource","stage","buffer","type","storageTexture","access","beginSubcases","fn","wgslResource","skipIf","undefined","hasLanguageFeature","emptyVS","emptyFS","code","vsCode","fsCode","gpuStage","GPUShaderStage","VERTEX","FRAGMENT","layout","device","createPipelineLayout","bindGroupLayouts","descriptor","vertex","module","createShaderModule","entryPoint","fragment","targets","format","doCreateRenderPipelineTest","isAsync"],"sources":["../../../../../src/webgpu/api/validation/render_pipeline/resource_compatibility.spec.ts"],"sourcesContent":["export const description = `\nTests for resource compatibilty between pipeline layout and shader modules\n  `;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport {\n  kAPIResources,\n  getWGSLShaderForResource,\n  getAPIBindGroupLayoutForResource,\n  doResourcesMatch,\n} from '../utils.js';\n\nimport { CreateRenderPipelineValidationTest } from './common.js';\n\nexport const g = makeTestGroup(CreateRenderPipelineValidationTest);\n\ng.test('resource_compatibility')\n  .desc(\n    'Tests validation of resource (bind group) compatibility between pipeline layout and WGSL shader'\n  )\n  .params(u =>\n    u //\n      .combine('stage', ['vertex', 'fragment'] as const)\n      .combine('apiResource', keysOf(kAPIResources))\n      .filter(t => {\n        const res = kAPIResources[t.apiResource];\n        if (t.stage === 'vertex') {\n          if (res.buffer && res.buffer.type === 'storage') {\n            return false;\n          }\n          if (res.storageTexture && res.storageTexture.access !== 'read-only') {\n            return false;\n          }\n        }\n        return true;\n      })\n      .beginSubcases()\n      .combine('isAsync', [true, false] as const)\n      .combine('wgslResource', keysOf(kAPIResources))\n  )\n  .fn(t => {\n    const apiResource = kAPIResources[t.params.apiResource];\n    const wgslResource = kAPIResources[t.params.wgslResource];\n    t.skipIf(\n      wgslResource.storageTexture !== undefined &&\n        wgslResource.storageTexture.access !== 'write-only' &&\n        !t.hasLanguageFeature('readonly_and_readwrite_storage_textures'),\n      'Storage textures require language feature'\n    );\n    t.skipIf(\n      t.params.stage === 'vertex' &&\n        ((wgslResource.buffer !== undefined && wgslResource.buffer.type === 'storage') ||\n          (wgslResource.storageTexture !== undefined &&\n            wgslResource.storageTexture.access !== 'read-only')),\n      'Storage buffers and textures cannot be used in vertex shaders'\n    );\n    const emptyVS = `\n@vertex\nfn main() -> @builtin(position) vec4f {\n  return vec4f();\n}\n`;\n    const emptyFS = `\n@fragment\nfn main() -> @location(0) vec4f {\n  return vec4f();\n}\n`;\n\n    const code = getWGSLShaderForResource(t.params.stage, wgslResource);\n    const vsCode = t.params.stage === 'vertex' ? code : emptyVS;\n    const fsCode = t.params.stage === 'fragment' ? code : emptyFS;\n    const gpuStage: GPUShaderStageFlags =\n      t.params.stage === 'vertex' ? GPUShaderStage.VERTEX : GPUShaderStage.FRAGMENT;\n    const layout = t.device.createPipelineLayout({\n      bindGroupLayouts: [getAPIBindGroupLayoutForResource(t.device, gpuStage, apiResource)],\n    });\n\n    const descriptor = {\n      layout,\n      vertex: {\n        module: t.device.createShaderModule({\n          code: vsCode,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: t.device.createShaderModule({\n          code: fsCode,\n        }),\n        entryPoint: 'main',\n        targets: [{ format: 'rgba8unorm' }] as const,\n      },\n    };\n\n    t.doCreateRenderPipelineTest(\n      t.params.isAsync,\n      doResourcesMatch(apiResource, wgslResource),\n      descriptor\n    );\n  });\n"],"mappings":"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"}