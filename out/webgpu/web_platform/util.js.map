{"version":3,"file":"util.js","names":["SkipTestCase","getResourcePath","keysOf","timeout","ErrorWithExtra","raceWithRejectOnTimeout","srgbToDisplayP3","convertToUnorm8","expectation","rgba8Unorm","Uint8ClampedArray","Math","round","R","G","B","A","Uint8Array","buffer","kBt601PixelValue","srgb","red","green","blue","yellow","kBt709PixelValue","videoTable","table","Object","fromEntries","entries","map","k","row","kVideoInfo","mimeType","presentColors","topLeftColor","topRightColor","bottomLeftColor","bottomRightColor","kVideoNames","kPredefinedColorSpace","startPlayingAndWaitForVideo","video","callback","Promise","resolve","reject","callbackAndResolve","ex","error","message","addEventListener","event","requestVideoFrameCallback","timeWatcher","currentTime","requestAnimationFrame","loop","muted","preload","play","catch","waitForNextTask","promise","callbackHelper","waitForNextFrame","getVideoFrameFromVideoElement","test","captureStream","undefined","skip","videoTrack","getVideoTracks","trackProcessor","MediaStreamTrackProcessor","track","transformer","TransformStream","transform","videoFrame","_controller","stop","flush","controller","terminate","trackGenerator","MediaStreamTrackGenerator","kind","readable","pipeThrough","pipeTo","writable","getVideoElement","t","videoName","HTMLVideoElement","videoElement","document","createElement","videoInfo","canPlayType","videoUrl","src","timeoutMessage","promiseWithoutTimeout"],"sources":["../../../src/webgpu/web_platform/util.ts"],"sourcesContent":["import { Fixture, SkipTestCase } from '../../common/framework/fixture.js';\nimport { getResourcePath } from '../../common/framework/resources.js';\nimport { keysOf } from '../../common/util/data_tables.js';\nimport { timeout } from '../../common/util/timeout.js';\nimport { ErrorWithExtra, raceWithRejectOnTimeout } from '../../common/util/util.js';\nimport { GPUTest } from '../gpu_test.js';\nimport { RGBA, srgbToDisplayP3 } from '../util/color_space_conversion.js';\n\ndeclare global {\n  interface HTMLMediaElement {\n    // Add captureStream() support for HTMLMediaElement from\n    // https://w3c.github.io/mediacapture-fromelement/#dom-htmlmediaelement-capturestream\n    captureStream(): MediaStream;\n  }\n}\n\n// MAINTENANCE_TODO: Uses raw floats as expectation in external_texture related cases has some diffs.\n// Remove this conversion utils and uses raw float data as expectation in external_textrue\n// related cases when resolve this.\nexport function convertToUnorm8(expectation: Readonly<RGBA>): Uint8Array {\n  const rgba8Unorm = new Uint8ClampedArray(4);\n  rgba8Unorm[0] = Math.round(expectation.R * 255.0);\n  rgba8Unorm[1] = Math.round(expectation.G * 255.0);\n  rgba8Unorm[2] = Math.round(expectation.B * 255.0);\n  rgba8Unorm[3] = Math.round(expectation.A * 255.0);\n\n  return new Uint8Array(rgba8Unorm.buffer);\n}\n\n// MAINTENANCE_TODO: Add helper function for BT.601 and BT.709 to remove all magic numbers.\n// Expectation values about converting video contents to sRGB color space.\n// Source video color space affects expected values.\n// The process to calculate these expected pixel values can be found:\n// https://github.com/gpuweb/cts/pull/2242#issuecomment-1430382811\n// and https://github.com/gpuweb/cts/pull/2242#issuecomment-1463273434\nconst kBt601PixelValue = {\n  srgb: {\n    red: { R: 0.972945567233341, G: 0.141794376683341, B: -0.0209589916711088, A: 1.0 },\n    green: { R: 0.248234279433399, G: 0.984810378661784, B: -0.0564701319494314, A: 1.0 },\n    blue: { R: 0.10159735826538, G: 0.135451122863674, B: 1.00262982899724, A: 1.0 },\n    yellow: { R: 0.995470750775951, G: 0.992742114518355, B: -0.0701036235167653, A: 1.0 },\n  },\n} as const;\n\nconst kBt709PixelValue = {\n  srgb: {\n    red: { R: 1.0, G: 0.0, B: 0.0, A: 1.0 },\n    green: { R: 0.0, G: 1.0, B: 0.0, A: 1.0 },\n    blue: { R: 0.0, G: 0.0, B: 1.0, A: 1.0 },\n    yellow: { R: 1.0, G: 1.0, B: 0.0, A: 1.0 },\n  },\n} as const;\n\nfunction videoTable<Table extends { readonly [K: string]: {} }>({\n  table,\n}: {\n  table: Table;\n}): {\n  readonly [F in keyof Table]: {\n    readonly [K in keyof Table[F]]: Table[F][K];\n  };\n} {\n  return Object.fromEntries(\n    Object.entries(table).map(([k, row]) => [k, { ...row }])\n    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n  ) as any;\n}\n\n// MAINTENANCE_TODO: Add BT.2020 video in table.\nexport const kVideoInfo = videoTable({\n  table: {\n    'four-colors-vp8-bt601.webm': {\n      mimeType: 'video/webm; codecs=vp8',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.yellow,\n          topRightColor: kBt601PixelValue.srgb.red,\n          bottomLeftColor: kBt601PixelValue.srgb.blue,\n          bottomRightColor: kBt601PixelValue.srgb.green,\n        },\n      },\n    },\n    'four-colors-theora-bt601.ogv': {\n      mimeType: 'video/ogg; codecs=theora',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.yellow,\n          topRightColor: kBt601PixelValue.srgb.red,\n          bottomLeftColor: kBt601PixelValue.srgb.blue,\n          bottomRightColor: kBt601PixelValue.srgb.green,\n        },\n      },\n    },\n    'four-colors-h264-bt601.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.yellow,\n          topRightColor: kBt601PixelValue.srgb.red,\n          bottomLeftColor: kBt601PixelValue.srgb.blue,\n          bottomRightColor: kBt601PixelValue.srgb.green,\n        },\n      },\n    },\n    'four-colors-vp9-bt601.webm': {\n      mimeType: 'video/webm; codecs=vp9',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.yellow,\n          topRightColor: kBt601PixelValue.srgb.red,\n          bottomLeftColor: kBt601PixelValue.srgb.blue,\n          bottomRightColor: kBt601PixelValue.srgb.green,\n        },\n      },\n    },\n    'four-colors-vp9-bt709.webm': {\n      mimeType: 'video/webm; codecs=vp9',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt709PixelValue.srgb.yellow),\n          topRightColor: srgbToDisplayP3(kBt709PixelValue.srgb.red),\n          bottomLeftColor: srgbToDisplayP3(kBt709PixelValue.srgb.blue),\n          bottomRightColor: srgbToDisplayP3(kBt709PixelValue.srgb.green),\n        },\n        srgb: {\n          topLeftColor: kBt709PixelValue.srgb.yellow,\n          topRightColor: kBt709PixelValue.srgb.red,\n          bottomLeftColor: kBt709PixelValue.srgb.blue,\n          bottomRightColor: kBt709PixelValue.srgb.green,\n        },\n      },\n    },\n    'four-colors-h264-bt601-rotate-90.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.red,\n          topRightColor: kBt601PixelValue.srgb.green,\n          bottomLeftColor: kBt601PixelValue.srgb.yellow,\n          bottomRightColor: kBt601PixelValue.srgb.blue,\n        },\n      },\n    },\n    'four-colors-h264-bt601-rotate-180.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.green,\n          topRightColor: kBt601PixelValue.srgb.blue,\n          bottomLeftColor: kBt601PixelValue.srgb.red,\n          bottomRightColor: kBt601PixelValue.srgb.yellow,\n        },\n      },\n    },\n    'four-colors-h264-bt601-rotate-270.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      presentColors: {\n        'display-p3': {\n          topLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n          topRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n          bottomLeftColor: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n          bottomRightColor: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n        },\n        srgb: {\n          topLeftColor: kBt601PixelValue.srgb.blue,\n          topRightColor: kBt601PixelValue.srgb.yellow,\n          bottomLeftColor: kBt601PixelValue.srgb.green,\n          bottomRightColor: kBt601PixelValue.srgb.red,\n        },\n      },\n    },\n  },\n} as const);\n\ntype VideoName = keyof typeof kVideoInfo;\nexport const kVideoNames: readonly VideoName[] = keysOf(kVideoInfo);\n\nexport const kPredefinedColorSpace = ['display-p3', 'srgb'] as const;\n/**\n * Starts playing a video and waits for it to be consumable.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * @param video An HTML5 Video element.\n * @param callback Function to call when video is ready.\n *\n * Adapted from https://github.com/KhronosGroup/WebGL/blob/main/sdk/tests/js/webgl-test-utils.js\n */\nexport function startPlayingAndWaitForVideo(\n  video: HTMLVideoElement,\n  callback: () => unknown | Promise<unknown>\n): Promise<void> {\n  return raceWithRejectOnTimeout(\n    new Promise((resolve, reject) => {\n      const callbackAndResolve = () =>\n        void (async () => {\n          try {\n            await callback();\n            resolve();\n          } catch (ex) {\n            reject(ex);\n          }\n        })();\n      if (video.error) {\n        reject(\n          new ErrorWithExtra('Video.error: ' + video.error.message, () => ({ error: video.error }))\n        );\n        return;\n      }\n\n      video.addEventListener(\n        'error',\n        event => reject(new ErrorWithExtra('Video received \"error\" event', () => ({ event }))),\n        true\n      );\n\n      if (video.requestVideoFrameCallback) {\n        video.requestVideoFrameCallback(() => {\n          callbackAndResolve();\n        });\n      } else {\n        // If requestVideoFrameCallback isn't available, check each frame if the video has advanced.\n        const timeWatcher = () => {\n          if (video.currentTime > 0) {\n            callbackAndResolve();\n          } else {\n            requestAnimationFrame(timeWatcher);\n          }\n        };\n        timeWatcher();\n      }\n\n      video.loop = true;\n      video.muted = true;\n      video.preload = 'auto';\n      video.play().catch(reject);\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n\n/**\n * Fire a `callback` when the script animation reaches a new frame.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n */\nexport function waitForNextTask(callback: () => unknown | Promise<unknown>): Promise<void> {\n  const { promise, callbackAndResolve } = callbackHelper(callback, 'wait for next task timed out');\n  timeout(() => {\n    callbackAndResolve();\n  }, 0);\n\n  return promise;\n}\n\n/**\n * Fire a `callback` when the video reaches a new frame.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * MAINTENANCE_TODO: Find a way to implement this for browsers without requestVideoFrameCallback as\n * well, similar to the timeWatcher path in startPlayingAndWaitForVideo. If that path is proven to\n * work well, we can consider getting rid of the requestVideoFrameCallback path.\n */\nexport function waitForNextFrame(\n  video: HTMLVideoElement,\n  callback: () => unknown | Promise<unknown>\n): Promise<void> {\n  const { promise, callbackAndResolve } = callbackHelper(callback, 'waitForNextFrame timed out');\n\n  if ('requestVideoFrameCallback' in video) {\n    video.requestVideoFrameCallback(() => {\n      callbackAndResolve();\n    });\n  } else {\n    throw new SkipTestCase('waitForNextFrame currently requires requestVideoFrameCallback');\n  }\n\n  return promise;\n}\n\nexport async function getVideoFrameFromVideoElement(\n  test: Fixture,\n  video: HTMLVideoElement\n): Promise<VideoFrame> {\n  if (video.captureStream === undefined) {\n    test.skip('HTMLVideoElement.captureStream is not supported');\n  }\n\n  return raceWithRejectOnTimeout(\n    new Promise<VideoFrame>(resolve => {\n      const videoTrack: MediaStreamVideoTrack = video.captureStream().getVideoTracks()[0];\n      const trackProcessor: MediaStreamTrackProcessor<VideoFrame> = new MediaStreamTrackProcessor({\n        track: videoTrack,\n      });\n      const transformer: TransformStream = new TransformStream({\n        transform(videoFrame, _controller) {\n          videoTrack.stop();\n          resolve(videoFrame);\n        },\n        flush(controller) {\n          controller.terminate();\n        },\n      });\n      const trackGenerator: MediaStreamTrackGenerator<VideoFrame> = new MediaStreamTrackGenerator({\n        kind: 'video',\n      });\n      trackProcessor.readable\n        .pipeThrough(transformer)\n        .pipeTo(trackGenerator.writable)\n        .catch(() => {});\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n\n/**\n * Create HTMLVideoElement based on VideoName. Check whether video is playable in current\n * browser environment.\n * Returns a HTMLVideoElement.\n *\n * @param t: GPUTest that requires getting HTMLVideoElement\n * @param videoName: Required video name\n *\n */\nexport function getVideoElement(t: GPUTest, videoName: VideoName): HTMLVideoElement {\n  if (typeof HTMLVideoElement === 'undefined') {\n    t.skip('HTMLVideoElement not available');\n  }\n\n  const videoElement = document.createElement('video');\n  const videoInfo = kVideoInfo[videoName];\n\n  if (videoElement.canPlayType(videoInfo.mimeType) === '') {\n    t.skip('Video codec is not supported');\n  }\n\n  const videoUrl = getResourcePath(videoName);\n  videoElement.src = videoUrl;\n\n  return videoElement;\n}\n\n/**\n * Helper for doing something inside of a (possibly async) callback (directly, not in a following\n * microtask), and returning a promise when the callback is done.\n * MAINTENANCE_TODO: Use this in startPlayingAndWaitForVideo (and make sure it works).\n */\nfunction callbackHelper(\n  callback: () => unknown | Promise<unknown>,\n  timeoutMessage: string\n): { promise: Promise<void>; callbackAndResolve: () => void } {\n  let callbackAndResolve: () => void;\n\n  const promiseWithoutTimeout = new Promise<void>((resolve, reject) => {\n    callbackAndResolve = () =>\n      void (async () => {\n        try {\n          await callback(); // catches both exceptions and rejections\n          resolve();\n        } catch (ex) {\n          reject(ex);\n        }\n      })();\n  });\n  const promise = raceWithRejectOnTimeout(promiseWithoutTimeout, 2000, timeoutMessage);\n  return { promise, callbackAndResolve: callbackAndResolve! };\n}\n"],"mappings":"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"}