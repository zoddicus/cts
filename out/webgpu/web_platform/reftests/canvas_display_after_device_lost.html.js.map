{"version":3,"file":"canvas_display_after_device_lost.html.js","names":["timeout","assert","takeScreenshotDelayed","navigator","gpu","undefined","adapter","requestAdapter","device","requestDevice","presentationFormat","getPreferredCanvasFormat","deviceLost","draw","canvasId","alphaMode","abortAfterDeviceLost","canvas","document","getElementById","ctx","getContext","configure","format","colorAttachment","getCurrentTexture","colorAttachmentView","createView","encoder","createCommandEncoder","pass","beginRenderPass","colorAttachments","view","clearValue","r","g","b","a","loadOp","storeOp","end","queue","submit","finish","drawAll","destroy"],"sources":["../../../../src/webgpu/web_platform/reftests/canvas_display_after_device_lost.html.ts"],"sourcesContent":["import { timeout } from '../../../common/util/timeout.js';\nimport { assert } from '../../../common/util/util.js';\nimport { takeScreenshotDelayed } from '../../../common/util/wpt_reftest_wait.js';\n\nvoid (async () => {\n  assert(\n    typeof navigator !== 'undefined' && navigator.gpu !== undefined,\n    'No WebGPU implementation found'\n  );\n\n  const adapter = await navigator.gpu.requestAdapter();\n  assert(adapter !== null);\n  const device = await adapter.requestDevice();\n  assert(device !== null);\n  const presentationFormat = navigator.gpu.getPreferredCanvasFormat();\n  let deviceLost = false;\n\n  function draw(canvasId: string, alphaMode: GPUCanvasAlphaMode, abortAfterDeviceLost: boolean) {\n    if (deviceLost && abortAfterDeviceLost) {\n      return;\n    }\n\n    const canvas = document.getElementById(canvasId) as HTMLCanvasElement;\n    const ctx = canvas.getContext('webgpu') as unknown as GPUCanvasContext;\n    ctx.configure({\n      device,\n      format: presentationFormat,\n      alphaMode,\n    });\n\n    const colorAttachment = ctx.getCurrentTexture();\n    const colorAttachmentView = colorAttachment.createView();\n\n    const encoder = device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: colorAttachmentView,\n          clearValue: { r: 0.4, g: 1.0, b: 0.0, a: 1.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n    pass.end();\n    device.queue.submit([encoder.finish()]);\n  }\n\n  function drawAll() {\n    draw('cvs0', 'opaque', true);\n    draw('cvs1', 'opaque', false);\n    draw('cvs2', 'premultiplied', true);\n    draw('cvs3', 'premultiplied', false);\n\n    if (!deviceLost) {\n      device.destroy();\n      deviceLost = true;\n      timeout(drawAll, 100);\n    } else {\n      takeScreenshotDelayed(50);\n    }\n  }\n\n  drawAll();\n})();\n"],"mappings":";;GAAA,SAASA,OAAO,QAAQ,iCAAiC,CACzD,SAASC,MAAM,QAAQ,8BAA8B,CACrD,SAASC,qBAAqB,QAAQ,0CAA0C;;AAEhF,KAAK,CAAC,YAAY;EAChBD,MAAM;IACJ,OAAOE,SAAS,KAAK,WAAW,IAAIA,SAAS,CAACC,GAAG,KAAKC,SAAS;IAC/D;EACF,CAAC;;EAED,MAAMC,OAAO,GAAG,MAAMH,SAAS,CAACC,GAAG,CAACG,cAAc,CAAC,CAAC;EACpDN,MAAM,CAACK,OAAO,KAAK,IAAI,CAAC;EACxB,MAAME,MAAM,GAAG,MAAMF,OAAO,CAACG,aAAa,CAAC,CAAC;EAC5CR,MAAM,CAACO,MAAM,KAAK,IAAI,CAAC;EACvB,MAAME,kBAAkB,GAAGP,SAAS,CAACC,GAAG,CAACO,wBAAwB,CAAC,CAAC;EACnE,IAAIC,UAAU,GAAG,KAAK;;EAEtB,SAASC,IAAIA,CAACC,QAAgB,EAAEC,SAA6B,EAAEC,oBAA6B,EAAE;IAC5F,IAAIJ,UAAU,IAAII,oBAAoB,EAAE;MACtC;IACF;;IAEA,MAAMC,MAAM,GAAGC,QAAQ,CAACC,cAAc,CAACL,QAAQ,CAAsB;IACrE,MAAMM,GAAG,GAAGH,MAAM,CAACI,UAAU,CAAC,QAAQ,CAAgC;IACtED,GAAG,CAACE,SAAS,CAAC;MACZd,MAAM;MACNe,MAAM,EAAEb,kBAAkB;MAC1BK;IACF,CAAC,CAAC;;IAEF,MAAMS,eAAe,GAAGJ,GAAG,CAACK,iBAAiB,CAAC,CAAC;IAC/C,MAAMC,mBAAmB,GAAGF,eAAe,CAACG,UAAU,CAAC,CAAC;;IAExD,MAAMC,OAAO,GAAGpB,MAAM,CAACqB,oBAAoB,CAAC,CAAC;IAC7C,MAAMC,IAAI,GAAGF,OAAO,CAACG,eAAe,CAAC;MACnCC,gBAAgB,EAAE;MAChB;QACEC,IAAI,EAAEP,mBAAmB;QACzBQ,UAAU,EAAE,EAAEC,CAAC,EAAE,GAAG,EAAEC,CAAC,EAAE,GAAG,EAAEC,CAAC,EAAE,GAAG,EAAEC,CAAC,EAAE,GAAG,CAAC,CAAC;QAC9CC,MAAM,EAAE,OAAO;QACfC,OAAO,EAAE;MACX,CAAC;;IAEL,CAAC,CAAC;IACFV,IAAI,CAACW,GAAG,CAAC,CAAC;IACVjC,MAAM,CAACkC,KAAK,CAACC,MAAM,CAAC,CAACf,OAAO,CAACgB,MAAM,CAAC,CAAC,CAAC,CAAC;EACzC;;EAEA,SAASC,OAAOA,CAAA,EAAG;IACjBhC,IAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,IAAI,CAAC;IAC5BA,IAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,KAAK,CAAC;IAC7BA,IAAI,CAAC,MAAM,EAAE,eAAe,EAAE,IAAI,CAAC;IACnCA,IAAI,CAAC,MAAM,EAAE,eAAe,EAAE,KAAK,CAAC;;IAEpC,IAAI,CAACD,UAAU,EAAE;MACfJ,MAAM,CAACsC,OAAO,CAAC,CAAC;MAChBlC,UAAU,GAAG,IAAI;MACjBZ,OAAO,CAAC6C,OAAO,EAAE,GAAG,CAAC;IACvB,CAAC,MAAM;MACL3C,qBAAqB,CAAC,EAAE,CAAC;IAC3B;EACF;;EAEA2C,OAAO,CAAC,CAAC;AACX,CAAC,EAAE,CAAC"}