{"version":3,"file":"video.spec.js","names":["description","makeTestGroup","GPUTest","TextureTestMixin","startPlayingAndWaitForVideo","getVideoElement","kVideoExpectations","kFormat","g","test","desc","params","u","combineWithParams","combine","fn","t","videoName","srcDoFlipYDuringCopy","videoElement","width","videoWidth","height","videoHeight","dstTexture","device","createTexture","format","size","depthOrArrayLayers","usage","GPUTextureUsage","COPY_SRC","COPY_DST","RENDER_ATTACHMENT","queue","copyExternalImageToTexture","source","origin","x","y","flipY","texture","colorSpace","premultipliedAlpha","expectSinglePixelComparisonsAreOkInTexture","coord","exp","_blueExpectation","_greenExpectation","_yellowExpectation","_redExpectation"],"sources":["../../../../src/webgpu/web_platform/copyToTexture/video.spec.ts"],"sourcesContent":["export const description = `\ncopyToTexture with HTMLVideoElement (and other video-type sources?).\n\n- videos with various encodings/formats (webm vp8, webm vp9, ogg theora, mp4), color spaces\n  (bt.601, bt.709, bt.2020)\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { GPUTest, TextureTestMixin } from '../../gpu_test.js';\nimport {\n  startPlayingAndWaitForVideo,\n  getVideoElement,\n  kVideoExpectations,\n} from '../../web_platform/util.js';\n\nconst kFormat = 'rgba8unorm';\n\nexport const g = makeTestGroup(TextureTestMixin(GPUTest));\n\ng.test('copy_from_video_element')\n  .desc(\n    `\nTest HTMLVideoElement can be copied to WebGPU texture correctly.\n\nIt creates HTMLVideoElement with videos under Resource folder.\n\n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the ImageBitmap contents.\n\n  If 'flipY' in 'GPUImageCopyExternalImage' is set to 'true', copy will ensure the result\n  is flipped.\n\n  The tests covers:\n  - Video comes from different color spaces.\n  - Valid 'flipY' config in 'GPUImageCopyExternalImage' (named 'srcDoFlipYDuringCopy' in cases)\n  - TODO: partial copy tests should be added\n  - TODO: all valid dstColorFormat tests should be added.\n  - TODO: dst color space tests need to be added\n`\n  )\n  .params(u =>\n    u //\n      .combineWithParams(kVideoExpectations)\n      .combine('srcDoFlipYDuringCopy', [true, false])\n  )\n  .fn(async t => {\n    const { videoName, srcDoFlipYDuringCopy } = t.params;\n\n    const videoElement = getVideoElement(t, videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, () => {\n      const width = videoElement.videoWidth;\n      const height = videoElement.videoHeight;\n      const dstTexture = t.device.createTexture({\n        format: kFormat,\n        size: { width, height, depthOrArrayLayers: 1 },\n        usage:\n          GPUTextureUsage.COPY_SRC | GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n      });\n\n      t.queue.copyExternalImageToTexture(\n        { source: videoElement, origin: { x: 0, y: 0 }, flipY: srcDoFlipYDuringCopy },\n        {\n          texture: dstTexture,\n          origin: { x: 0, y: 0 },\n          colorSpace: 'srgb',\n          premultipliedAlpha: true,\n        },\n        { width, height, depthOrArrayLayers: 1 }\n      );\n\n      if (srcDoFlipYDuringCopy) {\n        t.expectSinglePixelComparisonsAreOkInTexture({ texture: dstTexture }, [\n          // Top-left should be blue.\n          { coord: { x: width * 0.25, y: height * 0.25 }, exp: t.params._blueExpectation },\n          // Top-right should be green.\n          { coord: { x: width * 0.75, y: height * 0.25 }, exp: t.params._greenExpectation },\n          // Bottom-left should be yellow.\n          { coord: { x: width * 0.25, y: height * 0.75 }, exp: t.params._yellowExpectation },\n          // Bottom-right should be red.\n          { coord: { x: width * 0.75, y: height * 0.75 }, exp: t.params._redExpectation },\n        ]);\n      } else {\n        t.expectSinglePixelComparisonsAreOkInTexture({ texture: dstTexture }, [\n          // Top-left should be yellow.\n          { coord: { x: width * 0.25, y: height * 0.25 }, exp: t.params._yellowExpectation },\n          // Top-right should be red.\n          { coord: { x: width * 0.75, y: height * 0.25 }, exp: t.params._redExpectation },\n          // Bottom-left should be blue.\n          { coord: { x: width * 0.25, y: height * 0.75 }, exp: t.params._blueExpectation },\n          // Bottom-right should be green.\n          { coord: { x: width * 0.75, y: height * 0.75 }, exp: t.params._greenExpectation },\n        ]);\n      }\n    });\n  });\n"],"mappings":"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"}