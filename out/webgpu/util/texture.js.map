{"version":3,"file":"texture.js","names":["assert","getTextureCopyLayout","reifyExtent3D","createTextureFromTexelViews","device","texelViews","desc","length","every","e","format","width","height","depthOrArrayLayers","size","texture","createTexture","usage","GPUTextureUsage","COPY_DST","mipLevelCount","commandEncoder","createCommandEncoder","stagingBuffers","mipLevel","bytesPerRow","rowsPerImage","mipSize","mipWidth","mipHeight","mipDepthOrArray","dimension","stagingBuffer","createBuffer","mappedAtCreation","GPUBufferUsage","COPY_SRC","push","writeTextureData","Uint8Array","getMappedRange","subrectOrigin","subrectSize","unmap","copyBufferToTexture","buffer","queue","submit","finish","forEach","value","destroy","createTextureFromTexelView","texelView"],"sources":["../../../src/webgpu/util/texture.ts"],"sourcesContent":["import { assert } from '../../common/util/util.js';\n\nimport { getTextureCopyLayout } from './texture/layout.js';\nimport { TexelView } from './texture/texel_view.js';\nimport { reifyExtent3D } from './unions.js';\n\n/**\n * Creates a mipmapped texture where each mipmap level's (`i`) content is\n * from `texelViews[i]`.\n */\nexport function createTextureFromTexelViews(\n  device: GPUDevice,\n  texelViews: TexelView[],\n  desc: Omit<GPUTextureDescriptor, 'format'>\n): GPUTexture {\n  // All texel views must be the same format for mipmaps.\n  assert(texelViews.length > 0 && texelViews.every(e => e.format === texelViews[0].format));\n  const format = texelViews[0].format;\n  const { width, height, depthOrArrayLayers } = reifyExtent3D(desc.size);\n\n  // Create the texture and then initialize each mipmap level separately.\n  const texture = device.createTexture({\n    ...desc,\n    format: texelViews[0].format,\n    usage: desc.usage | GPUTextureUsage.COPY_DST,\n    mipLevelCount: texelViews.length,\n  });\n\n  // Copy the texel view into each mip level layer.\n  const commandEncoder = device.createCommandEncoder();\n  const stagingBuffers = [];\n  for (let mipLevel = 0; mipLevel < texelViews.length; mipLevel++) {\n    const {\n      bytesPerRow,\n      rowsPerImage,\n      mipSize: [mipWidth, mipHeight, mipDepthOrArray],\n    } = getTextureCopyLayout(format, desc.dimension ?? '2d', [width, height, depthOrArrayLayers], {\n      mipLevel,\n    });\n\n    // Create a staging buffer to upload the texture mip level contents.\n    const stagingBuffer = device.createBuffer({\n      mappedAtCreation: true,\n      size: bytesPerRow * mipHeight * mipDepthOrArray,\n      usage: GPUBufferUsage.COPY_SRC,\n    });\n    stagingBuffers.push(stagingBuffer);\n\n    // Write the texels into the staging buffer.\n    texelViews[mipLevel].writeTextureData(new Uint8Array(stagingBuffer.getMappedRange()), {\n      bytesPerRow,\n      rowsPerImage: mipHeight,\n      subrectOrigin: [0, 0, 0],\n      subrectSize: [mipWidth, mipHeight, mipDepthOrArray],\n    });\n    stagingBuffer.unmap();\n\n    // Copy from the staging buffer into the texture.\n    commandEncoder.copyBufferToTexture(\n      { buffer: stagingBuffer, bytesPerRow, rowsPerImage },\n      { texture, mipLevel },\n      [mipWidth, mipHeight, mipDepthOrArray]\n    );\n  }\n  device.queue.submit([commandEncoder.finish()]);\n\n  // Cleanup the staging buffers.\n  stagingBuffers.forEach(value => value.destroy());\n\n  return texture;\n}\n\n/**\n * Creates a 1 mip level texture with the contents of a TexelView.\n */\nexport function createTextureFromTexelView(\n  device: GPUDevice,\n  texelView: TexelView,\n  desc: Omit<GPUTextureDescriptor, 'format'>\n): GPUTexture {\n  return createTextureFromTexelViews(device, [texelView], desc);\n}\n"],"mappings":"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"}