{"version":3,"file":"memory.js","names":["exhaustVramUntilUnder64MB","t","allocateUntilOom","device","size","buffers","pushErrorScope","buffer","createBufferTracked","usage","GPUBufferUsage","STORAGE","popErrorScope","push","kLargeChunkSize","kSmallChunkSize","forEach","destroy"],"sources":["../../../src/webgpu/util/memory.ts"],"sourcesContent":["import { GPUTest } from '../gpu_test.js';\n\n/**\n * Helper to exhaust VRAM until there is less than 64 MB of capacity. Returns\n * an opaque closure which can be called to free the allocated resources later.\n */\nexport async function exhaustVramUntilUnder64MB(t: GPUTest) {\n  const allocateUntilOom = async (device: GPUDevice, size: number) => {\n    const buffers = [];\n    for (;;) {\n      device.pushErrorScope('out-of-memory');\n      const buffer = t.createBufferTracked({ size, usage: GPUBufferUsage.STORAGE });\n      if (await device.popErrorScope()) {\n        return buffers;\n      }\n      buffers.push(buffer);\n    }\n  };\n\n  const kLargeChunkSize = 512 * 1024 * 1024;\n  const kSmallChunkSize = 64 * 1024 * 1024;\n  const buffers = await allocateUntilOom(t.device, kLargeChunkSize);\n  buffers.push(...(await allocateUntilOom(t.device, kSmallChunkSize)));\n  return () => {\n    buffers.forEach(buffer => buffer.destroy());\n  };\n}\n"],"mappings":";;IAEA;AACA;AACA;AACA;AACA,OAAO,eAAeA,yBAAyBA,CAACC,CAAU,EAAE;EAC1D,MAAMC,gBAAgB,GAAG,MAAAA,CAAOC,MAAiB,EAAEC,IAAY,KAAK;IAClE,MAAMC,OAAO,GAAG,EAAE;IAClB,SAAS;MACPF,MAAM,CAACG,cAAc,CAAC,eAAe,CAAC;MACtC,MAAMC,MAAM,GAAGN,CAAC,CAACO,mBAAmB,CAAC,EAAEJ,IAAI,EAAEK,KAAK,EAAEC,cAAc,CAACC,OAAO,CAAC,CAAC,CAAC;MAC7E,IAAI,MAAMR,MAAM,CAACS,aAAa,CAAC,CAAC,EAAE;QAChC,OAAOP,OAAO;MAChB;MACAA,OAAO,CAACQ,IAAI,CAACN,MAAM,CAAC;IACtB;EACF,CAAC;;EAED,MAAMO,eAAe,GAAG,GAAG,GAAG,IAAI,GAAG,IAAI;EACzC,MAAMC,eAAe,GAAG,EAAE,GAAG,IAAI,GAAG,IAAI;EACxC,MAAMV,OAAO,GAAG,MAAMH,gBAAgB,CAACD,CAAC,CAACE,MAAM,EAAEW,eAAe,CAAC;EACjET,OAAO,CAACQ,IAAI,CAAC,IAAI,MAAMX,gBAAgB,CAACD,CAAC,CAACE,MAAM,EAAEY,eAAe,CAAC,CAAC,CAAC;EACpE,OAAO,MAAM;IACXV,OAAO,CAACW,OAAO,CAAC,CAAAT,MAAM,KAAIA,MAAM,CAACU,OAAO,CAAC,CAAC,CAAC;EAC7C,CAAC;AACH"}