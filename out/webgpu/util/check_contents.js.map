{"version":3,"file":"check_contents.js","names":["assert","ErrorWithExtra","iterRange","range","Float16Array","generatePrettyTable","checkElementsEqual","actual","expected","constructor","length","checkElementsEqualGenerated","i","checkElementsBetween","error","checkElementsPassPredicate","index","value","Math","min","max","predicatePrinter","leftHeader","getValueForCell","undefined","checkElementsEqualEither","generator","predicate","size","ctor","printAsFloat","Float32Array","Float64Array","failedElementsFirstMaybe","failedElements","failedElementsFirst","failedElementsLast","printElementsStart","printElementsEnd","printElementsCount","numberToString","n","toPrecision","intToPaddedHex","byteLength","BYTES_PER_ELEMENT","numberPrefix","printActual","subarray","printExpected","cell","push","printFailedValueMarkers","opts","fillToWidth","msg","slice","number","Number","isInteger","s","abs","toString","padStart"],"sources":["../../../src/webgpu/util/check_contents.ts"],"sourcesContent":["// MAINTENANCE_TODO: The \"checkThingTrue\" naming is confusing; these must be used with `expectOK`\n// or the result is dropped on the floor. Rename these to things like `typedArrayIsOK`(??) to\n// make it clearer.\n// MAINTENANCE_TODO: Also, audit to make sure we aren't dropping any on the floor. Consider a\n// no-ignored-return lint check if we can find one that we can use.\n\nimport {\n  assert,\n  ErrorWithExtra,\n  iterRange,\n  range,\n  TypedArrayBufferView,\n  TypedArrayBufferViewConstructor,\n} from '../../common/util/util.js';\nimport { Float16Array } from '../../external/petamoriken/float16/float16.js';\n\nimport { generatePrettyTable } from './pretty_diff_tables.js';\n\n/** Generate an expected value at `index`, to test for equality with the actual value. */\nexport type CheckElementsGenerator = (index: number) => number;\n/** Check whether the actual `value` at `index` is as expected. */\nexport type CheckElementsPredicate = (index: number, value: number) => boolean;\n/**\n * Provides a pretty-printing implementation for a particular CheckElementsPredicate.\n * This is an array; each element provides info to print an additional row in the error message.\n */\nexport type CheckElementsSupplementalTableRows = Array<{\n  /** Row header. */\n  leftHeader: string;\n  /**\n   * Get the value for a cell in the table with element index `index`.\n   * May be a string or a number; a number will be formatted according to the TypedArray type used.\n   */\n  getValueForCell: (index: number) => number | string;\n}>;\n\n/**\n * Check whether two `TypedArray`s have equal contents.\n * Returns `undefined` if the check passes, or an `Error` if not.\n */\nexport function checkElementsEqual(\n  actual: TypedArrayBufferView,\n  expected: TypedArrayBufferView\n): ErrorWithExtra | undefined {\n  assert(actual.constructor === expected.constructor, 'TypedArray type mismatch');\n  assert(actual.length === expected.length, 'size mismatch');\n  return checkElementsEqualGenerated(actual, i => expected[i]);\n}\n\n/**\n * Check whether each value in a `TypedArray` is between the two corresponding \"expected\" values\n * (either `a(i) <= actual[i] <= b(i)` or `a(i) >= actual[i] => b(i)`).\n */\nexport function checkElementsBetween(\n  actual: TypedArrayBufferView,\n  expected: readonly [CheckElementsGenerator, CheckElementsGenerator]\n): ErrorWithExtra | undefined {\n  const error = checkElementsPassPredicate(\n    actual,\n    (index, value) =>\n      value >= Math.min(expected[0](index), expected[1](index)) &&\n      value <= Math.max(expected[0](index), expected[1](index)),\n    {\n      predicatePrinter: [\n        { leftHeader: 'between', getValueForCell: index => expected[0](index) },\n        { leftHeader: 'and', getValueForCell: index => expected[1](index) },\n      ],\n    }\n  );\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ expected })) : undefined;\n}\n\n/**\n * Check whether each value in a `TypedArray` is equal to one of the two corresponding \"expected\"\n * values (either `actual[i] === a[i]` or `actual[i] === b[i]`)\n */\nexport function checkElementsEqualEither(\n  actual: TypedArrayBufferView,\n  expected: readonly [TypedArrayBufferView, TypedArrayBufferView]\n): ErrorWithExtra | undefined {\n  const error = checkElementsPassPredicate(\n    actual,\n    (index, value) => value === expected[0][index] || value === expected[1][index],\n    {\n      predicatePrinter: [\n        { leftHeader: 'either', getValueForCell: index => expected[0][index] },\n        { leftHeader: 'or', getValueForCell: index => expected[1][index] },\n      ],\n    }\n  );\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ expected })) : undefined;\n}\n\n/**\n * Check whether a `TypedArray`'s contents equal the values produced by a generator function.\n * Returns `undefined` if the check passes, or an `Error` if not.\n *\n * ```text\n * Array had unexpected contents at indices 2 through 19.\n *  Starting at index 1:\n *    actual == 0x: 00 fe ff 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00\n *    failed ->        xx xx    xx xx xx xx xx xx xx xx xx xx xx xx xx xx xx\n *  expected ==     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n * ```\n *\n * ```text\n * Array had unexpected contents at indices 2 through 29.\n *  Starting at index 1:\n *    actual ==  0.000 -2.000e+100 -1.000e+100 0.000 1.000e+100 2.000e+100 3.000e+100 4.000e+100 5.000e+100 6.000e+100 7.000e+100 ...\n *    failed ->                 xx          xx               xx         xx         xx         xx         xx         xx         xx ...\n *  expected ==  0.000       0.000       0.000 0.000      0.000      0.000      0.000      0.000      0.000      0.000      0.000 ...\n * ```\n */\nexport function checkElementsEqualGenerated(\n  actual: TypedArrayBufferView,\n  generator: CheckElementsGenerator\n): ErrorWithExtra | undefined {\n  const error = checkElementsPassPredicate(actual, (index, value) => value === generator(index), {\n    predicatePrinter: [{ leftHeader: 'expected ==', getValueForCell: index => generator(index) }],\n  });\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ generator })) : undefined;\n}\n\n/**\n * Check whether a `TypedArray`'s values pass the provided predicate function.\n * Returns `undefined` if the check passes, or an `Error` if not.\n */\nexport function checkElementsPassPredicate(\n  actual: TypedArrayBufferView,\n  predicate: CheckElementsPredicate,\n  { predicatePrinter }: { predicatePrinter?: CheckElementsSupplementalTableRows }\n): ErrorWithExtra | undefined {\n  const size = actual.length;\n  const ctor = actual.constructor as TypedArrayBufferViewConstructor;\n  const printAsFloat = ctor === Float16Array || ctor === Float32Array || ctor === Float64Array;\n\n  let failedElementsFirstMaybe: number | undefined = undefined;\n  /** Sparse array with `true` for elements that failed. */\n  const failedElements: (true | undefined)[] = [];\n  for (let i = 0; i < size; ++i) {\n    if (!predicate(i, actual[i])) {\n      failedElementsFirstMaybe ??= i;\n      failedElements[i] = true;\n    }\n  }\n\n  if (failedElementsFirstMaybe === undefined) {\n    return undefined;\n  }\n  const failedElementsFirst = failedElementsFirstMaybe;\n  const failedElementsLast = failedElements.length - 1;\n\n  // Include one extra non-failed element at the beginning and end (if they exist), for context.\n  const printElementsStart = Math.max(0, failedElementsFirst - 1);\n  const printElementsEnd = Math.min(size, failedElementsLast + 2);\n  const printElementsCount = printElementsEnd - printElementsStart;\n\n  const numberToString = printAsFloat\n    ? (n: number) => n.toPrecision(4)\n    : (n: number) => intToPaddedHex(n, { byteLength: ctor.BYTES_PER_ELEMENT });\n  const numberPrefix = printAsFloat ? '' : '0x:';\n\n  const printActual = actual.subarray(printElementsStart, printElementsEnd);\n  const printExpected: Array<Iterable<string | number>> = [];\n  if (predicatePrinter) {\n    for (const { leftHeader, getValueForCell: cell } of predicatePrinter) {\n      printExpected.push(\n        (function* () {\n          yield* [leftHeader, ''];\n          yield* iterRange(printElementsCount, i => cell(printElementsStart + i));\n        })()\n      );\n    }\n  }\n\n  const printFailedValueMarkers = (function* () {\n    yield* ['failed ->', ''];\n    yield* range(printElementsCount, i => (failedElements[printElementsStart + i] ? 'xx' : ''));\n  })();\n\n  const opts = {\n    fillToWidth: 120,\n    numberToString,\n  };\n  const msg = `Array had unexpected contents at indices ${failedElementsFirst} through ${failedElementsLast}.\n Starting at index ${printElementsStart}:\n${generatePrettyTable(opts, [\n  ['actual ==', numberPrefix, ...printActual],\n  printFailedValueMarkers,\n  ...printExpected,\n])}`;\n  return new ErrorWithExtra(msg, () => ({\n    actual: actual.slice(),\n  }));\n}\n\n// Helper helpers\n\n/** Convert an integral `number` into a hex string, padded to the specified `byteLength`. */\nfunction intToPaddedHex(number: number, { byteLength }: { byteLength: number }) {\n  assert(Number.isInteger(number), 'number must be integer');\n  let s = Math.abs(number).toString(16);\n  if (byteLength) s = s.padStart(byteLength * 2, '0');\n  if (number < 0) s = '-' + s;\n  return s;\n}\n"],"mappings":";AAAA;AAAA,G,CAAA;AACA;AACA;AACA;AACA;AAEA,SACEA,MAAM;AACNC,cAAc;AACdC,SAAS;AACTC,KAAK;;;AAGA,2BAA2B;AAClC,SAASC,YAAY,QAAQ,+CAA+C;;AAE5E,SAASC,mBAAmB,QAAQ,yBAAyB;;AAE7D;;;;;;;;;;;;;;;;;;AAkBA;AACA;AACA;AACA;AACA,OAAO,SAASC,kBAAkB;AAChCC,MAA4B;AAC5BC,QAA8B;AACF;EAC5BR,MAAM,CAACO,MAAM,CAACE,WAAW,KAAKD,QAAQ,CAACC,WAAW,EAAE,0BAA0B,CAAC;EAC/ET,MAAM,CAACO,MAAM,CAACG,MAAM,KAAKF,QAAQ,CAACE,MAAM,EAAE,eAAe,CAAC;EAC1D,OAAOC,2BAA2B,CAACJ,MAAM,EAAE,CAAAK,CAAC,KAAIJ,QAAQ,CAACI,CAAC,CAAC,CAAC;AAC9D;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAASC,oBAAoB;AAClCN,MAA4B;AAC5BC,QAAmE;AACvC;EAC5B,MAAMM,KAAK,GAAGC,0BAA0B;EACtCR,MAAM;EACN,CAACS,KAAK,EAAEC,KAAK;EACXA,KAAK,IAAIC,IAAI,CAACC,GAAG,CAACX,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,EAAER,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,CAAC;EACzDC,KAAK,IAAIC,IAAI,CAACE,GAAG,CAACZ,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,EAAER,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,CAAC;EAC3D;IACEK,gBAAgB,EAAE;IAChB,EAAEC,UAAU,EAAE,SAAS,EAAEC,eAAe,EAAE,CAAAP,KAAK,KAAIR,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,CAAC,CAAC;IACvE,EAAEM,UAAU,EAAE,KAAK,EAAEC,eAAe,EAAE,CAAAP,KAAK,KAAIR,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,CAAC,CAAC;;EAEvE,CAAC,CACF;;EACD;EACA,OAAOF,KAAK,GAAG,IAAIb,cAAc,CAACa,KAAK,EAAE,OAAO,EAAEN,QAAQ,CAAC,CAAC,CAAC,CAAC,GAAGgB,SAAS;AAC5E;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAASC,wBAAwB;AACtClB,MAA4B;AAC5BC,QAA+D;AACnC;EAC5B,MAAMM,KAAK,GAAGC,0BAA0B;EACtCR,MAAM;EACN,CAACS,KAAK,EAAEC,KAAK,KAAKA,KAAK,KAAKT,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,IAAIC,KAAK,KAAKT,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC;EAC9E;IACEK,gBAAgB,EAAE;IAChB,EAAEC,UAAU,EAAE,QAAQ,EAAEC,eAAe,EAAE,CAAAP,KAAK,KAAIR,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,CAAC,CAAC;IACtE,EAAEM,UAAU,EAAE,IAAI,EAAEC,eAAe,EAAE,CAAAP,KAAK,KAAIR,QAAQ,CAAC,CAAC,CAAC,CAACQ,KAAK,CAAC,CAAC,CAAC;;EAEtE,CAAC,CACF;;EACD;EACA,OAAOF,KAAK,GAAG,IAAIb,cAAc,CAACa,KAAK,EAAE,OAAO,EAAEN,QAAQ,CAAC,CAAC,CAAC,CAAC,GAAGgB,SAAS;AAC5E;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASb,2BAA2B;AACzCJ,MAA4B;AAC5BmB,SAAiC;AACL;EAC5B,MAAMZ,KAAK,GAAGC,0BAA0B,CAACR,MAAM,EAAE,CAACS,KAAK,EAAEC,KAAK,KAAKA,KAAK,KAAKS,SAAS,CAACV,KAAK,CAAC,EAAE;IAC7FK,gBAAgB,EAAE,CAAC,EAAEC,UAAU,EAAE,aAAa,EAAEC,eAAe,EAAE,CAAAP,KAAK,KAAIU,SAAS,CAACV,KAAK,CAAC,CAAC,CAAC;EAC9F,CAAC,CAAC;EACF;EACA,OAAOF,KAAK,GAAG,IAAIb,cAAc,CAACa,KAAK,EAAE,OAAO,EAAEY,SAAS,CAAC,CAAC,CAAC,CAAC,GAAGF,SAAS;AAC7E;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAAST,0BAA0B;AACxCR,MAA4B;AAC5BoB,SAAiC;AACjC,EAAEN,gBAAgB,CAA4D,CAAC;AACnD;EAC5B,MAAMO,IAAI,GAAGrB,MAAM,CAACG,MAAM;EAC1B,MAAMmB,IAAI,GAAGtB,MAAM,CAACE,WAA8C;EAClE,MAAMqB,YAAY,GAAGD,IAAI,KAAKzB,YAAY,IAAIyB,IAAI,KAAKE,YAAY,IAAIF,IAAI,KAAKG,YAAY;;EAE5F,IAAIC,wBAA4C,GAAGT,SAAS;EAC5D;EACA,MAAMU,cAAoC,GAAG,EAAE;EAC/C,KAAK,IAAItB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGgB,IAAI,EAAE,EAAEhB,CAAC,EAAE;IAC7B,IAAI,CAACe,SAAS,CAACf,CAAC,EAAEL,MAAM,CAACK,CAAC,CAAC,CAAC,EAAE;MAC5BqB,wBAAwB,KAAKrB,CAAC;MAC9BsB,cAAc,CAACtB,CAAC,CAAC,GAAG,IAAI;IAC1B;EACF;;EAEA,IAAIqB,wBAAwB,KAAKT,SAAS,EAAE;IAC1C,OAAOA,SAAS;EAClB;EACA,MAAMW,mBAAmB,GAAGF,wBAAwB;EACpD,MAAMG,kBAAkB,GAAGF,cAAc,CAACxB,MAAM,GAAG,CAAC;;EAEpD;EACA,MAAM2B,kBAAkB,GAAGnB,IAAI,CAACE,GAAG,CAAC,CAAC,EAAEe,mBAAmB,GAAG,CAAC,CAAC;EAC/D,MAAMG,gBAAgB,GAAGpB,IAAI,CAACC,GAAG,CAACS,IAAI,EAAEQ,kBAAkB,GAAG,CAAC,CAAC;EAC/D,MAAMG,kBAAkB,GAAGD,gBAAgB,GAAGD,kBAAkB;;EAEhE,MAAMG,cAAc,GAAGV,YAAY;EAC/B,CAACW,CAAS,KAAKA,CAAC,CAACC,WAAW,CAAC,CAAC,CAAC;EAC/B,CAACD,CAAS,KAAKE,cAAc,CAACF,CAAC,EAAE,EAAEG,UAAU,EAAEf,IAAI,CAACgB,iBAAiB,CAAC,CAAC,CAAC;EAC5E,MAAMC,YAAY,GAAGhB,YAAY,GAAG,EAAE,GAAG,KAAK;;EAE9C,MAAMiB,WAAW,GAAGxC,MAAM,CAACyC,QAAQ,CAACX,kBAAkB,EAAEC,gBAAgB,CAAC;EACzE,MAAMW,aAA+C,GAAG,EAAE;EAC1D,IAAI5B,gBAAgB,EAAE;IACpB,KAAK,MAAM,EAAEC,UAAU,EAAEC,eAAe,EAAE2B,IAAI,CAAC,CAAC,IAAI7B,gBAAgB,EAAE;MACpE4B,aAAa,CAACE,IAAI;MACf,aAAa;QACZ,OAAO,CAAC7B,UAAU,EAAE,EAAE,CAAC;QACvB,OAAOpB,SAAS,CAACqC,kBAAkB,EAAE,CAAA3B,CAAC,KAAIsC,IAAI,CAACb,kBAAkB,GAAGzB,CAAC,CAAC,CAAC;MACzE,CAAC,EAAG,CACL;;IACH;EACF;;EAEA,MAAMwC,uBAAuB,GAAI,aAAa;IAC5C,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC;IACxB,OAAOjD,KAAK,CAACoC,kBAAkB,EAAE,CAAA3B,CAAC,KAAKsB,cAAc,CAACG,kBAAkB,GAAGzB,CAAC,CAAC,GAAG,IAAI,GAAG,EAAG,CAAC;EAC7F,CAAC,EAAG;;EAEJ,MAAMyC,IAAI,GAAG;IACXC,WAAW,EAAE,GAAG;IAChBd;EACF,CAAC;EACD,MAAMe,GAAG,GAAI,4CAA2CpB,mBAAoB,YAAWC,kBAAmB;AAC5G,qBAAqBC,kBAAmB;AACxC,EAAEhC,mBAAmB,CAACgD,IAAI,EAAE;EAC1B,CAAC,WAAW,EAAEP,YAAY,EAAE,GAAGC,WAAW,CAAC;EAC3CK,uBAAuB;EACvB,GAAGH,aAAa,CACjB;EAAE,EAAC;EACF,OAAO,IAAIhD,cAAc,CAACsD,GAAG,EAAE,OAAO;IACpChD,MAAM,EAAEA,MAAM,CAACiD,KAAK;EACtB,CAAC,CAAC,CAAC;AACL;;AAEA;;AAEA;AACA,SAASb,cAAc,CAACc,MAAc,EAAE,EAAEb,UAAU,CAAyB,CAAC,EAAE;EAC9E5C,MAAM,CAAC0D,MAAM,CAACC,SAAS,CAACF,MAAM,CAAC,EAAE,wBAAwB,CAAC;EAC1D,IAAIG,CAAC,GAAG1C,IAAI,CAAC2C,GAAG,CAACJ,MAAM,CAAC,CAACK,QAAQ,CAAC,EAAE,CAAC;EACrC,IAAIlB,UAAU,EAAEgB,CAAC,GAAGA,CAAC,CAACG,QAAQ,CAACnB,UAAU,GAAG,CAAC,EAAE,GAAG,CAAC;EACnD,IAAIa,MAAM,GAAG,CAAC,EAAEG,CAAC,GAAG,GAAG,GAAGA,CAAC;EAC3B,OAAOA,CAAC;AACV"}