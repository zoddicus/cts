{"version":3,"file":"fixture.js","names":["assert","unreachable","SkipTestCase","Error","UnexpectedPassError","TestCaseRecorder","SubcaseBatchState","constructor","recorder","params","init","postInit","finalize","Fixture","eventualExpectations","numOutstandingAsyncExpectations","objectsToCleanUp","MakeSharedState","sharedState","rec","_sharedState","_params","length","p","shift","ex","threw","o","WEBGL_lose_context","getExtension","loseContext","destroy","close","trackForCleanup","push","tryTrackForCleanup","WebGLRenderingContext","WebGL2RenderingContext","debug","msg","skip","skipIf","cond","warn","fail","expectationFailed","immediateAsyncExpectation","fn","ret","eventualAsyncExpectation","promise","expectErrorValue","expectedError","niceStack","message","actualName","name","shouldResolve","m","shouldReject","expectedName","shouldThrow","expect","expectOK","error","mode","handleError","stack","Array","isArray","e","eventualExpectOK"],"sources":["../../../src/common/framework/fixture.ts"],"sourcesContent":["import { TestCaseRecorder } from '../internal/logging/test_case_recorder.js';\nimport { JSONWithUndefined } from '../internal/params_utils.js';\nimport { assert, unreachable } from '../util/util.js';\n\nexport class SkipTestCase extends Error {}\nexport class UnexpectedPassError extends Error {}\n\nexport { TestCaseRecorder } from '../internal/logging/test_case_recorder.js';\n\n/** The fully-general type for params passed to a test function invocation. */\nexport type TestParams = {\n  readonly [k: string]: JSONWithUndefined;\n};\n\ntype DestroyableObject =\n  | { destroy(): void }\n  | { close(): void }\n  | { getExtension(extensionName: 'WEBGL_lose_context'): WEBGL_lose_context };\n\nexport class SubcaseBatchState {\n  constructor(\n    protected readonly recorder: TestCaseRecorder,\n    /** The case parameters for this test fixture shared state. Subcase params are not included. */\n    public readonly params: TestParams\n  ) {}\n\n  /**\n   * Runs before the `.before()` function.\n   * @internal MAINTENANCE_TODO: Make this not visible to test code?\n   */\n  async init() {}\n  /**\n   * Runs between the `.before()` function and the subcases.\n   * @internal MAINTENANCE_TODO: Make this not visible to test code?\n   */\n  async postInit() {}\n  /**\n   * Runs after all subcases finish.\n   * @internal MAINTENANCE_TODO: Make this not visible to test code?\n   */\n  async finalize() {}\n}\n\n/**\n * A Fixture is a class used to instantiate each test sub/case at run time.\n * A new instance of the Fixture is created for every single test subcase\n * (i.e. every time the test function is run).\n */\nexport class Fixture<S extends SubcaseBatchState = SubcaseBatchState> {\n  private _params: unknown;\n  private _sharedState: S;\n  /**\n   * Interface for recording logs and test status.\n   *\n   * @internal\n   */\n  readonly rec: TestCaseRecorder;\n  private eventualExpectations: Array<Promise<unknown>> = [];\n  private numOutstandingAsyncExpectations = 0;\n  private objectsToCleanUp: DestroyableObject[] = [];\n\n  public static MakeSharedState(recorder: TestCaseRecorder, params: TestParams): SubcaseBatchState {\n    return new SubcaseBatchState(recorder, params);\n  }\n\n  /** @internal */\n  constructor(sharedState: S, rec: TestCaseRecorder, params: TestParams) {\n    this._sharedState = sharedState;\n    this.rec = rec;\n    this._params = params;\n  }\n\n  /**\n   * Returns the (case+subcase) parameters for this test function invocation.\n   */\n  get params(): unknown {\n    return this._params;\n  }\n\n  /**\n   * Gets the test fixture's shared state. This object is shared between subcases\n   * within the same testcase.\n   */\n  get sharedState(): S {\n    return this._sharedState;\n  }\n\n  /**\n   * Override this to do additional pre-test-function work in a derived fixture.\n   * This has to be a member function instead of an async `createFixture` function, because\n   * we need to be able to ergonomically override it in subclasses.\n   *\n   * @internal MAINTENANCE_TODO: Make this not visible to test code?\n   */\n  async init(): Promise<void> {}\n\n  /**\n   * Override this to do additional post-test-function work in a derived fixture.\n   *\n   * Called even if init was unsuccessful.\n   *\n   * @internal MAINTENANCE_TODO: Make this not visible to test code?\n   */\n  async finalize(): Promise<void> {\n    assert(\n      this.numOutstandingAsyncExpectations === 0,\n      'there were outstanding immediateAsyncExpectations (e.g. expectUncapturedError) at the end of the test'\n    );\n\n    // Loop to exhaust the eventualExpectations in case they chain off each other.\n    while (this.eventualExpectations.length) {\n      const p = this.eventualExpectations.shift()!;\n      try {\n        await p;\n      } catch (ex) {\n        this.rec.threw(ex);\n      }\n    }\n\n    // And clean up any objects now that they're done being used.\n    for (const o of this.objectsToCleanUp) {\n      if ('getExtension' in o) {\n        const WEBGL_lose_context = o.getExtension('WEBGL_lose_context');\n        if (WEBGL_lose_context) WEBGL_lose_context.loseContext();\n      } else if ('destroy' in o) {\n        o.destroy();\n      } else {\n        o.close();\n      }\n    }\n  }\n\n  /**\n   * Tracks an object to be cleaned up after the test finishes.\n   *\n   * MAINTENANCE_TODO: Use this in more places. (Will be easier once .destroy() is allowed on\n   * invalid objects.)\n   */\n  trackForCleanup<T extends DestroyableObject>(o: T): T {\n    this.objectsToCleanUp.push(o);\n    return o;\n  }\n\n  /** Tracks an object, if it's destroyable, to be cleaned up after the test finishes. */\n  tryTrackForCleanup<T>(o: T): T {\n    if (typeof o === 'object' && o !== null) {\n      if (\n        'destroy' in o ||\n        'close' in o ||\n        o instanceof WebGLRenderingContext ||\n        o instanceof WebGL2RenderingContext\n      ) {\n        this.objectsToCleanUp.push((o as unknown) as DestroyableObject);\n      }\n    }\n    return o;\n  }\n\n  /** Log a debug message. */\n  debug(msg: string): void {\n    this.rec.debug(new Error(msg));\n  }\n\n  /** Throws an exception marking the subcase as skipped. */\n  skip(msg: string): never {\n    throw new SkipTestCase(msg);\n  }\n\n  /** Throws an exception marking the subcase as skipped if condition is true */\n  skipIf(cond: boolean, msg: string | (() => string) = '') {\n    if (cond) {\n      this.skip(typeof msg === 'function' ? msg() : msg);\n    }\n  }\n\n  /** Log a warning and increase the result status to \"Warn\". */\n  warn(msg?: string): void {\n    this.rec.warn(new Error(msg));\n  }\n\n  /** Log an error and increase the result status to \"ExpectFailed\". */\n  fail(msg?: string): void {\n    this.rec.expectationFailed(new Error(msg));\n  }\n\n  /**\n   * Wraps an async function. Tracks its status to fail if the test tries to report a test status\n   * before the async work has finished.\n   */\n  protected async immediateAsyncExpectation<T>(fn: () => Promise<T>): Promise<T> {\n    this.numOutstandingAsyncExpectations++;\n    const ret = await fn();\n    this.numOutstandingAsyncExpectations--;\n    return ret;\n  }\n\n  /**\n   * Wraps an async function, passing it an `Error` object recording the original stack trace.\n   * The async work will be implicitly waited upon before reporting a test status.\n   */\n  protected eventualAsyncExpectation<T>(fn: (niceStack: Error) => Promise<T>): void {\n    const promise = fn(new Error());\n    this.eventualExpectations.push(promise);\n  }\n\n  private expectErrorValue(expectedError: string | true, ex: unknown, niceStack: Error): void {\n    if (!(ex instanceof Error)) {\n      niceStack.message = `THREW non-error value, of type ${typeof ex}: ${ex}`;\n      this.rec.expectationFailed(niceStack);\n      return;\n    }\n    const actualName = ex.name;\n    if (expectedError !== true && actualName !== expectedError) {\n      niceStack.message = `THREW ${actualName}, instead of ${expectedError}: ${ex}`;\n      this.rec.expectationFailed(niceStack);\n    } else {\n      niceStack.message = `OK: threw ${actualName}: ${ex.message}`;\n      this.rec.debug(niceStack);\n    }\n  }\n\n  /** Expect that the provided promise resolves (fulfills). */\n  shouldResolve(p: Promise<unknown>, msg?: string): void {\n    this.eventualAsyncExpectation(async niceStack => {\n      const m = msg ? ': ' + msg : '';\n      try {\n        await p;\n        niceStack.message = 'resolved as expected' + m;\n      } catch (ex) {\n        niceStack.message = `REJECTED${m}`;\n        if (ex instanceof Error) {\n          niceStack.message += '\\n' + ex.message;\n        }\n        this.rec.expectationFailed(niceStack);\n      }\n    });\n  }\n\n  /** Expect that the provided promise rejects, with the provided exception name. */\n  shouldReject(expectedName: string, p: Promise<unknown>, msg?: string): void {\n    this.eventualAsyncExpectation(async niceStack => {\n      const m = msg ? ': ' + msg : '';\n      try {\n        await p;\n        niceStack.message = 'DID NOT REJECT' + m;\n        this.rec.expectationFailed(niceStack);\n      } catch (ex) {\n        niceStack.message = 'rejected as expected' + m;\n        this.expectErrorValue(expectedName, ex, niceStack);\n      }\n    });\n  }\n\n  /**\n   * Expect that the provided function throws (if `true` or `string`) or not (if `false`).\n   * If a string is provided, expect that the throw exception has that name.\n   *\n   * MAINTENANCE_TODO: Change to `string | false` so the exception name is always checked.\n   */\n  shouldThrow(expectedError: string | boolean, fn: () => void, msg?: string): void {\n    const m = msg ? ': ' + msg : '';\n    try {\n      fn();\n      if (expectedError === false) {\n        this.rec.debug(new Error('did not throw, as expected' + m));\n      } else {\n        this.rec.expectationFailed(new Error('unexpectedly did not throw' + m));\n      }\n    } catch (ex) {\n      if (expectedError === false) {\n        this.rec.expectationFailed(new Error('threw unexpectedly' + m));\n      } else {\n        this.expectErrorValue(expectedError, ex, new Error(m));\n      }\n    }\n  }\n\n  /** Expect that a condition is true. */\n  expect(cond: boolean, msg?: string): boolean {\n    if (cond) {\n      const m = msg ? ': ' + msg : '';\n      this.rec.debug(new Error('expect OK' + m));\n    } else {\n      this.rec.expectationFailed(new Error(msg));\n    }\n    return cond;\n  }\n\n  /**\n   * If the argument is an `Error`, fail (or warn). If it's `undefined`, no-op.\n   * If the argument is an array, apply the above behavior on each of elements.\n   */\n  expectOK(\n    error: Error | undefined | (Error | undefined)[],\n    { mode = 'fail', niceStack }: { mode?: 'fail' | 'warn'; niceStack?: Error } = {}\n  ): void {\n    const handleError = (error: Error | undefined) => {\n      if (error instanceof Error) {\n        if (niceStack) {\n          error.stack = niceStack.stack;\n        }\n        if (mode === 'fail') {\n          this.rec.expectationFailed(error);\n        } else if (mode === 'warn') {\n          this.rec.warn(error);\n        } else {\n          unreachable();\n        }\n      }\n    };\n\n    if (Array.isArray(error)) {\n      for (const e of error) {\n        handleError(e);\n      }\n    } else {\n      handleError(error);\n    }\n  }\n\n  eventualExpectOK(\n    error: Promise<Error | undefined | (Error | undefined)[]>,\n    { mode = 'fail' }: { mode?: 'fail' | 'warn' } = {}\n  ) {\n    this.eventualAsyncExpectation(async niceStack => {\n      this.expectOK(await error, { mode, niceStack });\n    });\n  }\n}\n\nexport type SubcaseBatchStateFromFixture<F> = F extends Fixture<infer S> ? S : never;\n\n/**\n * FixtureClass encapsulates a constructor for fixture and a corresponding\n * shared state factory function. An interface version of the type is also\n * defined for mixin declaration use ONLY. The interface version is necessary\n * because mixin classes need a constructor with a single any[] rest\n * parameter.\n */\nexport type FixtureClass<F extends Fixture = Fixture> = {\n  new (sharedState: SubcaseBatchStateFromFixture<F>, log: TestCaseRecorder, params: TestParams): F;\n  MakeSharedState(recorder: TestCaseRecorder, params: TestParams): SubcaseBatchStateFromFixture<F>;\n};\nexport type FixtureClassInterface<F extends Fixture = Fixture> = {\n  /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n  new (...args: any[]): F;\n  MakeSharedState(recorder: TestCaseRecorder, params: TestParams): SubcaseBatchStateFromFixture<F>;\n};\nexport type FixtureClassWithMixin<FC, M> = FC extends FixtureClass<infer F>\n  ? FixtureClass<F & M>\n  : never;\n"],"mappings":"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"}