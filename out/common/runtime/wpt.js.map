{"version":3,"file":"wpt.js","names":["globalTestConfig","DefaultTestFileLoader","prettyPrintLog","Logger","parseQuery","parseExpectationsForTestQuery","relativeQueryString","assert","optionEnabled","optionWorkerMode","TestDedicatedWorker","TestServiceWorker","TestSharedWorker","setup","explicit_done","workerString","dedicatedWorker","undefined","sharedWorker","serviceWorker","unrollConstEvalLoops","failOnWarnings","shouldWebGPUCTSFailOnWarnings","loader","qs","URLSearchParams","window","location","search","getAll","length","filterQuery","testcases","loadCases","expectations","loadWebGPUExpectations","URL","href","log","testcase","name","query","toString","shortName","wpt_fn","rec","res","record","run","status","logs","map","assert_unreached","join","promise_test","done"],"sources":["../../../src/common/runtime/wpt.ts"],"sourcesContent":["// Implements the wpt-embedded test runner (see also: wpt/cts.https.html).\n\nimport { globalTestConfig } from '../framework/test_config.js';\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { prettyPrintLog } from '../internal/logging/log_message.js';\nimport { Logger } from '../internal/logging/logger.js';\nimport { parseQuery } from '../internal/query/parseQuery.js';\nimport { parseExpectationsForTestQuery, relativeQueryString } from '../internal/query/query.js';\nimport { assert } from '../util/util.js';\n\nimport { optionEnabled, optionWorkerMode } from './helper/options.js';\nimport { TestDedicatedWorker, TestServiceWorker, TestSharedWorker } from './helper/test_worker.js';\n\n// testharness.js API (https://web-platform-tests.org/writing-tests/testharness-api.html)\ndeclare interface WptTestObject {\n  step(f: () => void): void;\n  done(): void;\n}\ndeclare function setup(properties: { explicit_done?: boolean }): void;\ndeclare function promise_test(f: (t: WptTestObject) => Promise<void>, name: string): void;\ndeclare function done(): void;\ndeclare function assert_unreached(description: string): void;\n\ndeclare const loadWebGPUExpectations: Promise<unknown> | undefined;\ndeclare const shouldWebGPUCTSFailOnWarnings: Promise<boolean> | undefined;\n\nsetup({\n  // It's convenient for us to asynchronously add tests to the page. Prevent done() from being\n  // called implicitly when the page is finished loading.\n  explicit_done: true,\n});\n\nvoid (async () => {\n  const workerString = optionWorkerMode('worker');\n  const dedicatedWorker = workerString === 'dedicated' ? new TestDedicatedWorker() : undefined;\n  const sharedWorker = workerString === 'shared' ? new TestSharedWorker() : undefined;\n  const serviceWorker = workerString === 'service' ? new TestServiceWorker() : undefined;\n\n  globalTestConfig.unrollConstEvalLoops = optionEnabled('unroll_const_eval_loops');\n\n  const failOnWarnings =\n    typeof shouldWebGPUCTSFailOnWarnings !== 'undefined' && (await shouldWebGPUCTSFailOnWarnings);\n\n  const loader = new DefaultTestFileLoader();\n  const qs = new URLSearchParams(window.location.search).getAll('q');\n  assert(qs.length === 1, 'currently, there must be exactly one ?q=');\n  const filterQuery = parseQuery(qs[0]);\n  const testcases = await loader.loadCases(filterQuery);\n\n  const expectations =\n    typeof loadWebGPUExpectations !== 'undefined'\n      ? parseExpectationsForTestQuery(\n          await loadWebGPUExpectations,\n          filterQuery,\n          new URL(window.location.href)\n        )\n      : [];\n\n  const log = new Logger();\n\n  for (const testcase of testcases) {\n    const name = testcase.query.toString();\n    // For brevity, display the case name \"relative\" to the ?q= path.\n    const shortName = relativeQueryString(filterQuery, testcase.query) || '(case)';\n\n    const wpt_fn = async () => {\n      const [rec, res] = log.record(name);\n      if (dedicatedWorker) {\n        await dedicatedWorker.run(rec, name, expectations);\n      } else if (sharedWorker) {\n        await sharedWorker.run(rec, name, expectations);\n      } else if (serviceWorker) {\n        await serviceWorker.run(rec, name, expectations);\n      } else {\n        await testcase.run(rec, expectations);\n      }\n\n      // Unfortunately, it seems not possible to surface any logs for warn/skip.\n      if (res.status === 'fail' || (res.status === 'warn' && failOnWarnings)) {\n        const logs = (res.logs ?? []).map(prettyPrintLog);\n        assert_unreached('\\n' + logs.join('\\n') + '\\n');\n      }\n    };\n\n    promise_test(wpt_fn, shortName);\n  }\n\n  done();\n})();\n"],"mappings":"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"}