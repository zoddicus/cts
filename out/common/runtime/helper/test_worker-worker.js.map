{"version":3,"file":"test_worker-worker.js","names":["setBaseResourcePath","DefaultTestFileLoader","parseQuery","assert","setupWorkerEnvironment","loader","reportTestResults","ev","query","expectations","ctsOptions","data","log","testcases","Array","from","loadCases","length","testcase","rec","result","record","toString","run","postMessage","logs","map","l","toRawData","self","onmessage","call","source","onconnect","event","port","ports"],"sources":["../../../../src/common/runtime/helper/test_worker-worker.ts"],"sourcesContent":["import { setBaseResourcePath } from '../../framework/resources.js';\nimport { DefaultTestFileLoader } from '../../internal/file_loader.js';\nimport { parseQuery } from '../../internal/query/parseQuery.js';\nimport { assert } from '../../util/util.js';\n\nimport { setupWorkerEnvironment, WorkerTestRunRequest } from './utils_worker.js';\n\n// Should be WorkerGlobalScope, but importing lib \"webworker\" conflicts with lib \"dom\".\n/* eslint-disable-next-line @typescript-eslint/no-explicit-any */\ndeclare const self: any;\n\nconst loader = new DefaultTestFileLoader();\n\nsetBaseResourcePath('../../../resources');\n\nasync function reportTestResults(this: MessagePort | Worker, ev: MessageEvent) {\n  const { query, expectations, ctsOptions } = ev.data as WorkerTestRunRequest;\n\n  const log = setupWorkerEnvironment(ctsOptions);\n\n  const testcases = Array.from(await loader.loadCases(parseQuery(query)));\n  assert(testcases.length === 1, 'worker query resulted in != 1 cases');\n\n  const testcase = testcases[0];\n  const [rec, result] = log.record(testcase.query.toString());\n  await testcase.run(rec, expectations);\n\n  this.postMessage({\n    query,\n    result: {\n      ...result,\n      logs: result.logs?.map(l => l.toRawData()),\n    },\n  });\n}\n\nself.onmessage = (ev: MessageEvent) => {\n  void reportTestResults.call(ev.source || self, ev);\n};\n\nself.onconnect = (event: MessageEvent) => {\n  const port = event.ports[0];\n\n  port.onmessage = (ev: MessageEvent) => {\n    void reportTestResults.call(port, ev);\n  };\n};\n"],"mappings":";;GAAA,SAASA,mBAAmB,QAAQ,8BAA8B,CAClE,SAASC,qBAAqB,QAAQ,+BAA+B,CACrE,SAASC,UAAU,QAAQ,oCAAoC;AAC/D,SAASC,MAAM,QAAQ,oBAAoB;;AAE3C,SAASC,sBAAsB,QAA8B,mBAAmB;;AAEhF;;;;AAIA,MAAMC,MAAM,GAAG,IAAIJ,qBAAqB,CAAC,CAAC;;AAE1CD,mBAAmB,CAAC,oBAAoB,CAAC;;AAEzC,eAAeM,iBAAiBA,CAA6BC,EAAgB,EAAE;EAC7E,MAAM,EAAEC,KAAK,EAAEC,YAAY,EAAEC,UAAU,CAAC,CAAC,GAAGH,EAAE,CAACI,IAA4B;;EAE3E,MAAMC,GAAG,GAAGR,sBAAsB,CAACM,UAAU,CAAC;;EAE9C,MAAMG,SAAS,GAAGC,KAAK,CAACC,IAAI,CAAC,MAAMV,MAAM,CAACW,SAAS,CAACd,UAAU,CAACM,KAAK,CAAC,CAAC,CAAC;EACvEL,MAAM,CAACU,SAAS,CAACI,MAAM,KAAK,CAAC,EAAE,qCAAqC,CAAC;;EAErE,MAAMC,QAAQ,GAAGL,SAAS,CAAC,CAAC,CAAC;EAC7B,MAAM,CAACM,GAAG,EAAEC,MAAM,CAAC,GAAGR,GAAG,CAACS,MAAM,CAACH,QAAQ,CAACV,KAAK,CAACc,QAAQ,CAAC,CAAC,CAAC;EAC3D,MAAMJ,QAAQ,CAACK,GAAG,CAACJ,GAAG,EAAEV,YAAY,CAAC;;EAErC,IAAI,CAACe,WAAW,CAAC;IACfhB,KAAK;IACLY,MAAM,EAAE;MACN,GAAGA,MAAM;MACTK,IAAI,EAAEL,MAAM,CAACK,IAAI,EAAEC,GAAG,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACC,SAAS,CAAC,CAAC;IAC3C;EACF,CAAC,CAAC;AACJ;;AAEAC,IAAI,CAACC,SAAS,GAAG,CAACvB,EAAgB,KAAK;EACrC,KAAKD,iBAAiB,CAACyB,IAAI,CAACxB,EAAE,CAACyB,MAAM,IAAIH,IAAI,EAAEtB,EAAE,CAAC;AACpD,CAAC;;AAEDsB,IAAI,CAACI,SAAS,GAAG,CAACC,KAAmB,KAAK;EACxC,MAAMC,IAAI,GAAGD,KAAK,CAACE,KAAK,CAAC,CAAC,CAAC;;EAE3BD,IAAI,CAACL,SAAS,GAAG,CAACvB,EAAgB,KAAK;IACrC,KAAKD,iBAAiB,CAACyB,IAAI,CAACI,IAAI,EAAE5B,EAAE,CAAC;EACvC,CAAC;AACH,CAAC"}