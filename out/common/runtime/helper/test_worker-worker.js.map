{"version":3,"file":"test_worker-worker.js","names":["setBaseResourcePath","globalTestConfig","DefaultTestFileLoader","Logger","parseQuery","setDefaultRequestAdapterOptions","assert","loader","reportTestResults","ev","query","data","expectations","ctsOptions","debug","unrollConstEvalLoops","powerPreference","compatibility","globalDebugMode","log","compatibilityMode","testcases","Array","from","loadCases","length","testcase","rec","result","record","toString","run","postMessage","self","onmessage","call","onconnect","event","port","ports"],"sources":["../../../../src/common/runtime/helper/test_worker-worker.ts"],"sourcesContent":["import { setBaseResourcePath } from '../../framework/resources.js';\nimport { globalTestConfig } from '../../framework/test_config.js';\nimport { DefaultTestFileLoader } from '../../internal/file_loader.js';\nimport { Logger } from '../../internal/logging/logger.js';\nimport { parseQuery } from '../../internal/query/parseQuery.js';\nimport { TestQueryWithExpectation } from '../../internal/query/query.js';\nimport { setDefaultRequestAdapterOptions } from '../../util/navigator_gpu.js';\nimport { assert } from '../../util/util.js';\n\nimport { CTSOptions } from './options.js';\n\n// Should be WorkerGlobalScope, but importing lib \"webworker\" conflicts with lib \"dom\".\n/* eslint-disable-next-line @typescript-eslint/no-explicit-any */\ndeclare const self: any;\n\nconst loader = new DefaultTestFileLoader();\n\nsetBaseResourcePath('../../../resources');\n\nasync function reportTestResults(this: MessagePort | Worker, ev: MessageEvent) {\n  const query: string = ev.data.query;\n  const expectations: TestQueryWithExpectation[] = ev.data.expectations;\n  const ctsOptions: CTSOptions = ev.data.ctsOptions;\n\n  const { debug, unrollConstEvalLoops, powerPreference, compatibility } = ctsOptions;\n  globalTestConfig.unrollConstEvalLoops = unrollConstEvalLoops;\n  globalTestConfig.compatibility = compatibility;\n\n  Logger.globalDebugMode = debug;\n  const log = new Logger();\n\n  if (powerPreference || compatibility) {\n    setDefaultRequestAdapterOptions({\n      ...(powerPreference && { powerPreference }),\n      // MAINTENANCE_TODO: Change this to whatever the option ends up being\n      ...(compatibility && { compatibilityMode: true }),\n    });\n  }\n\n  const testcases = Array.from(await loader.loadCases(parseQuery(query)));\n  assert(testcases.length === 1, 'worker query resulted in != 1 cases');\n\n  const testcase = testcases[0];\n  const [rec, result] = log.record(testcase.query.toString());\n  await testcase.run(rec, expectations);\n\n  this.postMessage({ query, result });\n}\n\nself.onmessage = (ev: MessageEvent) => {\n  void reportTestResults.call(self, ev);\n};\n\nself.onconnect = (event: MessageEvent) => {\n  const port = event.ports[0];\n\n  port.onmessage = (ev: MessageEvent) => {\n    void reportTestResults.call(port, ev);\n  };\n};\n"],"mappings":";;GAAA,SAASA,mBAAmB,QAAQ,8BAA8B,CAClE,SAASC,gBAAgB,QAAQ,gCAAgC,CACjE,SAASC,qBAAqB,QAAQ,+BAA+B;AACrE,SAASC,MAAM,QAAQ,kCAAkC;AACzD,SAASC,UAAU,QAAQ,oCAAoC;;AAE/D,SAASC,+BAA+B,QAAQ,6BAA6B;AAC7E,SAASC,MAAM,QAAQ,oBAAoB;;;;AAI3C;;;;AAIA,MAAMC,MAAM,GAAG,IAAIL,qBAAqB,CAAC,CAAC;;AAE1CF,mBAAmB,CAAC,oBAAoB,CAAC;;AAEzC,eAAeQ,iBAAiBA,CAA6BC,EAAgB,EAAE;EAC7E,MAAMC,KAAa,GAAGD,EAAE,CAACE,IAAI,CAACD,KAAK;EACnC,MAAME,YAAwC,GAAGH,EAAE,CAACE,IAAI,CAACC,YAAY;EACrE,MAAMC,UAAsB,GAAGJ,EAAE,CAACE,IAAI,CAACE,UAAU;;EAEjD,MAAM,EAAEC,KAAK,EAAEC,oBAAoB,EAAEC,eAAe,EAAEC,aAAa,CAAC,CAAC,GAAGJ,UAAU;EAClFZ,gBAAgB,CAACc,oBAAoB,GAAGA,oBAAoB;EAC5Dd,gBAAgB,CAACgB,aAAa,GAAGA,aAAa;;EAE9Cd,MAAM,CAACe,eAAe,GAAGJ,KAAK;EAC9B,MAAMK,GAAG,GAAG,IAAIhB,MAAM,CAAC,CAAC;;EAExB,IAAIa,eAAe,IAAIC,aAAa,EAAE;IACpCZ,+BAA+B,CAAC;MAC9B,IAAIW,eAAe,IAAI,EAAEA,eAAe,CAAC,CAAC,CAAC;MAC3C;MACA,IAAIC,aAAa,IAAI,EAAEG,iBAAiB,EAAE,IAAI,CAAC,CAAC;IAClD,CAAC,CAAC;EACJ;;EAEA,MAAMC,SAAS,GAAGC,KAAK,CAACC,IAAI,CAAC,MAAMhB,MAAM,CAACiB,SAAS,CAACpB,UAAU,CAACM,KAAK,CAAC,CAAC,CAAC;EACvEJ,MAAM,CAACe,SAAS,CAACI,MAAM,KAAK,CAAC,EAAE,qCAAqC,CAAC;;EAErE,MAAMC,QAAQ,GAAGL,SAAS,CAAC,CAAC,CAAC;EAC7B,MAAM,CAACM,GAAG,EAAEC,MAAM,CAAC,GAAGT,GAAG,CAACU,MAAM,CAACH,QAAQ,CAAChB,KAAK,CAACoB,QAAQ,CAAC,CAAC,CAAC;EAC3D,MAAMJ,QAAQ,CAACK,GAAG,CAACJ,GAAG,EAAEf,YAAY,CAAC;;EAErC,IAAI,CAACoB,WAAW,CAAC,EAAEtB,KAAK,EAAEkB,MAAM,CAAC,CAAC,CAAC;AACrC;;AAEAK,IAAI,CAACC,SAAS,GAAG,CAACzB,EAAgB,KAAK;EACrC,KAAKD,iBAAiB,CAAC2B,IAAI,CAACF,IAAI,EAAExB,EAAE,CAAC;AACvC,CAAC;;AAEDwB,IAAI,CAACG,SAAS,GAAG,CAACC,KAAmB,KAAK;EACxC,MAAMC,IAAI,GAAGD,KAAK,CAACE,KAAK,CAAC,CAAC,CAAC;;EAE3BD,IAAI,CAACJ,SAAS,GAAG,CAACzB,EAAgB,KAAK;IACrC,KAAKD,iBAAiB,CAAC2B,IAAI,CAACG,IAAI,EAAE7B,EAAE,CAAC;EACvC,CAAC;AACH,CAAC"}