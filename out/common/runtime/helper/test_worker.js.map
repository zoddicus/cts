{"version":3,"file":"test_worker.js","names":["LogMessageWithStack","kDefaultCTSOptions","TestDedicatedWorker","resolvers","Map","constructor","ctsOptions","worker","selfPath","import","meta","url","selfPathDir","substring","lastIndexOf","workerPath","Worker","type","onmessage","ev","query","data","result","logs","l","Object","setPrototypeOf","prototype","get","run","rec","expectations","postMessage","workerResult","Promise","resolve","set","injectResult","TestWorker","TestSharedWorker","SharedWorker","port","start"],"sources":["../../../../src/common/runtime/helper/test_worker.ts"],"sourcesContent":["import { LogMessageWithStack } from '../../internal/logging/log_message.js';\nimport { TransferredTestCaseResult, LiveTestCaseResult } from '../../internal/logging/result.js';\nimport { TestCaseRecorder } from '../../internal/logging/test_case_recorder.js';\nimport { TestQueryWithExpectation } from '../../internal/query/query.js';\n\nimport { CTSOptions, kDefaultCTSOptions } from './options.js';\n\nexport class TestDedicatedWorker {\n  private readonly ctsOptions: CTSOptions;\n  private readonly worker: Worker;\n  private readonly resolvers = new Map<string, (result: LiveTestCaseResult) => void>();\n\n  constructor(ctsOptions?: CTSOptions) {\n    this.ctsOptions = { ...(ctsOptions || kDefaultCTSOptions), ...{ worker: 'dedicated' } };\n    const selfPath = import.meta.url;\n    const selfPathDir = selfPath.substring(0, selfPath.lastIndexOf('/'));\n    const workerPath = selfPathDir + '/test_worker-worker.js';\n    this.worker = new Worker(workerPath, { type: 'module' });\n    this.worker.onmessage = ev => {\n      const query: string = ev.data.query;\n      const result: TransferredTestCaseResult = ev.data.result;\n      if (result.logs) {\n        for (const l of result.logs) {\n          Object.setPrototypeOf(l, LogMessageWithStack.prototype);\n        }\n      }\n      this.resolvers.get(query)!(result as LiveTestCaseResult);\n\n      // MAINTENANCE_TODO(kainino0x): update the Logger with this result (or don't have a logger and\n      // update the entire results JSON somehow at some point).\n    };\n  }\n\n  async run(\n    rec: TestCaseRecorder,\n    query: string,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<void> {\n    this.worker.postMessage({\n      query,\n      expectations,\n      ctsOptions: this.ctsOptions,\n    });\n    const workerResult = await new Promise<LiveTestCaseResult>(resolve => {\n      this.resolvers.set(query, resolve);\n    });\n    rec.injectResult(workerResult);\n  }\n}\n\nexport class TestWorker extends TestDedicatedWorker {}\n\nexport class TestSharedWorker {\n  private readonly ctsOptions: CTSOptions;\n  private readonly port: MessagePort;\n  private readonly resolvers = new Map<string, (result: LiveTestCaseResult) => void>();\n\n  constructor(ctsOptions?: CTSOptions) {\n    this.ctsOptions = { ...(ctsOptions || kDefaultCTSOptions), ...{ worker: 'shared' } };\n    const selfPath = import.meta.url;\n    const selfPathDir = selfPath.substring(0, selfPath.lastIndexOf('/'));\n    const workerPath = selfPathDir + '/test_worker-worker.js';\n    const worker = new SharedWorker(workerPath, { type: 'module' });\n    this.port = worker.port;\n    this.port.start();\n    this.port.onmessage = ev => {\n      const query: string = ev.data.query;\n      const result: TransferredTestCaseResult = ev.data.result;\n      if (result.logs) {\n        for (const l of result.logs) {\n          Object.setPrototypeOf(l, LogMessageWithStack.prototype);\n        }\n      }\n      this.resolvers.get(query)!(result as LiveTestCaseResult);\n\n      // MAINTENANCE_TODO(kainino0x): update the Logger with this result (or don't have a logger and\n      // update the entire results JSON somehow at some point).\n    };\n  }\n\n  async run(\n    rec: TestCaseRecorder,\n    query: string,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<void> {\n    this.port.postMessage({\n      query,\n      expectations,\n      ctsOptions: this.ctsOptions,\n    });\n    const workerResult = await new Promise<LiveTestCaseResult>(resolve => {\n      this.resolvers.set(query, resolve);\n    });\n    rec.injectResult(workerResult);\n  }\n}\n"],"mappings":"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"}