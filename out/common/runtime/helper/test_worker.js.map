{"version":3,"file":"test_worker.js","names":["LogMessageWithStack","timeout","assert","kDefaultCTSOptions","unregisterAllServiceWorkers","navigator","serviceWorker","getRegistrations","then","registrations","registration","unregister","window","addEventListener","TestBaseWorker","resolvers","Map","constructor","worker","ctsOptions","onmessage","ev","query","data","transferredResult","result","status","timems","logs","map","l","get","delete","makeRequestAndRecordResult","target","rec","expectations","request","postMessage","workerResult","Promise","resolve","has","set","injectResult","TestDedicatedWorker","selfPath","import","meta","url","selfPathDir","substring","lastIndexOf","workerPath","Worker","type","run","TestWorker","TestSharedWorker","SharedWorker","port","start","TestServiceWorker","suite","name","split","fileName","join","serviceWorkerURL","URL","location","href","toString","register","active","scriptURL"],"sources":["../../../../src/common/runtime/helper/test_worker.ts"],"sourcesContent":["import { LogMessageWithStack } from '../../internal/logging/log_message.js';\nimport { TransferredTestCaseResult, LiveTestCaseResult } from '../../internal/logging/result.js';\nimport { TestCaseRecorder } from '../../internal/logging/test_case_recorder.js';\nimport { TestQueryWithExpectation } from '../../internal/query/query.js';\nimport { timeout } from '../../util/timeout.js';\nimport { assert } from '../../util/util.js';\n\nimport { CTSOptions, WorkerMode, kDefaultCTSOptions } from './options.js';\nimport { WorkerTestRunRequest } from './utils_worker.js';\n\n/** Query all currently-registered service workers, and unregister them. */\nfunction unregisterAllServiceWorkers() {\n  void navigator.serviceWorker.getRegistrations().then(registrations => {\n    for (const registration of registrations) {\n      void registration.unregister();\n    }\n  });\n}\n\n// NOTE: This code runs on startup for any runtime with worker support. Here, we use that chance to\n// delete any leaked service workers, and register to clean up after ourselves at shutdown.\nunregisterAllServiceWorkers();\nwindow.addEventListener('beforeunload', () => {\n  unregisterAllServiceWorkers();\n});\n\nclass TestBaseWorker {\n  protected readonly ctsOptions: CTSOptions;\n  protected readonly resolvers = new Map<string, (result: LiveTestCaseResult) => void>();\n\n  constructor(worker: WorkerMode, ctsOptions?: CTSOptions) {\n    this.ctsOptions = { ...(ctsOptions || kDefaultCTSOptions), ...{ worker } };\n  }\n\n  onmessage(ev: MessageEvent) {\n    const query: string = ev.data.query;\n    const transferredResult: TransferredTestCaseResult = ev.data.result;\n\n    const result: LiveTestCaseResult = {\n      status: transferredResult.status,\n      timems: transferredResult.timems,\n      logs: transferredResult.logs?.map(l => new LogMessageWithStack(l)),\n    };\n\n    this.resolvers.get(query)!(result);\n    this.resolvers.delete(query);\n\n    // MAINTENANCE_TODO(kainino0x): update the Logger with this result (or don't have a logger and\n    // update the entire results JSON somehow at some point).\n  }\n\n  async makeRequestAndRecordResult(\n    target: MessagePort | Worker | ServiceWorker,\n    rec: TestCaseRecorder,\n    query: string,\n    expectations: TestQueryWithExpectation[]\n  ) {\n    const request: WorkerTestRunRequest = {\n      query,\n      expectations,\n      ctsOptions: this.ctsOptions,\n    };\n    target.postMessage(request);\n\n    const workerResult = await new Promise<LiveTestCaseResult>(resolve => {\n      assert(!this.resolvers.has(query), \"can't request same query twice simultaneously\");\n      this.resolvers.set(query, resolve);\n    });\n    rec.injectResult(workerResult);\n  }\n}\n\nexport class TestDedicatedWorker extends TestBaseWorker {\n  private readonly worker: Worker;\n\n  constructor(ctsOptions?: CTSOptions) {\n    super('dedicated', ctsOptions);\n    const selfPath = import.meta.url;\n    const selfPathDir = selfPath.substring(0, selfPath.lastIndexOf('/'));\n    const workerPath = selfPathDir + '/test_worker-worker.js';\n    this.worker = new Worker(workerPath, { type: 'module' });\n    this.worker.onmessage = ev => this.onmessage(ev);\n  }\n\n  async run(\n    rec: TestCaseRecorder,\n    query: string,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<void> {\n    await this.makeRequestAndRecordResult(this.worker, rec, query, expectations);\n  }\n}\n\nexport class TestWorker extends TestDedicatedWorker {}\n\nexport class TestSharedWorker extends TestBaseWorker {\n  private readonly port: MessagePort;\n\n  constructor(ctsOptions?: CTSOptions) {\n    super('shared', ctsOptions);\n    const selfPath = import.meta.url;\n    const selfPathDir = selfPath.substring(0, selfPath.lastIndexOf('/'));\n    const workerPath = selfPathDir + '/test_worker-worker.js';\n    const worker = new SharedWorker(workerPath, { type: 'module' });\n    this.port = worker.port;\n    this.port.start();\n    this.port.onmessage = ev => this.onmessage(ev);\n  }\n\n  async run(\n    rec: TestCaseRecorder,\n    query: string,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<void> {\n    await this.makeRequestAndRecordResult(this.port, rec, query, expectations);\n  }\n}\n\nexport class TestServiceWorker extends TestBaseWorker {\n  constructor(ctsOptions?: CTSOptions) {\n    super('service', ctsOptions);\n  }\n\n  async run(\n    rec: TestCaseRecorder,\n    query: string,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<void> {\n    const [suite, name] = query.split(':', 2);\n    const fileName = name.split(',').join('/');\n    const serviceWorkerURL = new URL(\n      `/out/${suite}/webworker/${fileName}.worker.js`,\n      window.location.href\n    ).toString();\n\n    // If a registration already exists for this path, it will be ignored.\n    const registration = await navigator.serviceWorker.register(serviceWorkerURL, {\n      type: 'module',\n    });\n    // Make sure the registration we just requested is active. (We don't worry about it being\n    // outdated from a previous page load, because we wipe all service workers on shutdown/startup.)\n    while (!registration.active || registration.active.scriptURL !== serviceWorkerURL) {\n      await new Promise(resolve => timeout(resolve, 0));\n    }\n    const serviceWorker = registration.active;\n\n    navigator.serviceWorker.onmessage = ev => this.onmessage(ev);\n    await this.makeRequestAndRecordResult(serviceWorker, rec, query, expectations);\n  }\n}\n"],"mappings":"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"}